<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>God View City v2.0 - æ·±åº¦æ¨¡æ‹Ÿç‰ˆ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1e272e;
            color: #d2dae2;
            display: flex;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            user-select: none;
        }
        
        /* å¸ƒå±€å®¹å™¨ */
        #game-layout {
            display: flex;
            width: 100%;
            height: 100%;
        }

        /* å·¦ä¾§ï¼šç”»å¸ƒåŒº */
        #canvas-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
            position: relative;
        }
        canvas {
            background-color: #2f3640;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            cursor: crosshair;
        }

        /* å³ä¾§ï¼šæ§åˆ¶é¢æ¿ */
        #sidebar {
            width: 300px;
            background: #2f3640;
            padding: 20px;
            border-left: 2px solid #485460;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        /* æ ‡é¢˜ä¸çŠ¶æ€ */
        h1 { margin: 0 0 10px 0; font-size: 22px; color: #ffa801; text-transform: uppercase; letter-spacing: 2px; }
        .stat-panel {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px; }
        .stat-val { font-weight: bold; font-family: monospace; color: #00d2d3; }

        /* å»ºç­‘æŒ‰é’®ç½‘æ ¼ */
        .build-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        button {
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            text-align: center;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        button:hover { transform: translateY(-2px); filter: brightness(1.2); }
        button.active { ring: 3px solid white; box-shadow: 0 0 10px rgba(255,255,255,0.5); }
        
        /* é¢œè‰²å®šä¹‰ */
        .btn-house { background: #26de81; color: #1e272e; }
        .btn-shop { background: #4bcffa; color: #1e272e; }
        .btn-farm { background: #fed330; color: #1e272e; }
        .btn-hospital { background: #ff7675; color: white; }
        .btn-police { background: #5758BB; color: white; }
        .btn-fire { background: #eb3b5a; color: white; }
        .btn-delete { background: #535c68; grid-column: span 2; }

        .tooltip { font-size: 10px; display: block; opacity: 0.8; margin-top: 2px; font-weight: normal; }

        /* ä¿¡æ¯é¢æ¿ (ä¸Šå¸è§†è§’) */
        #inspector {
            background: #1e272e;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #485460;
            font-size: 13px;
            min-height: 100px;
        }
        .trait-tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            margin-right: 5px;
            margin-bottom: 5px;
            color: #1e272e;
            font-weight: bold;
        }

        #notifications {
            margin-top: auto;
            color: #ff6b6b;
            font-size: 12px;
            height: 20px;
            text-align: center;
        }
    </style>
</head>
<body>

<div id="game-layout">
    <div id="canvas-area">
        <canvas id="cityCanvas" width="800" height="700"></canvas>
    </div>
    
    <div id="sidebar">
        <h1>SimCity God View</h1>
        
        <div class="stat-panel">
            <div class="stat-row"><span>èµ„é‡‘ (Tax)</span> <span class="stat-val" id="ui-money">$0</span></div>
            <div class="stat-row"><span>äººå£ (Pop)</span> <span class="stat-val" id="ui-pop">0</span></div>
            <div class="stat-row"><span>é£Ÿç‰© (Food)</span> <span class="stat-val" id="ui-food">0</span></div>
            <div class="stat-row"><span>å¹¸ç¦åº¦ (Happy)</span> <span class="stat-val" id="ui-happy">100%</span></div>
        </div>

        <div style="font-size:12px; margin-bottom:5px; color:#aaa;">åŸå¸‚è§„åˆ’å·¥å…·</div>
        <div class="build-grid">
            <button class="btn-house active" onclick="setTool('house')">ğŸ  ä½å®… <span class="tooltip">$50 | +5äºº</span></button>
            <button class="btn-shop" onclick="setTool('shop')">ğŸ¢ å•†åœº <span class="tooltip">$100 | æ¶ˆè´¹</span></button>
            <button class="btn-farm" onclick="setTool('farm')">ğŸŒ¾ å†œåœº <span class="tooltip">$80 | é£Ÿç‰©</span></button>
            <button class="btn-hospital" onclick="setTool('hospital')">ğŸ¥ åŒ»é™¢ <span class="tooltip">$300 | æ²»ç—…</span></button>
            <button class="btn-police" onclick="setTool('police')">ğŸš“ è­¦å±€ <span class="tooltip">$250 | æ²»å®‰</span></button>
            <button class="btn-fire" onclick="setTool('fire')">ğŸš’ æ¶ˆé˜² <span class="tooltip">$200 | é˜²ç«</span></button>
            <button class="btn-delete" onclick="setTool('delete')">ğŸ”¨ æ‹†é™¤å»ºç­‘ <span class="tooltip">è¿”è¿˜ 50% èµ„é‡‘</span></button>
        </div>

        <div style="font-size:12px; margin-bottom:5px; color:#aaa;">è§‚å¯Ÿè€…é¢æ¿ (é¼ æ ‡æ‚¬åœæŸ¥çœ‹)</div>
        <div id="inspector">
            æŠŠé¼ æ ‡æ”¾åœ¨å°äººæˆ–å»ºç­‘ä¸Š...
        </div>

        <div id="notifications"></div>
    </div>
</div>

<script>
/**
 * God View City v2.0 - Core Logic
 */

// --- é…ç½® ---
const TILE_SIZE = 35; // ç¨å¾®å¤§ä¸€ç‚¹ï¼Œçœ‹å¾—æ¸…æ¥š
const GRID_W = 22;
const GRID_H = 20;

const COLORS = {
    empty: '#2f3640',
    house: '#26de81',
    shop: '#4bcffa',
    farm: '#fed330',
    hospital: '#ff7675',
    police: '#5758BB',
    fire_station: '#eb3b5a',
    road: '#7f8c8d',
    fire_overlay: 'rgba(235, 59, 90, 0.5)'
};

const BUILDINGS = {
    house: { cost: 50, cap: 5, color: COLORS.house, name: "ä½å®…åŒº" },
    shop: { cost: 100, income: 0, color: COLORS.shop, name: "è´­ç‰©ä¸­å¿ƒ" }, // æ”¶å…¥æ¥è‡ªå°äººæ¶ˆè´¹
    farm: { cost: 80, foodProd: 0.8, color: COLORS.farm, name: "æœ‰æœºå†œåœº" },
    hospital: { cost: 300, radius: 5, color: COLORS.hospital, name: "ç»¼åˆåŒ»é™¢" },
    police: { cost: 250, radius: 6, color: COLORS.police, name: "è­¦å¯Ÿå±€" },
    fire_station: { cost: 200, radius: 6, color: COLORS.fire_station, name: "æ¶ˆé˜²ç«™" }
};

// --- æ¸¸æˆçŠ¶æ€ ---
let game = {
    money: 1500,
    food: 200,
    population: 0,
    grid: [],
    agents: [],
    buildings: [],
    tick: 0,
    avgHappiness: 100
};

let currentTool = 'house';
let hoveredEntity = null; // å½“å‰é¼ æ ‡æŒ‡å‘çš„å¯¹è±¡

const canvas = document.getElementById('cityCanvas');
const ctx = canvas.getContext('2d');

// --- åˆå§‹åŒ– ---
function init() {
    game.grid = [];
    for (let y = 0; y < GRID_H; y++) {
        let row = [];
        for (let x = 0; x < GRID_W; x++) {
            row.push({ type: 'empty', id: null });
        }
        game.grid.push(row);
    }
    
    // å¯åŠ¨å¾ªç¯
    requestAnimationFrame(gameLoop);
    setInterval(simulationTick, 100); // é€»è¾‘æ›´æ–°é¢‘ç‡
}

// --- ç±»å®šä¹‰ ---

class Agent {
    constructor(homeX, homeY) {
        this.x = homeX * TILE_SIZE + TILE_SIZE/2;
        this.y = homeY * TILE_SIZE + TILE_SIZE/2;
        this.homeX = homeX;
        this.homeY = homeY;
        
        // ç§»åŠ¨ç›¸å…³
        this.targetX = this.x;
        this.targetY = this.y;
        this.speed = 0.6; // å‡æ…¢é€Ÿåº¦ï¼Œæ›´åŠ æ‚ é—²
        this.state = 'idle'; // idle, working, shopping, healing, going_home
        
        // ä¸ªäººå±æ€§ (0.0 - 1.0)
        this.traits = {
            workEthic: Math.random(), // å‹¤åŠ³åº¦: é«˜=å–œæ¬¢å­˜é’±ï¼Œä½=æ²¡é’±æ‰å·¥ä½œ
            consumerism: Math.random(), // æ¶ˆè´¹æ¬²: é«˜=ç»å¸¸ä¹°ä¸œè¥¿
            resilience: 0.5 + Math.random() * 0.5 // æŠµæŠ—åŠ›
        };

        // ä¸ªäººçŠ¶æ€
        this.stats = {
            money: 50, // åˆå§‹èµ„é‡‘
            health: 100,
            happiness: 100,
            hunger: 0
        };
        
        this.age = 0;
        this.color = '#fff';
    }

    // æ™ºèƒ½å†³ç­–æ ¸å¿ƒ
    think() {
        // çŠ¶æ€è¡°å‡
        this.stats.hunger += 0.05;
        this.stats.happiness -= 0.02;
        
        // å¦‚æœåœ¨ç§»åŠ¨ä¸­ï¼Œç»§ç»­ç§»åŠ¨ï¼Œä¸åšå†³ç­–
        if (this.distToTarget() > 2) return;

        // 1. ä¼˜å…ˆï¼šç”Ÿç—…äº†æ‰¾åŒ»é™¢
        if (this.stats.health < 60) {
            if (this.state !== 'healing') {
                let hosp = findNearest(this.x, this.y, 'hospital');
                if (hosp) {
                    this.state = 'healing';
                    this.setTargetGrid(hosp.x, hosp.y);
                    return;
                }
            }
        }

        // 2. åƒé¥­ (æ¶ˆè€—åŸå¸‚åº“å­˜)
        if (this.stats.hunger > 80) {
            if (game.food > 0) {
                game.food--;
                this.stats.hunger = 0;
            } else {
                this.stats.health -= 5; // é¥¿æ‰è¡€
            }
        }

        // 3. æ²¡é’±äº†ï¼Ÿæˆ–è€…å‹¤åŠ³çš„äººæƒ³å­˜é’±
        // å‹¤åŠ³é˜ˆå€¼: æ‡’äºº(0.2)åªæœ‰é’±<20æ‰å·¥ä½œï¼Œå‹¤åŠ³äºº(0.9)é’±<90å°±å»å·¥ä½œ
        let povertyLine = this.traits.workEthic * 100;
        if (this.stats.money < povertyLine && this.state !== 'working') {
            let job = findNearest(this.x, this.y, ['shop', 'farm', 'police', 'hospital']); // éƒ½å¯ä»¥æ‰“å·¥
            if (job) {
                this.state = 'working';
                this.setTargetGrid(job.x, job.y);
                return;
            }
        }

        // 4. ä¸å¼€å¿ƒï¼Ÿå»æ¶ˆè´¹
        if (this.stats.happiness < 70 && this.stats.money > 10 && this.state !== 'shopping') {
            if (Math.random() < this.traits.consumerism) {
                let shop = findNearest(this.x, this.y, 'shop');
                if (shop) {
                    this.state = 'shopping';
                    this.setTargetGrid(shop.x, shop.y);
                    return;
                }
            }
        }

        // 5. æ²¡äº‹å¹²ï¼Œå›å®¶ä¼‘æ¯
        if (this.state !== 'idle') {
            this.state = 'idle';
            this.setTargetGrid(this.homeX, this.homeY);
        } else {
            // åœ¨å®¶æ…¢æ…¢å›è¡€å›å¿ƒæƒ…
            this.stats.health = Math.min(100, this.stats.health + 0.1);
            this.stats.happiness = Math.min(100, this.stats.happiness + 0.1);
        }
    }

    action() {
        // åˆ°è¾¾ç›®çš„åœ°åçš„è¡Œä¸º
        if (this.distToTarget() <= 2) {
            if (this.state === 'working') {
                this.stats.money += 0.5;
                this.stats.happiness -= 0.1;
                // å·¥ä½œäº§ç”Ÿç¨æ”¶
                if (Math.random() > 0.9) game.money += 1; 
                // å·¥ä½œä¸€ä¼šåå›å®¶
                if (this.stats.money > this.traits.workEthic * 120) this.state = 'idle';
            }
            else if (this.state === 'shopping') {
                this.stats.money -= 0.8;
                this.stats.happiness += 2;
                game.money += 0.2; // æ¶ˆè´¹ç¨
                if (this.stats.happiness > 95 || this.stats.money < 5) this.state = 'idle';
            }
            else if (this.state === 'healing') {
                this.stats.health += 2;
                this.stats.money -= 1; // åŒ»ç–—è´¹
                if (this.stats.health >= 100) this.state = 'idle';
            }
        }
    }

    update() {
        this.think();
        this.move();
        this.action();
        this.updateAppearance();
    }

    move() {
        let dx = this.targetX - this.x;
        let dy = this.targetY - this.y;
        let dist = Math.sqrt(dx*dx + dy*dy);
        if (dist > this.speed) {
            this.x += (dx/dist) * this.speed;
            this.y += (dy/dist) * this.speed;
        }
    }

    setTargetGrid(gx, gy) {
        // éšæœºä¸€ç‚¹åç§»ï¼Œé¿å…æ‰€æœ‰äººé‡å 
        this.targetX = gx * TILE_SIZE + TILE_SIZE/2 + (Math.random()-0.5)*10;
        this.targetY = gy * TILE_SIZE + TILE_SIZE/2 + (Math.random()-0.5)*10;
    }

    distToTarget() {
        return Math.sqrt((this.x-this.targetX)**2 + (this.y-this.targetY)**2);
    }

    updateAppearance() {
        // æ ¹æ®çŠ¶æ€å˜è‰²ï¼Œæ–¹ä¾¿ä¸Šå¸è§‚å¯Ÿ
        if (this.stats.health < 50) this.color = '#e74c3c'; // ç”Ÿç—…çº¢
        else if (this.state === 'working') this.color = '#f1c40f'; // å·¥ä½œé»„
        else if (this.state === 'shopping') this.color = '#3498db'; // è´­ç‰©è“
        else this.color = '#ecf0f1'; // é—²ç½®ç™½
    }

    draw(ctx) {
        ctx.fillStyle = this.color;
        ctx.beginPath();
        // å¦‚æœç”Ÿç—…äº†ç”»ä¸ªåå­—
        if (this.stats.health < 50) {
            ctx.fillRect(this.x-3, this.y-1, 6, 2);
            ctx.fillRect(this.x-1, this.y-3, 2, 6);
        } else {
            ctx.arc(this.x, this.y, 3, 0, Math.PI*2);
            ctx.fill();
        }
    }
}

// --- é€»è¾‘ç³»ç»Ÿ ---

function simulationTick() {
    game.tick++;

    // 1. å»ºç­‘åŠŸèƒ½ä¸ç¾éš¾
    game.buildings.forEach(b => {
        // å†œåœºäº§å‡º
        if (b.type === 'farm' && game.tick % 50 === 0) {
            game.food += BUILDINGS.farm.foodProd * 50; // ç§¯ç´¯
        }
        
        // ç«ç¾é€»è¾‘ (å¦‚æœæ²¡æœ‰æ¶ˆé˜²å±€è¦†ç›–ï¼Œæœ‰å°æ¦‚ç‡èµ·ç«)
        if (!b.onFire && Math.random() < 0.0005) {
            let protected = findNearest(b.x, b.y, 'fire_station', 6); // èŒƒå›´6
            if (!protected) {
                b.onFire = true;
                notify(`ğŸ”¥ ç«ç¾å‘ç”Ÿäº†ï¼åœ¨ ${b.x},${b.y}`);
            }
        }

        // ç«ç¾ä¼¤å®³
        if (b.onFire) {
            b.health = (b.health || 100) - 1;
            if (b.health <= 0) {
                // çƒ§æ¯
                destroyBuilding(b);
                notify("ğŸ¢ ä¸€æ ‹å»ºç­‘è¢«çƒ§æ¯äº†ï¼");
            }
        }
    });

    // 2. å°äººæ›´æ–°
    let totalHappy = 0;
    game.agents.forEach(a => {
        a.update();
        totalHappy += a.stats.happiness;
    });
    if (game.agents.length > 0) game.avgHappiness = Math.floor(totalHappy / game.agents.length);

    updateUI();
}

function findNearest(gx, gy, types, maxDistGrid = 999) {
    if (!Array.isArray(types)) types = [types];
    let nearest = null;
    let minD = Infinity;

    // ä¼˜åŒ–ï¼šåªéå†å»ºç­‘
    for (let b of game.buildings) {
        if (types.includes(b.type) && !b.onFire) {
            let dist = Math.sqrt((b.x-gx)**2 + (b.y-gy)**2);
            if (dist < minD && dist <= maxDistGrid) {
                minD = dist;
                nearest = b;
            }
        }
    }
    return nearest;
}

function destroyBuilding(b) {
    game.grid[b.y][b.x] = { type: 'empty' };
    game.buildings = game.buildings.filter(build => build !== b);
    // å¦‚æœæ˜¯å®¶ï¼Œå¯èƒ½ä¼šè®©å°äººæ— å®¶å¯å½’(è¿™é‡Œæš‚ç®€åŒ–ä¸ºä¸å¤„ç†å°äººï¼Œå°äººä¼šä¸€ç›´é—²é€›)
}

// --- äº¤äº’ä¸æ¸²æŸ“ ---

function setTool(t) {
    currentTool = t;
    document.querySelectorAll('.build-grid button').forEach(b => b.classList.remove('active'));
    document.querySelector(`.btn-${t}`).classList.add('active');
}

canvas.addEventListener('mousemove', e => {
    const rect = canvas.getBoundingClientRect();
    const x = Math.floor((e.clientX - rect.left) / TILE_SIZE);
    const y = Math.floor((e.clientY - rect.top) / TILE_SIZE);
    
    // å¯»æ‰¾é¼ æ ‡ä¸‹çš„å°äººæˆ–å»ºç­‘
    let found = null;
    // ä¼˜å…ˆæ‰¾å°äºº
    for(let a of game.agents) {
        let ax = Math.floor(a.x / TILE_SIZE);
        let ay = Math.floor(a.y / TILE_SIZE);
        if (ax === x && ay === y) {
            found = { type: 'agent', data: a };
            break;
        }
    }
    if (!found && x >=0 && x<GRID_W && y>=0 && y<GRID_H) {
        let cell = game.grid[y][x];
        if (cell.type !== 'empty') {
            let b = game.buildings.find(b => b.x === x && b.y === y);
            found = { type: 'building', data: b };
        }
    }
    
    updateInspector(found);
});

canvas.addEventListener('mousedown', e => {
    const rect = canvas.getBoundingClientRect();
    const x = Math.floor((e.clientX - rect.left) / TILE_SIZE);
    const y = Math.floor((e.clientY - rect.top) / TILE_SIZE);
    
    if (x<0 || x>=GRID_W || y<0 || y>=GRID_H) return;

    // æ‹†é™¤
    if (currentTool === 'delete') {
        let b = game.buildings.find(b => b.x === x && b.y === y);
        if (b) {
            game.money += BUILDINGS[b.type].cost * 0.5;
            destroyBuilding(b);
        }
        return;
    }

    // å»ºé€ 
    let cell = game.grid[y][x];
    if (cell.type !== 'empty') {
        notify("âŒ è¿™é‡Œå·²ç»æœ‰ä¸œè¥¿äº†");
        return;
    }

    let info = BUILDINGS[currentTool];
    if (game.money >= info.cost) {
