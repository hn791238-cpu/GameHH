<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>God View City: Evolution v2.1</title>
    <style>
        :root { --panel-bg: #1e272e; --sidebar-bg: #2f3640; --accent: #ffa801; }
        body { font-family: 'Segoe UI', sans-serif; background: #000; color: #d2dae2; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        #game-layout { display: flex; width: 100%; height: 100%; }
        #canvas-area { flex: 1; display: flex; justify-content: center; align-items: center; background: radial-gradient(circle, #222 0%, #000 100%); position: relative; }
        canvas { background: #1a1a1a; border: 2px solid #444; box-shadow: 0 0 50px rgba(0,0,0,0.8); cursor: crosshair; }

        /* å³ä¾§é¢æ¿ */
        #sidebar { width: 320px; background: var(--sidebar-bg); padding: 20px; border-left: 2px solid #485460; display: flex; flex-direction: column; box-shadow: -5px 0 15px rgba(0,0,0,0.5); }
        h1 { margin: 0 0 15px 0; font-size: 20px; color: var(--accent); text-align: center; border-bottom: 1px solid #485460; padding-bottom: 10px; }
        
        /* ç»Ÿè®¡æ•°æ® */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-box { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px; text-align: center; }
        .stat-label { font-size: 11px; color: #aaa; display: block; }
        .stat-val { font-size: 16px; font-weight: bold; color: #00d2d3; font-family: 'Courier New', monospace; }

        /* å»ºç­‘å·¥å…·æ  */
        .tool-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 20px; }
        .tool-btn { padding: 12px 5px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; font-size: 13px; transition: 0.2s; background: #57606f; }
        .tool-btn:hover { filter: brightness(1.2); transform: scale(1.02); }
        .tool-btn.active { outline: 2px solid #fff; box-shadow: 0 0 10px var(--accent); }
        
        .b-house { background: #26de81; color: #1e272e; }
        .b-shop { background: #4bcffa; color: #1e272e; }
        .b-farm { background: #fed330; color: #1e272e; }
        .b-hosp { background: #ff7675; }
        .b-pol { background: #5758BB; }
        .b-fire { background: #eb3b5a; }
        .b-del { background: #2f3542; grid-column: span 2; }

        /* ä¸Šå¸è§†è§’è§‚å¯Ÿçª— */
        #inspector { background: #1e272e; padding: 15px; border-radius: 8px; border: 1px solid #485460; min-height: 120px; margin-top: 10px; }
        .tag { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; margin: 2px; }

        /* åˆå§‹é®ç½© */
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .menu-card { background: var(--sidebar-bg); padding: 40px; border-radius: 15px; text-align: center; }
        .diff-btn { display: block; width: 250px; padding: 15px; margin: 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.3s; color: white; }
    </style>
</head>
<body>

<div id="overlay">
    <div class="menu-card">
        <h1 style="font-size: 32px; border:none;">ä¸Šå¸è§†è§’ï¼šéƒ½å¸‚æ¼”åŒ–</h1>
        <p style="color: #aaa; margin-bottom: 30px;">è§‚å¯Ÿã€å»ºè®¾ã€å¹¶å¹³è¡¡å¾®å‹ç¤¾ä¼šçš„è¿è½¬</p>
        <button class="diff-btn b-house" id="start-easy">ç®€å• (èµ„é‡‘å……è£•)</button>
        <button class="diff-btn b-shop" id="start-normal">æ™®é€š (æ ‡å‡†æŒ‘æˆ˜)</button>
        <button class="diff-btn b-fire" id="start-hard">å›°éš¾ (èµ„æºç´§ç¼º)</button>
    </div>
</div>

<div id="game-layout">
    <div id="canvas-area">
        <canvas id="cityCanvas" width="800" height="700"></canvas>
    </div>
    
    <div id="sidebar">
        <h1>CITY OVERVIEW</h1>
        
        <div class="stat-grid">
            <div class="stat-box"><span class="stat-label">èµ„é‡‘</span><span class="stat-val" id="ui-money">$0</span></div>
            <div class="stat-box"><span class="stat-label">äººå£</span><span class="stat-val" id="ui-pop">0</span></div>
            <div class="stat-box"><span class="stat-label">é£Ÿç‰©</span><span class="stat-val" id="ui-food">0</span></div>
            <div class="stat-box"><span class="stat-label">æ»¡æ„åº¦</span><span class="stat-val" id="ui-happy">100%</span></div>
        </div>

        <div class="tool-grid" id="toolbar">
            <button class="tool-btn b-house active" data-type="house">ğŸ  ä½å®…åŒº</button>
            <button class="tool-btn b-shop" data-type="shop">ğŸ¢ å•†ä¸šåŒº</button>
            <button class="tool-btn b-farm" data-type="farm">ğŸŒ¾ å†œåœº</button>
            <button class="tool-btn b-hosp" data-type="hospital">ğŸ¥ åŒ»é™¢</button>
            <button class="tool-btn b-pol" data-type="police">ğŸš“ è­¦å±€</button>
            <button class="tool-btn b-fire" data-type="fire_station">ğŸš’ æ¶ˆé˜²ç«™</button>
            <button class="tool-btn b-del" data-type="delete">ğŸ”¨ æ‹†é™¤å»ºç­‘ (50% è¿”è¿˜)</button>
        </div>

        <div style="font-size:12px; margin-bottom:5px; color:#aaa;">ğŸ” ä¸Šå¸è§†è§’è§‚å¯Ÿçª—</div>
        <div id="inspector">é¼ æ ‡æ‚¬åœåœ¨å±…æ°‘èº«ä¸ŠæŸ¥çœ‹...</div>
        
        <div id="msg" style="margin-top:auto; color: #ff7675; font-size:12px; text-align:center; height:20px;"></div>
    </div>
</div>

<script>
/**
 * God View City v2.1 
 */

// --- å¸¸é‡é…ç½® ---
const TILE = 35;
const GRID_W = 22, GRID_H = 20;
const BUILDING_DATA = {
    house: { cost: 50, color: '#26de81', icon: 'ğŸ ', name: "ä½å®…åŒº", cap: 5 },
    shop: { cost: 100, color: '#4bcffa', icon: 'ğŸ›’', name: "å•†ä¸šä¸­å¿ƒ" },
    farm: { cost: 80, color: '#fed330', icon: 'ğŸŒ¾', name: "å†œåœº" },
    hospital: { cost: 300, color: '#ff7675', icon: 'âœš', name: "åŒ»é™¢" },
    police: { cost: 250, color: '#5758BB', icon: 'ğŸ‘®', name: "è­¦å¯Ÿå±€" },
    fire_station: { cost: 200, color: '#eb3b5a', icon: 'ğŸš’', name: "æ¶ˆé˜²ç«™" }
};

// --- å…¨å±€å˜é‡ ---
let game = {
    started: false,
    money: 1000, food: 200, pop: 0, 
    grid: [], buildings: [], agents: [],
    tool: 'house',
    tick: 0
};

const canvas = document.getElementById('cityCanvas');
const ctx = canvas.getContext('2d');

// --- æ ¸å¿ƒé€»è¾‘ ---

function initGame(diff) {
    // è®¾ç½®åˆå§‹èµ„æº
    if(diff === 'easy') { game.money = 2000; game.food = 500; }
    if(diff === 'hard') { game.money = 500; game.food = 100; }
    
    // åˆå§‹åŒ–ç½‘æ ¼
    for(let y=0; y<GRID_H; y++) {
        game.grid[y] = [];
        for(let x=0; x<GRID_W; x++) game.grid[y][x] = { type: 'empty' };
    }

    game.started = true;
    document.getElementById('overlay').style.display = 'none';
    
    requestAnimationFrame(render);
    setInterval(updateLogic, 150); // é€»è¾‘å¸§
}

// ä»£ç†å°äººç±»
class Agent {
    constructor(hx, hy) {
        this.homeX = hx; this.homeY = hy;
        this.x = hx * TILE + TILE/2; this.y = hy * TILE + TILE/2;
        this.tx = this.x; this.ty = this.y;
        this.speed = 0.4 + Math.random() * 0.4; // å‡æ…¢é€Ÿåº¦ï¼Œæ‚ é—²ç§»åŠ¨
        
        this.personality = {
            lazy: Math.random() < 0.3, // æ‡’äººåªåœ¨æ²¡é’±æ—¶å·¥ä½œ
            spender: Math.random() > 0.6 // è´­ç‰©ç‹‚å–œæ¬¢å»å•†åœº
        };
        
        this.stats = { money: 20, health: 100, happy: 100, hunger: 0 };
        this.state = 'idle'; // idle, work, shop, heal
        this.color = '#fff';
    }

    update() {
        // éœ€æ±‚å¢é•¿
        this.stats.hunger += 0.1;
        this.stats.happy -= 0.05;

        // å†³ç­–æ ‘
        if(this.atTarget()) {
            if(this.state === 'idle') {
                if(this.stats.health < 60) this.findJob('hospital', 'heal');
                else if(this.stats.money < (this.personality.lazy ? 10 : 50)) this.findJob(['shop','farm','police'], 'work');
                else if(this.personality.spender && this.stats.happy < 70) this.findJob('shop', 'shop');
                else if(Math.random() < 0.01) { // å¶å°”å›å®¶æˆ–ä¹±æ™ƒ
                    this.tx = this.homeX * TILE + TILE/2 + (Math.random()-0.5)*20;
                    this.ty = this.homeY * TILE + TILE/2 + (Math.random()-0.5)*20;
                }
            } else {
                this.performAction();
            }
        }
        this.move();
    }

    findJob(types, newState) {
        if(!Array.isArray(types)) types = [types];
        let target = null; let minD = 999;
        game.buildings.forEach(b => {
            if(types.includes(b.type)) {
                let d = Math.abs(b.x - this.homeX) + Math.abs(b.y - this.homeY);
                if(d < minD) { minD = d; target = b; }
            }
        });
        if(target) {
            this.state = newState;
            this.tx = target.x * TILE + TILE/2;
            this.ty = target.y * TILE + TILE/2;
        }
    }

    performAction() {
        if(this.state === 'work') {
            this.stats.money += 0.5; this.stats.happy -= 0.1;
            if(Math.random() > 0.95) game.money += 1; // äº¤ç¨
            if(this.stats.money > 100) { this.state = 'idle'; this.tx = this.homeX*TILE+TILE/2; this.ty = this.homeY*TILE+TILE/2; }
        } else if(this.state === 'shop') {
            this.stats.money -= 1; this.stats.happy += 2;
            if(this.stats.happy >= 100 || this.stats.money <= 0) { this.state = 'idle'; this.tx = this.homeX*TILE+TILE/2; this.ty = this.homeY*TILE+TILE/2; }
        } else if(this.state === 'heal') {
            this.stats.health += 5;
            if(this.stats.health >= 100) { this.state = 'idle'; this.tx = this.homeX*TILE+TILE/2; this.ty = this.homeY*TILE+TILE/2; }
        }
    }

    move() {
        let dx = this.tx - this.x; let dy = this.ty - this.y;
        let dist = Math.sqrt(dx*dx + dy*dy);
        if(dist > this.speed) { this.x += (dx/dist)*this.speed; this.y += (dy/dist)*this.speed; }
    }

    atTarget() { return Math.sqrt((this.x-this.tx)**2 + (this.y-this.ty)**2) < 5; }

    draw() {
        let c = '#fff';
        if(this.state === 'work') c = '#f1c40f';
        if(this.state === 'shop') c = '#3498db';
        if(this.stats.health < 50) c = '#e74c3c';
        ctx.fillStyle = c;
        ctx.beginPath(); ctx.arc(this.x, this.y, 3.5, 0, Math.PI*2); ctx.fill();
    }
}

// --- æ›´æ–°é€»è¾‘ ---
function updateLogic() {
    game.tick++;
    
    // é£Ÿç‰©æ¶ˆè€—
    if(game.tick % 40 === 0) {
        let cons = Math.ceil(game.agents.length * 0.5);
        if(game.food >= cons) game.food -= cons;
        else {
            game.agents.forEach(a => { a.stats.health -= 2; a.stats.happy -= 5; });
            showMsg("âš ï¸ åŸå¸‚é¥¥è’ä¸­ï¼");
        }
    }

    // å»ºç­‘åŠŸèƒ½
    game.buildings.forEach(b => {
        if(b.type === 'farm' && game.tick % 20 === 0) game.food += 2;
        // ç«ç¾å‡ ç‡
        if(!b.fire && Math.random() < 0.0003) {
            let safe = game.buildings.some(f => f.type === 'fire_station' && Math.abs(f.x-b.x)+Math.abs(f.y-b.y) < 6);
            if(!safe) b.fire = true;
        }
        if(b.fire) {
            b.hp -= 0.5;
            if(b.hp <= 0) removeBuilding(b.x, b.y);
        }
    });

    game.agents.forEach(a => a.update());
    updateUI();
}

function removeBuilding(x, y) {
    game.buildings = game.buildings.filter(b => !(b.x === x && b.y === y));
    game.grid[y][x] = { type: 'empty' };
}

// --- æ¸²æŸ“ ---
function render() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // ç½‘æ ¼
    ctx.strokeStyle = '#222';
    for(let i=0; i<=canvas.width; i+=TILE) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,canvas.height); ctx.stroke(); }
    for(let i=0; i<=canvas.height; i+=TILE) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(canvas.width,i); ctx.stroke(); }

    // æ™ºèƒ½é“è·¯ (åªæœ‰é‚»è¿‘å»ºç­‘è¿æ¥)
    ctx.strokeStyle = '#444'; ctx.lineWidth = 4;
    ctx.beginPath();
    for(let i=0; i<game.buildings.length; i++) {
        for(let j=i+1; j<game.buildings.length; j++) {
            let b1 = game.buildings[i], b2 = game.buildings[j];
            let d = Math.abs(b1.x-b2.x) + Math.abs(b1.y-b2.y);
            if(d < 5) {
                ctx.moveTo(b1.x*TILE+TILE/2, b1.y*TILE+TILE/2);
                ctx.lineTo(b2.x*TILE+TILE/2, b2.y*TILE+TILE/2);
            }
        }
    }
    ctx.stroke();

    // å»ºç­‘
    game.buildings.forEach(b => {
        let data = BUILDING_DATA[b.type];
        ctx.fillStyle = data.color;
        ctx.fillRect(b.x*TILE+4, b.y*TILE+4, TILE-8, TILE-8);
        ctx.fillStyle = "#fff"; ctx.font = "14px Arial"; ctx.textAlign = "center";
        ctx.fillText(data.icon, b.x*TILE+TILE/2, b.y*TILE+TILE-10);
        if(b.fire) { ctx.fillStyle = "rgba(255,0,0,0.5)"; ctx.beginPath(); ctx.arc(b.x*TILE+TILE/2, b.y*TILE+TILE/2, 15, 0, Math.PI*2); ctx.fill(); }
    });

    // å°äºº
    game.agents.forEach(a => a.draw());

    requestAnimationFrame(render);
}

// --- äº‹ä»¶ç›‘å¬ ---

// éš¾åº¦æŒ‰é’®
document.getElementById('start-easy').addEventListener('click', () => initGame('easy'));
document.getElementById('start-normal').addEventListener('click', () => initGame('normal'));
document.getElementById('start-hard').addEventListener('click', () => initGame('hard'));

// å·¥å…·åˆ‡æ¢
document.querySelectorAll('.tool-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        game.tool = btn.getAttribute('data-type');
    });
});

// ç”»å¸ƒç‚¹å‡» (å»ºé€ /æ‹†é™¤)
canvas.addEventListener('mousedown', e => {
    if(!game.started) return;
    const rect = canvas.getBoundingClientRect();
    const x = Math.floor((e.clientX - rect.left) / TILE);
    const y = Math.floor((e.clientY - rect.top) / TILE);
    
    if(x<0 || x>=GRID_W || y<0 || y>=GRID_H) return;

    if(game.tool === 'delete') {
        let b = game.buildings.find(b => b.x === x && b.y === y);
        if(b) {
            game.money += BUILDING_DATA[b.type].cost * 0.5;
            removeBuilding(x, y);
        }
    } else {
        if(game.grid[y][x].type !== 'empty') return;
        let data = BUILDING_DATA[game.tool];
        if(game.money >= data.cost) {
            game.money -= data.cost;
            game.grid[y][x] = { type: game.tool };
            game.buildings.push({ x, y, type: game.tool, hp: 100, fire: false });
            if(game.tool === 'house') {
                for(let i=0; i<data.cap; i++) game.agents.push(new Agent(x, y));
            }
        } else {
            showMsg("âŒ èµ„é‡‘ä¸è¶³!");
        }
    }
});

// æ‚¬åœè§‚å¯Ÿ
canvas.addEventListener('mousemove', e => {
    if(!game.started) return;
    const rect = canvas.getBoundingClientRect();
    const x = Math.floor((e.clientX - rect.left) / TILE);
    const y = Math.floor((e.clientY - rect.top) / TILE);
    
    let targetAgent = game.agents.find(a => Math.floor(a.x/TILE) === x && Math.floor(a.y/TILE) === y);
    const insp = document.getElementById('inspector');
    
    if(targetAgent) {
        let traits = (targetAgent.personality.lazy ? "<span class='tag' style='background:#95a5a6'>æ‡’æƒ°</span>" : "<span class='tag' style='background:#f1c40f'>å‹¤åŠ³</span>") +
                     (targetAgent.personality.spender ? "<span class='tag' style='background:#e17055'>æ¶ˆè´¹ç‹‚</span>" : "<span class='tag' style='background:#00b894'>èŠ‚çº¦</span>");
        insp.innerHTML = `<strong>ğŸ‘¤ å±…æ°‘çŠ¶æ€</strong><br>å¿ƒæƒ…: ${Math.floor(targetAgent.stats.happy)}% | å­˜æ¬¾: $${Math.floor(targetAgent.stats.money)}<br>å½“å‰: ${targetAgent.state}<br>${traits}`;
    } else {
        let b = game.buildings.find(b => b.x === x && b.y === y);
        if(b) insp.innerHTML = `<strong>${BUILDING_DATA[b.type].name}</strong><br>çŠ¶æ€: ${b.fire ? "ğŸ”¥ èµ·ç«!" : "æ­£å¸¸"}<br>ä½ç½®: ${x}, ${y}`;
    }
});

function updateUI() {
    document.getElementById('ui-money').innerText = "$" + Math.floor(game.money);
    document.getElementById('ui-pop').innerText = game.agents.length;
    document.getElementById('ui-food').innerText = Math.floor(game.food);
    let h = game.agents.length ? Math.floor(game.agents.reduce((a,b)=>a+b.stats.happy, 0)/game.agents.length) : 100;
    document.getElementById('ui-happy').innerText = h + "%";
}

function showMsg(m) {
    const el = document.getElementById('msg');
    el.innerText = m;
    setTimeout(() => el.innerText = "", 2000);
}

</script>
</body>
</html>
