<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å¾®å‹è‡ªåŠ¨éƒ½å¸‚ (Mini Auto City)</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            overflow: hidden;
        }
        h1 { margin: 0 0 10px 0; font-size: 24px; }
        #game-container {
            display: flex;
            gap: 20px;
        }
        canvas {
            background-color: #34495e;
            border: 4px solid #ecf0f1;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            cursor: crosshair;
        }
        #sidebar {
            width: 250px;
            background: #34495e;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }
        .stat-box {
            background: rgba(0,0,0,0.2);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .stat-label { font-size: 12px; color: #bdc3c7; }
        .stat-value { font-size: 18px; font-weight: bold; }
        
        button {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            text-align: left;
            position: relative;
        }
        button:hover { filter: brightness(1.1); transform: translateX(2px); }
        button.active { border-left: 5px solid white; }

        .btn-house { background-color: #2ecc71; color: white; }
        .btn-shop { background-color: #3498db; color: white; }
        .btn-farm { background-color: #f1c40f; color: #2c3e50; }
        .btn-industry { background-color: #95a5a6; color: white; }
        .btn-delete { background-color: #e74c3c; color: white; }

        .cost { font-size: 10px; float: right; opacity: 0.8; }

        #difficulty-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 62, 80, 0.95);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 100;
        }
        .diff-btn {
            width: 200px; margin: 10px; text-align: center;
            font-size: 18px; padding: 15px;
        }

        #message-area {
            height: 30px;
            color: #e74c3c;
            font-weight: bold;
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <div id="difficulty-screen">
        <h1>é€‰æ‹©éš¾åº¦</h1>
        <p>å¹³è¡¡äººå£å¢é•¿ä¸é£Ÿç‰©æ¶ˆè€—</p>
        <button class="diff-btn btn-house" onclick="startGame('easy')">ç®€å• (èµ„æºå¤šï¼Œæ¶ˆè€—ä½)</button>
        <button class="diff-btn btn-shop" onclick="startGame('normal')">æ™®é€š (æ ‡å‡†ä½“éªŒ)</button>
        <button class="diff-btn btn-delete" onclick="startGame('hard')">å›°éš¾ (èµ„æºå°‘ï¼Œæ¶ˆè€—é«˜)</button>
    </div>

    <h1>å¾®å‹è‡ªåŠ¨éƒ½å¸‚ v1.0</h1>

    <div id="game-container">
        <canvas id="cityCanvas" width="600" height="600"></canvas>
        
        <div id="sidebar">
            <div class="stat-box">
                <div class="stat-label">èµ„é‡‘ (Money)</div>
                <div class="stat-value" id="ui-money">$0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">äººå£ (Population)</div>
                <div class="stat-value"><span id="ui-pop">0</span> / <span id="ui-cap">0</span></div>
            </div>
            <div class="stat-box" style="display: flex; justify-content: space-between;">
                <div>
                    <div class="stat-label">é£Ÿç‰© (Food)</div>
                    <div class="stat-value" id="ui-food">0</div>
                </div>
                <div style="text-align: right;">
                    <div class="stat-label">æ¶ˆè€—/äº§å‡º</div>
                    <div class="stat-value" id="ui-balance" style="font-size: 14px;">0/s</div>
                </div>
            </div>

            <hr style="border-color: rgba(255,255,255,0.1)">
            <p style="font-size: 12px; color: #bdc3c7;">ç‚¹å‡»å»ºé€  (é“è·¯è‡ªåŠ¨ç”Ÿæˆ)</p>

            <button class="btn-house active" onclick="setTool('house')">
                ğŸ  å±…ä½åŒº <span class="cost">$50</span>
                <div style="font-size:10px; font-weight:normal">å¢åŠ äººå£ä¸Šé™, æ¶ˆè€—é£Ÿç‰©</div>
            </button>
            <button class="btn-shop" onclick="setTool('shop')">
                ğŸ¢ å•†ä¸šåŒº <span class="cost">$100</span>
                <div style="font-size:10px; font-weight:normal">æä¾›å·¥ä½œ, äº§ç”Ÿç¨æ”¶</div>
            </button>
            <button class="btn-farm" onclick="setTool('farm')">
                ğŸŒ¾ å†œåœº <span class="cost">$80</span>
                <div style="font-size:10px; font-weight:normal">è‡ªåŠ¨ç”Ÿäº§é£Ÿç‰© (æ…¢)</div>
            </button>
            <button class="btn-industry" onclick="setTool('industry')">
                ğŸ­ è¿›å£ä¸­å¿ƒ <span class="cost">$200</span>
                <div style="font-size:10px; font-weight:normal">èŠ±é’±ä¹°é£Ÿç‰© (å¿«)</div>
            </button>
            <button class="btn-delete" onclick="setTool('delete')">
                âŒ æ‹†é™¤ <span class="cost">$10</span>
            </button>

            <div id="message-area"></div>
        </div>
    </div>

<script>
/**
 * æ¸¸æˆæ ¸å¿ƒé€»è¾‘
 */

// é…ç½®ä¸å¸¸é‡
const TILE_SIZE = 30;
const GRID_W = 20;
const GRID_H = 20;
const COLORS = {
    empty: '#34495e',
    house: '#2ecc71',
    shop: '#3498db',
    farm: '#f1c40f',
    industry: '#95a5a6',
    road: '#7f8c8d',
    agent: '#ecf0f1'
};

// æ¸¸æˆçŠ¶æ€
let game = {
    money: 1000,
    food: 100,
    population: 0,
    popCap: 0,
    grid: [], // 2D array representing the map
    agents: [],
    buildings: [],
    lastTick: 0,
    difficulty: 'normal',
    food consumptionRate: 1.0,
    gameOver: false
};

let currentTool = 'house';

// éš¾åº¦é…ç½®
const DIFFICULTY_SETTINGS = {
    easy: { money: 2000, food: 200, rate: 0.5 },
    normal: { money: 1000, food: 100, rate: 1.0 },
    hard: { money: 500, food: 50, rate: 2.0 }
};

const BUILDING_STATS = {
    house: { cost: 50, cap: 5, color: COLORS.house },
    shop: { cost: 100, income: 10, color: COLORS.shop },
    farm: { cost: 80, foodProd: 2, color: COLORS.farm },
    industry: { cost: 200, importCost: 5, foodImport: 10, color: COLORS.industry }
};

// Canvas è®¾ç½®
const canvas = document.getElementById('cityCanvas');
const ctx = canvas.getContext('2d');

// --- åˆå§‹åŒ– ---

function initGrid() {
    game.grid = [];
    for (let y = 0; y < GRID_H; y++) {
        let row = [];
        for (let x = 0; x < GRID_W; x++) {
            row.push({ type: 'empty', id: null });
        }
        game.grid.push(row);
    }
}

function startGame(diff) {
    document.getElementById('difficulty-screen').style.display = 'none';
    game.difficulty = diff;
    game.money = DIFFICULTY_SETTINGS[diff].money;
    game.food = DIFFICULTY_SETTINGS[diff].food;
    game.consumptionRate = DIFFICULTY_SETTINGS[diff].rate;
    
    initGrid();
    requestAnimationFrame(gameLoop);
    
    // å¯åŠ¨ç»æµå¾ªç¯ (æ¯ç§’ä¸€æ¬¡)
    setInterval(economyTick, 1000);
}

// --- æ ¸å¿ƒç±» ---

class Building {
    constructor(x, y, type) {
        this.x = x;
        this.y = y;
        this.type = type;
        this.id = Math.random().toString(36).substr(2, 9);
    }
}

class Agent {
    constructor(homeX, homeY) {
        this.x = homeX * TILE_SIZE + TILE_SIZE/2;
        this.y = homeY * TILE_SIZE + TILE_SIZE/2;
        this.homeX = homeX;
        this.homeY = homeY;
        this.targetX = null;
        this.targetY = null;
        this.state = 'idle'; // idle, moving_work, working, moving_food, eating, moving_home
        this.speed = 1.5; // ç§»åŠ¨é€Ÿåº¦
        this.waitTime = 0;
    }

    update() {
        if (this.waitTime > 0) {
            this.waitTime--;
            return;
        }

        // çŠ¶æ€æœº
        if (this.state === 'idle') {
            // åœ¨å®¶ä¼‘æ¯å®Œï¼Œå»å·¥ä½œ
            const shop = findNearestBuilding(this.x, this.y, 'shop');
            if (shop) {
                this.setTarget(shop.x, shop.y, 'moving_work');
            } else {
                // æ²¡å·¥ä½œå°±åœ¨å®¶å‘†ç€ï¼Œè™½ç„¶æ— èŠ
            }
        } else if (this.state === 'moving_work') {
            if (this.move()) {
                this.state = 'working';
                this.waitTime = 60; // å·¥ä½œä¸€ä¼š
            }
        } else if (this.state === 'working') {
            // å·¥ä½œå®Œï¼Œå»æ‰¾åƒçš„ (å†œåœºæˆ–è¿›å£)
            const foodSource = findNearestBuilding(this.x, this.y, ['farm', 'industry']);
            if (foodSource) {
                this.setTarget(foodSource.x, foodSource.y, 'moving_food');
            } else {
                // æ²¡åƒçš„å°±ç›´æ¥å›å®¶
                this.setTarget(this.homeX, this.homeY, 'moving_home');
            }
        } else if (this.state === 'moving_food') {
            if (this.move()) {
                this.state = 'eating';
                this.waitTime = 30; 
            }
        } else if (this.state === 'eating') {
            this.setTarget(this.homeX, this.homeY, 'moving_home');
        } else if (this.state === 'moving_home') {
            if (this.move()) {
                this.state = 'idle';
                this.waitTime = 50;
            }
        }
    }

    setTarget(tx, ty, newState) {
        this.targetX = tx * TILE_SIZE + TILE_SIZE/2;
        this.targetY = ty * TILE_SIZE + TILE_SIZE/2;
        this.state = newState;
    }

    move() {
        const dx = this.targetX - this.x;
        const dy = this.targetY - this.y;
        const dist = Math.sqrt(dx*dx + dy*dy);

        if (dist < this.speed) {
            this.x = this.targetX;
            this.y = this.targetY;
            return true; // Arrived
        }

        this.x += (dx / dist) * this.speed;
        this.y += (dy / dist) * this.speed;
        return false;
    }

    draw(ctx) {
        ctx.fillStyle = COLORS.agent;
        ctx.beginPath();
        ctx.arc(this.x, this.y, 3, 0, Math.PI * 2);
        ctx.fill();
    }
}

// --- è¾…åŠ©å‡½æ•° ---

function findNearestBuilding(px, py, types) {
    if (!Array.isArray(types)) types = [types];
    let nearest = null;
    let minDist = Infinity;

    // ç®€å•éå†æ‰€æœ‰å»ºç­‘ (ä¼˜åŒ–: å¯¹äºå¤§åœ°å›¾åº”ä½¿ç”¨å››å‰æ ‘ï¼Œè¿™é‡Œ20x20ç›´æ¥éå†å³å¯)
    for (let b of game.buildings) {
        if (types.includes(b.type)) {
            // åƒç´ è·ç¦»
            const bx = b.x * TILE_SIZE + TILE_SIZE/2;
            const by = b.y * TILE_SIZE + TILE_SIZE/2;
            const dist = Math.sqrt((px-bx)**2 + (py-by)**2);
            if (dist < minDist) {
                minDist = dist;
                nearest = b;
            }
        }
    }
    return nearest;
}

// --- äº¤äº’æ§åˆ¶ ---

function setTool(tool) {
    currentTool = tool;
    document.querySelectorAll('button').forEach(b => b.classList.remove('active'));
    document.querySelector(`.btn-${tool}`).classList.add('active');
}

canvas.addEventListener('mousedown', (e) => {
    if (game.gameOver) return;

    const rect = canvas.getBoundingClientRect();
    const x = Math.floor((e.clientX - rect.left) / TILE_SIZE);
    const y = Math.floor((e.clientY - rect.top) / TILE_SIZE);

    if (x < 0 || x >= GRID_W || y < 0 || y >= GRID_H) return;

    if (currentTool === 'delete') {
        const tile = game.grid[y][x];
        if (tile.type !== 'empty') {
            // æ‹†é™¤é€»è¾‘
            game.money += 10; // å›æ”¶ä¸€ç‚¹é’±
            game.grid[y][x] = { type: 'empty', id: null };
            game.buildings = game.buildings.filter(b => !(b.x === x && b.y === y));
            // å¦‚æœæ‹†çš„æ˜¯æˆ¿å­ï¼Œäººå£ä¸Šé™å‡å°‘ï¼Œä½†ç°æœ‰äººå£ä¸ç«‹å³æ­»ï¼Œç­‰è‡ªç„¶æ¶ˆè€—
            if (tile.type === 'house') {
                 // ç§»é™¤è¯¥æˆ¿å­å…³è”çš„agents (ç®€åŒ–å¤„ç†ï¼šéšæœºç§»é™¤è¶…é¢äººå£)
            }
            updateUI();
        }
    } else {
        // å»ºé€ é€»è¾‘
        const stats = BUILDING_STATS[currentTool];
        if (game.money >= stats.cost) {
            if (game.grid[y][x].type === 'empty') {
                game.money -= stats.cost;
                game.grid[y][x] = { type: currentTool };
                game.buildings.push(new Building(x, y, currentTool));
                
                if (currentTool === 'house') {
                    // æˆ¿å­ç”Ÿæˆå°äºº
                    for(let i=0; i<stats.cap; i++) {
                        game.agents.push(new Agent(x, y));
                    }
                    game.population += stats.cap;
                    game.popCap += stats.cap;
                }
                updateUI();
            } else {
                showMessage("è¿™é‡Œå·²ç»æœ‰å»ºç­‘äº†ï¼");
            }
        } else {
            showMessage("èµ„é‡‘ä¸è¶³ï¼");
        }
    }
});

function showMessage(msg) {
    const el = document.getElementById('message-area');
    el.innerText = msg;
    setTimeout(() => el.innerText = "", 2000);
}

// --- æ¸¸æˆå¾ªç¯ ---

function economyTick() {
    if (game.gameOver) return;

    let foodChange = 0;
    let moneyChange = 0;

    // 1. æ¶ˆè€—é£Ÿç‰©
    const consumption = Math.floor(game.population * game.consumptionRate);
    game.food -= consumption;
    foodChange -= consumption;

    // 2. ç”Ÿäº§é£Ÿç‰©
    const farms = game.buildings.filter(b => b.type === 'farm');
    const farmProd = farms.length * BUILDING_STATS.farm.foodProd;
    game.food += farmProd;
    foodChange += farmProd;

    // 3. å·¥ä¸šè¿›å£ (å¦‚æœé£Ÿç‰©ä¸å¤Ÿï¼Œä¸”æœ‰é’±ï¼Œè‡ªåŠ¨è¿›å£)
    const industries = game.buildings.filter(b => b.type === 'industry');
    industries.forEach(ind => {
        if (game.food < game.population * 5 && game.money >= BUILDING_STATS.industry.importCost) {
            game.money -= BUILDING_STATS.industry.importCost;
            game.food += BUILDING_STATS.industry.foodImport;
            moneyChange -= BUILDING_STATS.industry.importCost;
            foodChange += BUILDING_STATS.industry.foodImport;
        }
    });

    // 4. ç¨æ”¶ (æ¯ä¸ªå•†ä¸šåŒº + æ¯ä¸ªäººå£å¾®é‡ç¨æ”¶)
    const shops = game.buildings.filter(b => b.type === 'shop');
    const tax = Math.floor(game.population * 0.5) + (shops.length * BUILDING_STATS.shop.income);
    game.money += tax;
    moneyChange += tax;

    // åˆ¤å®šç”Ÿæ­»
    if (game.food < 0) {
        game.food = 0;
        // é¥¿æ­»äººï¼šéšæœºå‡å°‘äººå£
        const deathToll = Math.floor(game.population * 0.2) + 1;
        game.population = Math.max(0, game.population - deathToll);
        // ç§»é™¤æ­»æ‰çš„agent
        game.agents.splice(0, deathToll);
        showMessage(`è­¦å‘Šï¼é£Ÿç‰©çŸ­ç¼ºï¼Œ${deathToll} äººé¥¿æ­»ï¼`);
        
        if (game.population === 0 && game.money < 50) {
            game.gameOver = true;
            alert("æ¸¸æˆç»“æŸï¼åŸå¸‚è’åºŸäº†ã€‚åˆ·æ–°é¡µé¢é‡è¯•ã€‚");
        }
    }

    updateUI(foodChange);
}

function updateUI(foodBalance = 0) {
    document.getElementById('ui-money').innerText = `$${game.money}`;
    document.getElementById('ui-pop').innerText = game.population;
    document.getElementById('ui-cap').innerText = game.popCap;
    document.getElementById('ui-food').innerText = game.food;
    
    const balanceEl = document.getElementById('ui-balance');
    balanceEl.innerText = (foodBalance >= 0 ? "+" : "") + foodBalance + "/s";
    balanceEl.style.color = foodBalance >= 0 ? "#2ecc71" : "#e74c3c";
}

function gameLoop() {
    // Update Agents
    game.agents.forEach(agent => agent.update());

    // Draw
    draw();

    if (!game.gameOver) {
        requestAnimationFrame(gameLoop);
    }
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // ç»˜åˆ¶ç½‘æ ¼
    ctx.strokeStyle = 'rgba(255,255,255,0.05)';
    ctx.lineWidth = 1;
    for (let x = 0; x <= canvas.width; x += TILE_SIZE) {
        ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke();
    }
    for (let y = 0; y <= canvas.height; y += TILE_SIZE) {
        ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke();
    }

    // ç»˜åˆ¶è‡ªåŠ¨é“è·¯è¿æ¥çº¿ (Auto-Roads)
    // é€»è¾‘ï¼šå¦‚æœä¸¤ä¸ªå»ºç­‘è·ç¦»å°äºä¸€å®šèŒƒå›´ï¼Œç”»çº¿è¿æ¥
    ctx.strokeStyle = COLORS.road;
    ctx.lineWidth = 4;
    ctx.lineCap = 'round';
    
    // ç®€å•çš„è¿æ¥é€»è¾‘ï¼šæ¯ä¸ªå»ºç­‘è¿æ¥åˆ°æœ€è¿‘çš„2ä¸ªé‚»å±…
    // ä¸ºäº†æ€§èƒ½ï¼Œè¿™é‡Œåªåšç®€å•çš„å…¨ç½‘æ ¼æ‰«æï¼Œå› ä¸ºæ•°é‡å°‘
    // ä¼˜åŒ–ï¼šå®é™…ç»˜åˆ¶æ—¶ï¼Œåªç”» "æœ‰é€»è¾‘å…³è”" çš„çº¿ä¼šæ›´åƒè·¯ï¼Œè¿™é‡Œç”»æ‰€æœ‰è¿‘é‚»
    ctx.beginPath();
    for (let i = 0; i < game.buildings.length; i++) {
        let b1 = game.buildings[i];
        for (let j = i + 1; j < game.buildings.length; j++) {
            let b2 = game.buildings[j];
            let dist = Math.abs(b1.x - b2.x) + Math.abs(b1.y - b2.y); // æ›¼å“ˆé¡¿è·ç¦»
            if (dist <= 4) { // åªæœ‰è·ç¦»è¿‘çš„æ‰è‡ªåŠ¨ä¿®è·¯
                ctx.moveTo(b1.x * TILE_SIZE + TILE_SIZE/2, b1.y * TILE_SIZE + TILE_SIZE/2);
                ctx.lineTo(b2.x * TILE_SIZE + TILE_SIZE/2, b2.y * TILE_SIZE + TILE_SIZE/2);
            }
        }
    }
    ctx.stroke();

    // ç»˜åˆ¶å»ºç­‘
    for (let y = 0; y < GRID_H; y++) {
        for (let x = 0; x < GRID_W; x++) {
            let tile = game.grid[y][x];
            if (tile.type !== 'empty') {
                ctx.fillStyle = BUILDING_STATS[tile.type].color;
                // ç®€å•çš„é˜´å½±æ•ˆæœ
                ctx.fillRect(x * TILE_SIZE + 2, y * TILE_SIZE + 2, TILE_SIZE - 4, TILE_SIZE - 4);
                
                // ç»˜åˆ¶å›¾æ ‡/æ–‡å­—ç®€å†™
                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                let icon = '';
                if(tile.type==='house') icon='H';
                if(tile.type==='shop') icon='S';
                if(tile.type==='farm') icon='F';
                if(tile.type==='industry') icon='I';
                ctx.fillText(icon, x * TILE_SIZE + TILE_SIZE/2, y * TILE_SIZE + TILE_SIZE/2 + 4);
            }
        }
    }

    // ç»˜åˆ¶ Agent
    game.agents.forEach(agent => agent.draw(ctx));
}

</script>
</body>
</html>
