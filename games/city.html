<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å¾®å‹è‡ªåŠ¨éƒ½å¸‚ (Mini Auto City) v1.1</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }
        h1 { margin: 0 0 10px 0; font-size: 24px; text-shadow: 2px 2px 0px rgba(0,0,0,0.3); }
        #game-container {
            display: flex;
            gap: 20px;
            position: relative;
        }
        canvas {
            background-color: #34495e;
            border: 4px solid #ecf0f1;
            box-shadow: 0 0 30px rgba(0,0,0,0.6);
            cursor: crosshair;
            border-radius: 4px;
        }
        #sidebar {
            width: 260px;
            background: #2c3e50;
            padding: 15px;
            border: 2px solid #34495e;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }
        .stat-group {
            background: rgba(0,0,0,0.2);
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 6px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            align-items: baseline;
        }
        .stat-label { font-size: 12px; color: #95a5a6; }
        .stat-value { font-size: 16px; font-weight: bold; font-family: monospace;}
        
        button {
            width: 100%;
            padding: 12px;
            margin-bottom: 8px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            text-align: left;
            position: relative;
            transition: transform 0.1s, filter 0.1s;
            color: white;
            font-size: 14px;
        }
        button:hover { filter: brightness(1.1); transform: translateX(2px); }
        button:active { transform: translateX(1px) translateY(1px); }
        button.active { outline: 2px solid white; box-shadow: 0 0 10px white; }

        .btn-house { background-color: #27ae60; }
        .btn-shop { background-color: #2980b9; }
        .btn-farm { background-color: #f39c12; color: #2c3e50; }
        .btn-industry { background-color: #7f8c8d; }
        .btn-delete { background-color: #c0392b; margin-top: auto;}

        .cost { float: right; font-size: 12px; opacity: 0.8; background: rgba(0,0,0,0.2); padding: 2px 5px; border-radius: 4px;}
        .desc { font-size: 10px; display: block; opacity: 0.7; font-weight: normal; margin-top: 2px;}

        /* éš¾åº¦é€‰æ‹©é®ç½© */
        #difficulty-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 62, 80, 0.98);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 999;
        }
        .diff-container {
            background: #34495e; padding: 40px; border-radius: 10px;
            text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .diff-btn {
            width: 200px; margin: 10px auto; text-align: center;
            font-size: 18px; padding: 15px; display: block;
        }

        #message-area {
            height: 20px;
            color: #e74c3c;
            font-weight: bold;
            font-size: 12px;
            text-align: center;
            margin-top: 10px;
            min-height: 1.5em;
        }
    </style>
</head>
<body>

    <div id="difficulty-screen">
        <div class="diff-container">
            <h1 style="margin-bottom: 30px;">ğŸ™ï¸ åˆ›å»ºä½ çš„åŸå¸‚</h1>
            <button class="diff-btn btn-house" onclick="startGame('easy')">ç®€å•æ¨¡å¼ <div style="font-size:12px; font-weight:normal">èµ„æºå……æ²›ï¼Œè½»æ¾å»ºè®¾</div></button>
            <button class="diff-btn btn-shop" onclick="startGame('normal')">æ™®é€šæ¨¡å¼ <div style="font-size:12px; font-weight:normal">æ ‡å‡†çš„ç»è¥æŒ‘æˆ˜</div></button>
            <button class="diff-btn btn-delete" onclick="startGame('hard')">å›°éš¾æ¨¡å¼ <div style="font-size:12px; font-weight:normal">èµ„æºæå°‘ï¼Œç”Ÿå­˜è‰°éš¾</div></button>
        </div>
    </div>

    <h1>MINI AUTO CITY</h1>

    <div id="game-container">
        <canvas id="cityCanvas" width="600" height="600"></canvas>
        
        <div id="sidebar">
            <div class="stat-group">
                <div class="stat-row">
                    <span class="stat-label">ğŸ’° èµ„é‡‘</span>
                    <span class="stat-value" id="ui-money">$0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">ğŸ‘¥ äººå£ / ä¸Šé™</span>
                    <span class="stat-value"><span id="ui-pop">0</span> / <span id="ui-cap">0</span></span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">ğŸ é£Ÿç‰©å‚¨é‡</span>
                    <span class="stat-value" id="ui-food">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">âš–ï¸ ç”Ÿäº§æ•ˆç‡</span>
                    <span class="stat-value" id="ui-balance">0/s</span>
                </div>
            </div>

            <button class="btn-house active" onclick="setTool('house')">
                ä½å®…åŒº <span class="cost">$50</span>
                <span class="desc">å¢åŠ  5 äººå£ï¼Œæ¶ˆè€—é£Ÿç‰©</span>
            </button>
            <button class="btn-shop" onclick="setTool('shop')">
                å•†ä¸šåŒº <span class="cost">$100</span>
                <span class="desc">æä¾›å·¥ä½œï¼Œäº§ç”Ÿç¨æ”¶</span>
            </button>
            <button class="btn-farm" onclick="setTool('farm')">
                å†œåœº <span class="cost">$80</span>
                <span class="desc">ç”Ÿäº§é£Ÿç‰© (æ…¢é€Ÿ)</span>
            </button>
            <button class="btn-industry" onclick="setTool('industry')">
                è´¸æ˜“ä¸­å¿ƒ <span class="cost">$200</span>
                <span class="desc">èŠ±é’±å¿«é€Ÿè¿›å£é£Ÿç‰©</span>
            </button>
            
            <button class="btn-delete" onclick="setTool('delete')">
                ğŸš§ æ‹†é™¤å»ºç­‘ <span class="cost">+$10</span>
                <span class="desc">æ¸…ç†è§„åˆ’é”™è¯¯çš„åŒºåŸŸ</span>
            </button>

            <div id="message-area"></div>
        </div>
    </div>

<script>
/**
 * ä¿®å¤ç‰ˆ v1.1 - ä¿®å¤äº†å¯¹è±¡å®šä¹‰çš„è¯­æ³•é”™è¯¯
 */

// --- é…ç½®ä¸å¸¸é‡ ---
const TILE_SIZE = 30;
const GRID_W = 20;
const GRID_H = 20;
const COLORS = {
    empty: '#34495e',
    house: '#27ae60',
    shop: '#2980b9',
    farm: '#f39c12',
    industry: '#7f8c8d',
    road: '#95a5a6',
    agent: '#ecf0f1'
};

const DIFFICULTY_SETTINGS = {
    easy: { money: 2000, food: 300, rate: 0.5 },
    normal: { money: 1000, food: 100, rate: 1.0 },
    hard: { money: 500, food: 50, rate: 2.0 }
};

const BUILDING_STATS = {
    house: { cost: 50, cap: 5, color: COLORS.house },
    shop: { cost: 100, income: 15, color: COLORS.shop },
    farm: { cost: 80, foodProd: 3, color: COLORS.farm }, // ç¨å¾®åŠ å¼ºäº†å†œåœº
    industry: { cost: 200, importCost: 10, foodImport: 15, color: COLORS.industry }
};

// --- æ¸¸æˆå…¨å±€çŠ¶æ€ ---
let game = {
    started: false,
    money: 0,
    food: 0,
    population: 0,
    popCap: 0,
    grid: [],
    agents: [],
    buildings: [],
    difficulty: 'normal',
    consumptionRate: 1.0, // ä¹‹å‰è¿™é‡Œæœ‰è¯­æ³•é”™è¯¯ï¼Œå·²ä¿®å¤
    gameOver: false,
    intervalId: null
};

let currentTool = 'house';

// Canvas è®¾ç½®
const canvas = document.getElementById('cityCanvas');
const ctx = canvas.getContext('2d');

// --- æ ¸å¿ƒé€»è¾‘ ---

function initGrid() {
    game.grid = [];
    for (let y = 0; y < GRID_H; y++) {
        let row = [];
        for (let x = 0; x < GRID_W; x++) {
            row.push({ type: 'empty', id: null });
        }
        game.grid.push(row);
    }
}

// å¯åŠ¨æ¸¸æˆå‡½æ•°
window.startGame = function(diff) {
    if(game.started) return;
    
    // éšè—èœå•
    document.getElementById('difficulty-screen').style.display = 'none';
    
    // åˆå§‹åŒ–æ•°æ®
    game.difficulty = diff;
    game.money = DIFFICULTY_SETTINGS[diff].money;
    game.food = DIFFICULTY_SETTINGS[diff].food;
    game.consumptionRate = DIFFICULTY_SETTINGS[diff].rate;
    game.started = true;
    
    initGrid();
    updateUI();
    
    // å¼€å§‹å¾ªç¯
    requestAnimationFrame(gameLoop);
    game.intervalId = setInterval(economyTick, 1000); // 1ç§’ä¸€æ¬¡ç»æµç»“ç®—
    
    console.log("Game Started: " + diff);
}

// å»ºç­‘ç±»
class Building {
    constructor(x, y, type) {
        this.x = x;
        this.y = y;
        this.type = type;
        this.id = Math.random().toString(36).substr(2, 9);
    }
}

// å°äººä»£ç†ç±» (ç®€å•çš„çŠ¶æ€æœº)
class Agent {
    constructor(homeX, homeY) {
        this.x = homeX * TILE_SIZE + TILE_SIZE/2;
        this.y = homeY * TILE_SIZE + TILE_SIZE/2;
        this.homeX = homeX;
        this.homeY = homeY;
        this.targetX = this.x;
        this.targetY = this.y;
        this.state = 'idle'; 
        this.speed = 2; // æé«˜ä¸€ç‚¹é€Ÿåº¦
        this.waitTime = 0;
    }

    update() {
        if (this.waitTime > 0) {
            this.waitTime--;
            return;
        }

        // ç®€å•çš„è¡Œä¸ºé€»è¾‘å¾ªç¯: é—²ç½® -> å»å·¥ä½œ -> å·¥ä½œä¸­ -> å»åƒé¥­ -> åƒé¥­ -> å›å®¶
        switch(this.state) {
            case 'idle':
                // å°è¯•æ‰¾å·¥ä½œ
                let shop = findNearestBuilding(this.x, this.y, 'shop');
                if (shop) {
                    this.setTarget(shop.x, shop.y, 'moving_work');
                }
                break;
            case 'moving_work':
                if (this.move()) {
                    this.state = 'working';
                    this.waitTime = 40; // å·¥ä½œæ—¶é—´
                }
                break;
            case 'working':
                // å·¥ä½œå®Œé¥¿äº†ï¼Œæ‰¾åƒçš„
                let foodSrc = findNearestBuilding(this.x, this.y, ['farm', 'industry']);
                if (foodSrc) {
                    this.setTarget(foodSrc.x, foodSrc.y, 'moving_food');
                } else {
                    this.setTarget(this.homeX, this.homeY, 'moving_home'); // æ²¡åƒçš„åªèƒ½å›å®¶
                }
                break;
            case 'moving_food':
                if (this.move()) {
                    this.state = 'eating';
                    this.waitTime = 20;
                }
                break;
            case 'eating':
                this.setTarget(this.homeX, this.homeY, 'moving_home');
                break;
            case 'moving_home':
                if (this.move()) {
                    this.state = 'idle';
                    this.waitTime = 60; // åœ¨å®¶ä¼‘æ¯
                }
                break;
        }
    }

    setTarget(gridX, gridY, newState) {
        // å¢åŠ ä¸€ç‚¹éšæœºåç§»ï¼Œé˜²æ­¢æ‰€æœ‰äººé‡å æˆä¸€ä¸ªç‚¹
        const offset = (Math.random() - 0.5) * 10;
        this.targetX = gridX * TILE_SIZE + TILE_SIZE/2 + offset;
        this.targetY = gridY * TILE_SIZE + TILE_SIZE/2 + offset;
        this.state = newState;
    }

    move() {
        const dx = this.targetX - this.x;
        const dy = this.targetY - this.y;
        const dist = Math.sqrt(dx*dx + dy*dy);

        if (dist < this.speed) {
            this.x = this.targetX;
            this.y = this.targetY;
            return true; // åˆ°è¾¾
        }

        this.x += (dx / dist) * this.speed;
        this.y += (dy / dist) * this.speed;
        return false; // è¿˜åœ¨è·¯ä¸Š
    }

    draw(ctx) {
        ctx.fillStyle = COLORS.agent;
        ctx.beginPath();
        ctx.arc(this.x, this.y, 3, 0, Math.PI * 2);
        ctx.fill();
    }
}

function findNearestBuilding(px, py, types) {
    if (!Array.isArray(types)) types = [types];
    let nearest = null;
    let minDist = Infinity;

    for (let b of game.buildings) {
        if (types.includes(b.type)) {
            const bx = b.x * TILE_SIZE + TILE_SIZE/2;
            const by = b.y * TILE_SIZE + TILE_SIZE/2;
            const dist = (px-bx)**2 + (py-by)**2; // ä½¿ç”¨å¹³æ–¹è·ç¦»æ¯”è¾ƒï¼Œçœå»å¼€æ–¹
            if (dist < minDist) {
                minDist = dist;
                nearest = b;
            }
        }
    }
    return nearest;
}

// --- äº¤äº’ç³»ç»Ÿ ---

window.setTool = function(tool) {
    currentTool = tool;
    document.querySelectorAll('button').forEach(b => b.classList.remove('active'));
    document.querySelector(`.btn-${tool}`).classList.add('active');
}

canvas.addEventListener('mousedown', (e) => {
    if (!game.started || game.gameOver) return;

    const rect = canvas.getBoundingClientRect();
    const x = Math.floor((e.clientX - rect.left) / TILE_SIZE);
    const y = Math.floor((e.clientY - rect.top) / TILE_SIZE);

    if (x < 0 || x >= GRID_W || y < 0 || y >= GRID_H) return;

    const currentTile = game.grid[y][x];

    // æ‹†é™¤é€»è¾‘
    if (currentTool === 'delete') {
        if (currentTile.type !== 'empty') {
            game.money += 10;
            // ç§»é™¤å»ºç­‘åˆ—è¡¨ä¸­çš„è®°å½•
            game.buildings = game.buildings.filter(b => !(b.x === x && b.y === y));
            
            // å¦‚æœæ‹†çš„æ˜¯å®¶ï¼Œäººå£ä¼šç«‹å³å‡å°‘ï¼ˆç®€åŒ–é€»è¾‘ï¼šç›´æ¥ç æ‰å¤´éƒ¨äººå£ï¼‰
            if (currentTile.type === 'house') {
                const lost = BUILDING_STATS.house.cap;
                game.population = Math.max(0, game.population - lost);
                game.popCap = Math.max(0, game.popCap - lost);
                game.agents.splice(0, lost); 
            }
            
            game.grid[y][x] = { type: 'empty' };
            showMessage("å»ºç­‘å·²æ‹†é™¤");
            updateUI();
        }
        return;
    }

    // å»ºé€ é€»è¾‘
    const stats = BUILDING_STATS[currentTool];
    
    if (currentTile.type !== 'empty') {
        showMessage("ğŸš« è¿™é‡Œå·²ç»æœ‰å»ºç­‘äº†");
        return;
    }
    
    if (game.money < stats.cost) {
        showMessage("ğŸ’¸ èµ„é‡‘ä¸è¶³ï¼éœ€è¦ $" + stats.cost);
        return;
    }

    // æ‰§è¡Œå»ºé€ 
    game.money -= stats.cost;
    game.grid[y][x] = { type: currentTool };
    game.buildings.push(new Building(x, y, currentTool));

    if (currentTool === 'house') {
        game.population += stats.cap;
        game.popCap += stats.cap;
        for(let i=0; i<stats.cap; i++) {
            game.agents.push(new Agent(x, y));
        }
    }

    updateUI();
});

function showMessage(msg) {
    const el = document.getElementById('message-area');
    el.innerText = msg;
    // ç®€å•çš„é˜²æŠ–ï¼Œæ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
    if(el.timer) clearTimeout(el.timer);
    el.timer = setTimeout(() => el.innerText = "", 2000);
}

// --- ç»æµå¾ªç¯ ---

function economyTick() {
    if (game.gameOver) return;

    let foodChange = 0;
    
    // 1. äººå£æ¶ˆè€—
    const consumption = Math.floor(game.population * game.consumptionRate);
    game.food -= consumption;
    foodChange -= consumption;

    // 2. å†œåœºäº§å‡º
    const farms = game.buildings.filter(b => b.type === 'farm');
    const production = farms.length * BUILDING_STATS.farm.foodProd;
    game.food += production;
    foodChange += production;

    // 3. è´¸æ˜“ä¸­å¿ƒè¿›å£ (è‡ªåŠ¨å¹³è¡¡ï¼šå¦‚æœé£Ÿç‰©å°‘äº 50 ä¸”æœ‰é’±ï¼Œå°±ä¹°)
    const industries = game.buildings.filter(b => b.type === 'industry');
    industries.forEach(() => {
        if (game.food < 50 && game.money >= BUILDING_STATS.industry.importCost) {
            game.money -= BUILDING_STATS.industry.importCost;
            game.food += BUILDING_STATS.industry.foodImport;
            foodChange += BUILDING_STATS.industry.foodImport;
        }
    });

    // 4. ç¨æ”¶
    const shops = game.buildings.filter(b => b.type === 'shop');
    // åªæœ‰å½“æœ‰å•†ä¸šåŒºæ—¶ï¼Œäººå£æ‰èƒ½äº§ç”Ÿç¨æ”¶(æ‰“å·¥)
    let income = 0;
    if (shops.length > 0) {
        income = (game.population * 1) + (shops.length * BUILDING_STATS.shop.income);
    }
    game.money += income;

    // åˆ¤å®šå¤±è´¥æ¡ä»¶
    if (game.food < 0) {
        game.food = 0;
        // é¥¥è’ï¼šéšæœºæ­»äº¡
        if (game.population > 0) {
            const deaths = Math.ceil(game.population * 0.1); // 10% æ­»äº¡ç‡
            game.population -= deaths;
            game.agents.splice(0, deaths);
            showMessage(`ğŸ’€ é¥¥è’ï¼${deaths} äººé¥¿æ­»äº†ï¼`);
        }
    }

    // ç®€å•çš„æ¸¸æˆç»“æŸåˆ¤æ–­
    if (game.population === 0 && game.money < 50 && game.buildings.length > 0) {
        // å¦‚æœæ²¡äººæ²¡é’±ï¼Œä½†å·²ç»å»ºè¿‡ä¸œè¥¿äº†ï¼Œç®—è¾“
        // è¿™é‡Œä¸åšå¼ºåˆ¶å¼¹çª—ç»“æŸï¼Œå…è®¸ç©å®¶æ‹†é™¤å›è¡€
        showMessage("âš ï¸ åŸå¸‚æ¿’ä¸´ç ´äº§ï¼è¯·æ‹†é™¤å»ºç­‘å›æ”¶èµ„é‡‘ï¼");
    }

    updateUI(foodChange);
}

function updateUI(balance) {
    document.getElementById('ui-money').innerText = `$${game.money}`;
    document.getElementById('ui-pop').innerText = Math.floor(game.population);
    document.getElementById('ui-cap').innerText = game.popCap;
    document.getElementById('ui-food').innerText = Math.floor(game.food);
    
    if (balance !== undefined) {
        const el = document.getElementById('ui-balance');
        const sign = balance >= 0 ? "+" : "";
        el.innerText = `${sign}${balance}/s`;
        el.style.color = balance >= 0 ? "#2ecc71" : "#e74c3c";
    }
}

// --- æ¸²æŸ“å¾ªç¯ ---

function gameLoop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // 1. ç»˜åˆ¶ç½‘æ ¼çº¿
    ctx.strokeStyle = 'rgba(255,255,255,0.05)';
    ctx.lineWidth = 1;
    for (let i = 0; i <= 600; i += TILE_SIZE) {
        ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, 600); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(600, i); ctx.stroke();
    }

    // 2. ç»˜åˆ¶è‡ªåŠ¨ç”Ÿæˆçš„é“è·¯ (Visual Only)
    ctx.strokeStyle = COLORS.road;
    ctx.lineWidth = 6;
    ctx.lineCap = 'round';
    ctx.beginPath();
    // ç®€å•çš„è¿æ¥ç®—æ³•ï¼šè¿æ¥æ‰€æœ‰è·ç¦»å°äº 3 æ ¼çš„å»ºç­‘
    for (let i = 0; i < game.buildings.length; i++) {
        for (let j = i + 1; j < game.buildings.length; j++) {
            const b1 = game.buildings[i];
            const b2 = game.buildings[j];
            const dist = Math.abs(b1.x - b2.x) + Math.abs(b1.y - b2.y);
            if (dist <= 3) {
                ctx.moveTo(b1.x * TILE_SIZE + TILE_SIZE/2, b1.y * TILE_SIZE + TILE_SIZE/2);
                ctx.lineTo(b2.x * TILE_SIZE + TILE_SIZE/2, b2.y * TILE_SIZE + TILE_SIZE/2);
            }
        }
    }
    ctx.stroke();

    // 3. ç»˜åˆ¶å»ºç­‘
    for (let b of game.buildings) {
        ctx.fillStyle = BUILDING_STATS[b.type].color;
        // å»ºç­‘ä¸»ä½“
        ctx.fillRect(b.x * TILE_SIZE + 4, b.y * TILE_SIZE + 4, TILE_SIZE - 8, TILE_SIZE - 8);
        
        // å»ºç­‘é¡¶éƒ¨çš„è£…é¥°
        ctx.fillStyle = "rgba(255,255,255,0.2)";
        ctx.fillRect(b.x * TILE_SIZE + 4, b.y * TILE_SIZE + 4, TILE_SIZE - 8, 5);
        
        // æ ‡ç­¾
        ctx.fillStyle = 'white';
        ctx.font = '10px Arial';
        ctx.textAlign = 'center';
        let label = b.type[0].toUpperCase();
        ctx.fillText(label, b.x * TILE_SIZE + TILE_SIZE/2, b.y * TILE_SIZE + 20);
    }

    // 4. æ›´æ–°å¹¶ç»˜åˆ¶å°äºº
    game.agents.forEach(agent => {
        agent.update();
        agent.draw(ctx);
    });

    if (!game.gameOver) {
        requestAnimationFrame(gameLoop);
    }
}
</script>
</body>
</html>
