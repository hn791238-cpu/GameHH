<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高阶社会演化模拟器 - 终极版</title>
    <style>
        :root { --bg: #020617; --card: rgba(15, 23, 42, 0.8); --accent: #38bdf8; }
        body { margin: 0; background: var(--bg); color: #f8fafc; font-family: system-ui, -apple-system, sans-serif; overflow: hidden; }
        #ui {
            position: absolute; top: 20px; left: 20px; width: 260px;
            padding: 20px; border-radius: 16px; background: var(--card);
            backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); pointer-events: none;
        }
        .stat-group { margin-bottom: 15px; }
        .stat-label { font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; }
        .stat-value { font-size: 1.25rem; font-weight: 600; color: var(--accent); }
        canvas { display: block; image-rendering: pixelated; }
    </style>
</head>
<body>

<div id="ui">
    <div style="font-weight:bold; margin-bottom:15px; border-bottom:1px solid #334155; padding-bottom:10px;">社会演化实时监控</div>
    <div class="stat-group">
        <div class="stat-label">总人口 (Agents)</div>
        <div id="pop" class="stat-value">0</div>
    </div>
    <div class="stat-group">
        <div class="stat-label">社会平均财富</div>
        <div id="wealth" class="stat-value">0</div>
    </div>
    <div class="stat-group">
        <div class="stat-label">群体饥饿预警</div>
        <div id="hunger-avg" class="stat-value">0%</div>
    </div>
</div>

<script>
/**
 * 核心配置与类定义
 */
const TILE = 24; // 每个网格像素大小
const WORLD = { cols: 0, rows: 0 };
const COLORS = { road: '#1e293b', home: '#2563eb', work: '#dc2626', shop: '#fbbf24', agent: '#fff' };

let canvas, ctx, grid = [], agents = [], buildings = { homes: [], works: [], shops: [] };

// 初始化系统
function init() {
    canvas = document.createElement('canvas');
    document.body.appendChild(canvas);
    ctx = canvas.getContext('2d');
    
    resize();
    createWorld();
    
    // 生成小人
    for(let i=0; i < 20; i++) {
        if(buildings.homes.length > 0) agents.push(new Agent());
    }
    
    requestAnimationFrame(loop);
}

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    WORLD.cols = Math.floor(canvas.width / TILE);
    WORLD.rows = Math.floor(canvas.height / TILE);
}

function createWorld() {
    // 1. 生成路网（简单的网格布局确保 100% 连通性）
    for (let x = 0; x < WORLD.cols; x++) {
        grid[x] = [];
        for (let y = 0; y < WORLD.rows; y++) {
            let isRoad = (x % 6 === 0 || y % 6 === 0);
            grid[x][y] = { x, y, type: isRoad ? 'road' : 'empty', walkable: isRoad };
        }
    }

    // 2. 填充建筑（必须紧邻道路）
    const types = ['home', 'work', 'shop'];
    for (let x = 1; x < WORLD.cols - 1; x++) {
        for (let y = 1; y < WORLD.rows - 1; y++) {
            if (grid[x][y].type === 'empty') {
                // 检查周围是否有路
                if (hasRoadNeighbor(x, y)) {
                    let rand = Math.random();
                    let type = rand < 0.1 ? 'home' : (rand < 0.18 ? 'work' : (rand < 0.22 ? 'shop' : 'empty'));
                    if (type !== 'empty') {
                        grid[x][y].type = type;
                        buildings[type + 's'].push(grid[x][y]);
                    }
                }
            }
        }
    }
}

function hasRoadNeighbor(x, y) {
    return grid[x+1][y]?.type === 'road' || grid[x-1][y]?.type === 'road' || 
           grid[x][y+1]?.type === 'road' || grid[x][y-1]?.type === 'road';
}

// 高效 A* 寻路
function findPath(start, end) {
    let open = [start], cameFrom = new Map(), gScore = new Map();
    const id = p => `${p.x},${p.y}`;
    gScore.set(id(start), 0);

    while (open.length > 0) {
        open.sort((a, b) => gScore.get(id(a)) - gScore.get(id(b)));
        let curr = open.shift();

        if (curr.x === end.x && curr.y === end.y) {
            let path = [];
            while(curr) { path.push(curr); curr = cameFrom.get(id(curr)); }
            return path.reverse();
        }

        const dirs = [{x:0,y:1},{x:0,y:-1},{x:1,y:0},{x:-1,y:0}];
        for(let d of dirs) {
            let nx = curr.x + d.x, ny = curr.y + d.y;
            if(nx<0||nx>=WORLD.cols||ny<0||ny>=WORLD.rows) continue;
            let neighbor = grid[nx][ny];
            if(!neighbor.walkable && !(nx === end.x && ny === end.y)) continue;

            let score = gScore.get(id(curr)) + 1;
            if(score < (gScore.get(id(neighbor)) ?? Infinity)) {
                cameFrom.set(id(neighbor), curr);
                gScore.set(id(neighbor), score);
                if(!open.includes(neighbor)) open.push(neighbor);
            }
        }
    }
    return null;
}

// 小人逻辑类
class Agent {
    constructor() {
        this.home = buildings.homes[Math.floor(Math.random() * buildings.homes.length)];
        this.x = this.home.x; this.y = this.home.y;
        this.money = 50; this.energy = 100; this.hunger = 100;
        this.path = []; this.state = 'IDLE';
        this.color = `hsl(${Math.random()*360}, 70%, 60%)`;
    }

    update() {
        this.hunger -= 0.04; this.energy -= 0.02;

        if (this.state === 'IDLE') {
            // 决策逻辑
            if (this.hunger < 40 && this.money > 20) this.goal('shop', 'EATING');
            else if (this.energy < 30) this.goal('home', 'SLEEPING');
            else this.goal('work', 'WORKING');
        }

        if (this.state === 'MOVING' && this.path.length > 0) {
            let step = this.path.shift();
            this.x = step.x; this.y = step.y;
            if (this.path.length === 0) {
                this.state = this.nextTask;
                this.timer = 100;
            }
        } else if (this.state !== 'IDLE' && this.state !== 'MOVING') {
            this.timer--;
            if (this.state === 'WORKING') { this.money += 0.5; this.energy -= 0.1; }
            if (this.state === 'EATING') { this.hunger += 1; this.money -= 0.3; }
            if (this.state === 'SLEEPING') { this.energy += 0.8; }
            if (this.timer <= 0 || this.hunger >= 100 || this.energy >= 100) this.state = 'IDLE';
        }
    }

    goal(type, next) {
        let targets = type === 'home' ? [this.home] : buildings[type + 's'];
        let target = targets[Math.floor(Math.random() * targets.length)];
        this.path = findPath(grid[this.x][this.y], target) || [];
        if(this.path.length > 0) { this.state = 'MOVING'; this.nextTask = next; }
    }

    draw() {
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.arc(this.x * TILE + TILE/2, this.y * TILE + TILE/2, TILE/3, 0, Math.PI*2);
        ctx.fill();
    }
}

function loop() {
    ctx.fillStyle = COLORS.bg;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // 绘制地图
    for(let x=0; x<WORLD.cols; x++) {
        for(let y=0; y<WORLD.rows; y++) {
            let t = grid[x][y].type;
            if(t === 'empty') continue;
            ctx.fillStyle = COLORS[t];
            ctx.fillRect(x*TILE+1, y*TILE+1, TILE-2, TILE-2);
        }
    }

    // 绘制与更新小人
    let mSum = 0, hSum = 0;
    agents.forEach(a => {
        a.update();
        a.draw();
        mSum += a.money; hSum += a.hunger;
    });

    // 更新UI
    document.getElementById('pop').innerText = agents.length;
    document.getElementById('wealth').innerText = '￥' + Math.floor(mSum / agents.length || 0);
    document.getElementById('hunger-avg').innerText = Math.floor(hSum / agents.length || 0) + '%';

    requestAnimationFrame(loop);
}

window.onload = init;
</script>
</body>
</html>
