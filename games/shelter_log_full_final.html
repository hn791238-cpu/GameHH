<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>末日文字Roguelike：避难所日志</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#111a24;
      --panel2:#0f1720;
      --text:#d7e2ee;
      --muted:#8fa3b8;
      --good:#5ee28b;
      --bad:#ff5f6d;
      --warn:#ffd166;
      --accent:#62a7ff;
      --border: rgba(255,255,255,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 30% 10%, rgba(98,167,255,.12), transparent 60%),
                  radial-gradient(900px 600px at 70% 0%, rgba(94,226,139,.10), transparent 55%),
                  var(--bg);
      color: var(--text);
      font-family: var(--sans);
      line-height:1.25;
    }
    header{
      padding:18px 16px 10px;
      max-width: 1100px;
      margin: 0 auto;
    }
    h1{
      margin:0;
      font-size: 18px;
      letter-spacing:.4px;
      color:#e9f2ff;
    }
    .sub{
      margin-top:6px;
      color: var(--muted);
      font-size: 12px;
    }
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding: 12px 16px 26px;
      display:grid;
      grid-template-columns: 340px 1fr;
      gap: 14px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 14px;
      background: rgba(255,255,255,.03);
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .card .hd .t{
      font-weight:650;
      font-size: 13px;
      color:#e9f2ff;
    }
    .badge{
      font-family: var(--mono);
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid var(--border);
      color: var(--muted);
      background: rgba(255,255,255,.02);
      white-space:nowrap;
    }
    .content{ padding: 12px 14px 14px; }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .stat{
      padding: 10px 10px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.15);
    }
    .stat.low .v span{ color: var(--warn); }
    .stat.zero .v span{ color: var(--bad); }
    .stat .k{ color: var(--muted); font-size: 11px; }
    .stat .v{
      margin-top:6px;
      font-family: var(--mono);
      font-size: 16px;
      display:flex;
      align-items:baseline;
      gap:8px;
    }
    .delta{
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border:1px solid var(--border);
      color: var(--muted);
    }
    .delta.good{ color: var(--good); border-color: rgba(94,226,139,.25); background: rgba(94,226,139,.08);}
    .delta.bad{ color: var(--bad); border-color: rgba(255,95,109,.25); background: rgba(255,95,109,.08);}
    .delta.warn{ color: var(--warn); border-color: rgba(255,209,102,.25); background: rgba(255,209,102,.08);}

    .list{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .pill{
      font-size: 11px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
      color: var(--text);
      padding: 6px 8px;
      border-radius: 999px;
      max-width: 100%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pill.muted{ color: var(--muted); }
    .pill.accent{ border-color: rgba(98,167,255,.35); background: rgba(98,167,255,.08); }
    .pill.good{ border-color: rgba(94,226,139,.35); background: rgba(94,226,139,.08); }
    .pill.warn{ border-color: rgba(255,209,102,.35); background: rgba(255,209,102,.08); }
    .pill.bad{ border-color: rgba(255,95,109,.35); background: rgba(255,95,109,.08); }

    .log{
      height: 430px;
      overflow:auto;
      padding: 10px 14px 14px;
      background: rgba(0,0,0,.16);
    }
    .entry{
      padding: 10px 10px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
      margin: 10px 0;
    }
    .entry .meta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color: var(--muted);
      font-size: 11px;
      font-family: var(--mono);
    }
    .entry .text{ margin-top: 8px; font-size: 13px; color: var(--text); }
    .entry .opts{
      margin-top: 10px;
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
    }
    button{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 9px 10px;
      border-radius: 12px;
      font-size: 12px;
      cursor:pointer;
      transition: transform .06s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    button:hover{
      background: rgba(255,255,255,.07);
      border-color: rgba(255,255,255,.14);
    }
    button:active{ transform: translateY(1px); }
    button.primary{
      border-color: rgba(98,167,255,.35);
      background: rgba(98,167,255,.10);
    }
    button.danger{
      border-color: rgba(255,95,109,.35);
      background: rgba(255,95,109,.09);
    }
    button.good{
      border-color: rgba(94,226,139,.35);
      background: rgba(94,226,139,.09);
    }
    button:disabled{
      cursor:not-allowed;
      opacity:.55;
      transform:none;
    }

    .row{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      align-items:center;
    }
    .small{
      font-size: 11px;
      color: var(--muted);
    }
    .divider{
      height:1px;
      background: var(--border);
      margin: 12px 0;
    }

    .footerbar{
      padding: 10px 14px;
      border-top:1px solid var(--border);
      background: rgba(255,255,255,.02);
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      justify-content:space-between;
      align-items:center;
    }
    .kbd{
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted);
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      padding: 3px 7px;
      border-radius: 8px;
    }
    @media (max-width: 920px){
      .wrap{ grid-template-columns: 1fr; }
      .log{ height: 420px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>避难所日志（文字Roguelike）</h1>
    <div class="sub">随机事件 + 随机奖励 + 资源管理。每回合做关键选择，活下去。</div>
  </header>

  <div class="wrap">
    <!-- LEFT: STATS -->
    <div class="card">
      <div class="hd">
        <div class="t">状态面板</div>
        <div class="badge" id="seedBadge">seed: -</div>
      </div>
      <div class="content">
        <div class="grid2" id="statsGrid"></div>

        <div class="small" id="consumeLine" style="margin-top:10px;"></div>

        <div class="divider"></div>

        <div class="row">
          <span class="pill muted">特性</span>
          <span class="small">（每局不同，影响事件与收益）</span>
        </div>
        <div class="list" id="traitsList"></div>

        <div class="divider"></div>

        <div class="row">
          <button class="primary" id="btnNext">下一天：触发随机事件</button>
          <button id="btnRest">休整</button>
          <button id="btnCraft">制造</button>
          <button id="btnUpgrade">升级</button>
        </div>

        <div class="divider"></div>

        <div class="row">
          <button class="danger" id="btnNewRun">新开一局</button>
          <button id="btnSave">导出存档</button>
          <button id="btnLoad">导入存档</button>
        </div>
        <div class="small" style="margin-top:8px;">
          小提示：<span class="kbd">N</span> 下一天，<span class="kbd">R</span> 休整，<span class="kbd">C</span> 制造，<span class="kbd">U</span> 升级
        </div>
      </div>
    </div>

    <!-- RIGHT: LOG -->
    <div class="card">
      <div class="hd">
        <div class="t">事件日志</div>
        <div class="badge" id="runBadge">Day 1</div>
      </div>
      <div class="log" id="log"></div>
      <div class="footerbar">
        <div class="row">
          <span class="pill accent" id="threatPill">威胁：0</span>
          <span class="pill" id="zombiePill">僵尸进度：-</span>
        </div>
        <div class="row small" id="hintLine">做选择会改变资源与威胁，威胁越高，事件越凶。</div>
      </div>
    </div>
  </div>

<script>
(() => {
  // -----------------------------
  // RNG (seeded)
  // -----------------------------
  function mulberry32(a){
    return function(){
      let t = a += 0x6D2B79F5;
      t = Math.imul(t ^ (t >>> 15), t | 1);
      t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    };
  }
  function hashSeed(str){
    // simple string hash -> uint32
    let h = 2166136261 >>> 0;
    for (let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }

  // -----------------------------
  // Game State
  // -----------------------------
  const DEFAULTS = () => ({
    seedText: randomSeedText(),
    day: 1,
    hp: 20,
    maxHp: 20,
    morale: 10,
    maxMorale: 20,

    food: 8,
    water: 8,
    ammo: 6,
    med: 2,
    scrap: 4,

    threat: 0,      // increases difficulty
    zone: 1,        // "distance" / stage
    traits: [],
    inventory: [],  // future extension
    flags: {},

    pendingChoice: null, // if an event is waiting for player choice
    lastDelta: {}
  });

  let state = DEFAULTS();
  let rng = mulberry32(hashSeed(state.seedText));
  const $ = (id) => document.getElementById(id);

  // -----------------------------
  // Content Pools
  // -----------------------------
  const TRAITS = [
    {
      id:"scavenger",
      name:"拾荒者",
      desc:"搜刮更容易出货（+10% 资源收益）",
      mod:(ctx)=>{ ctx.lootMult *= 1.10; }
    },
    {
      id:"medic",
      name:"急救员",
      desc:"医疗效率更高（医疗/休整回血 +1）",
      mod:(ctx)=>{ ctx.restHeal += 1; ctx.medHeal += 1; }
    },
    {
      id:"sharpshooter",
      name:"神枪手",
      desc:"战斗更省弹（战斗弹药消耗 -1 最低0）",
      mod:(ctx)=>{ ctx.combatAmmoDiscount += 1; }
    },
    {
      id:"paranoid",
      name:"多疑",
      desc:"更难被偷袭（陷阱/伏击伤害 -20%）",
      mod:(ctx)=>{ ctx.ambushDmgMult *= 0.8; }
    },
    {
      id:"tinkerer",
      name:"修理匠",
      desc:"制造更划算（制造消耗废料 -1 最低0）",
      mod:(ctx)=>{ ctx.craftScrapDiscount += 1; }
    },
    {
      id:"runner",
      name:"跑得快",
      desc:"逃跑更容易（逃跑成功率 +20%）",
      mod:(ctx)=>{ ctx.escapeBonus += 0.20; }
    },
  ];

  function randomSeedText(){
    const a = ["WASTELAND","SHELTER","DUST","NIGHT","HUNGER","STATIC","ECHO","RUST"];
    const b = Math.floor(Math.random()*9999).toString().padStart(4,"0");
    return a[Math.floor(Math.random()*a.length)] + "-" + b;
  }

  const EVENT_TEMPLATES = [
    {
      type:"scavenge",
      title:"废墟超市",
      intro:"你发现一间被洗劫过的超市，货架下还有些东西。",
      options:(ctx)=>[
        {
          text:"谨慎搜刮（低风险）",
          resolve:()=> scavenge(ctx, {risk:"low"})
        },
        {
          text:"深入后仓（高收益/高风险）",
          resolve:()=> scavenge(ctx, {risk:"high"})
        },
        {
          text:"放弃，继续前进",
          resolve:()=> endTurn({log:"你决定不冒险。", delta:{morale:+0}})
        }
      ]
    },
    {
      type:"combat",
      title:"街角尸群",
      intro:"远处传来拖行声，一小群感染者挡住了路线。",
      options:(ctx)=>[
        {
          text:`开火清路（耗弹）`,
          resolve:()=> combat(ctx, {style:"shoot"})
        },
        {
          text:`绕路潜行（耗时间/概率失败）`,
          resolve:()=> combat(ctx, {style:"sneak"})
        },
        {
          text:`硬跑（高概率受伤）`,
          resolve:()=> combat(ctx, {style:"run"})
        }
      ]
    },
    {
      type:"trade",
      title:"流浪商人",
      intro:"一个戴防毒面具的人从阴影里出现：'换点东西？'",
      options:(ctx)=>[
        {
          text:"用废料换食物（2废料→3食物）",
          req:()=> state.scrap >= 2,
          resolve:()=> trade({scrap:-2, food:+3}, "你用废料换到了罐头。")
        },
        {
          text:"用弹药换医疗（3弹→1医疗）",
          req:()=> state.ammo >= 3,
          resolve:()=> trade({ammo:-3, med:+1}, "他递来一支止血针。")
        },
        {
          text:"打劫他（高风险高回报）",
          resolve:()=> mug(ctx)
        }
      ]
    },
    {
      type:"weather",
      title:"酸雨",
      intro:"天空发绿，酸雨落下。暴露在外会灼伤皮肤。",
      options:(ctx)=>[
        {
          text:"就地找掩体（消耗水/士气）",
          resolve:()=> weather(ctx, {choice:"shelter"})
        },
        {
          text:"硬顶着赶路（受伤/加威胁）",
          resolve:()=> weather(ctx, {choice:"push"})
        }
      ]
    },
    {
      type:"trap",
      title:"地雷区",
      intro:"你看到地面有不自然的凸起——有人布了雷。",
      options:(ctx)=>[
        {
          text:"慢慢排雷（耗时但安全）",
          resolve:()=> trap(ctx, {choice:"disarm"})
        },
        {
          text:"赌一把冲过去（概率受伤）",
          resolve:()=> trap(ctx, {choice:"dash"})
        }
      ]
    },
  ];

  const UPGRADE_POOL = [
    {
      id:"maxhp",
      name:"+3 最大生命",
      desc:"更抗揍。",
      apply:()=> { state.maxHp += 3; state.hp += 3; }
    },
    {
      id:"maxmorale",
      name:"+4 最大士气",
      desc:"更稳。",
      apply:()=> { state.maxMorale += 4; state.morale += 2; }
    },
    {
      id:"findWater",
      name:"净水技巧",
      desc:"每天消耗水 -1（最低1）。",
      apply:()=> { state.flags.waterSaver = true; }
    },
    {
      id:"ammoSmith",
      name:"简易压弹",
      desc:"制造：1废料→+2弹药。",
      apply:()=> { state.flags.ammoCraft = true; }
    },
    {
      id:"quietSteps",
      name:"无声脚步",
      desc:"潜行成功率 +15%。",
      apply:()=> { state.flags.sneakBonus = (state.flags.sneakBonus||0) + 0.15; }
    },
    {
      id:"lucky",
      name:"好运",
      desc:"所有随机奖励小幅偏向正面。",
      apply:()=> { state.flags.lucky = true; }
    }
  ];

  // -----------------------------
  // Utility
  // -----------------------------
  function r(){
    return rng();
  }
  function ri(n){
    return Math.floor(r()*n);
  }
  function pick(arr){
    return arr[ri(arr.length)];
  }
  function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }

  function ctxBase(){
    const ctx = {
      lootMult: 1,
      restHeal: 2,
      medHeal: 5,
      ambushDmgMult: 1,
      combatAmmoDiscount: 0,
      craftScrapDiscount: 0,
      escapeBonus: 0,
      sneakBonus: (state.flags.sneakBonus||0),
      lucky: !!state.flags.lucky
    };
    // apply traits
    for (const t of state.traits){
      const trait = TRAITS.find(x=>x.id===t.id);
      if (trait?.mod) trait.mod(ctx);
    }
    return ctx;
  }

  function logEntry(text, meta=""){
    const log = $("log");
    const el = document.createElement("div");
    el.className = "entry";
    const m = document.createElement("div");
    m.className = "meta";
    m.innerHTML = `<span>${meta || ("Day " + state.day)}</span><span>${new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"})}</span>`;
    const t = document.createElement("div");
    t.className = "text";
    t.textContent = text;
    el.appendChild(m);
    el.appendChild(t);
    log.appendChild(el);
    log.scrollTop = log.scrollHeight;
    return el;
  }

  function logEventCard(title, intro, options){
    const el = logEntry(`${title}：${intro}`, `Day ${state.day} / 事件`);
    const opts = document.createElement("div");
    opts.className = "opts";
    options.forEach((o, idx)=>{
      const b = document.createElement("button");
      b.textContent = o.text;
      const ok = o.req ? !!o.req() : true;
      b.disabled = !ok;
      if (o.kind==="primary") b.classList.add("primary");
      if (o.kind==="danger") b.classList.add("danger");
      if (o.kind==="good") b.classList.add("good");
      b.onclick = () => {
        if (state.pendingChoice && state.pendingChoice !== el) return;
        state.pendingChoice = null;
        b.blur();
        // disable all buttons in this card after choice
        [...opts.querySelectorAll("button")].forEach(x=>x.disabled=true);
        o.resolve();
      };
      opts.appendChild(b);
    });
    el.appendChild(opts);
    state.pendingChoice = el;
  }

  function applyDelta(delta){
    // Record last delta for UI
    state.lastDelta = delta || {};
    const d = delta || {};
    for (const [k,v] of Object.entries(d)){
      if (typeof state[k] !== "number") continue;
      state[k] += v;
    }
    // clamps
    state.hp = clamp(state.hp, 0, state.maxHp);
    state.morale = clamp(state.morale, 0, state.maxMorale);
    state.food = Math.max(0, state.food);
    state.water = Math.max(0, state.water);
    state.ammo = Math.max(0, state.ammo);
    state.med = Math.max(0, state.med);
    state.scrap = Math.max(0, state.scrap);
    state.threat = Math.max(0, state.threat);

    if (state.hp <= 0 || state.morale <= 0){
      gameOver();
    }
  }

  function endTurn({log, delta, meta}){
    if (log) logEntry(log, meta || `Day ${state.day} / 结果`);
    if (delta) applyDelta(delta);

    // daily consumption (with visible penalty when short)
    const waterCost = state.flags.waterSaver ? 1 : 2;
    const foodCost = 2;

    // apply consumption manually so we can detect shortages BEFORE clamping
    state.lastDelta = state.lastDelta || {};
    state.water -= waterCost;
    state.food  -= foodCost;
    state.lastDelta.water = (state.lastDelta.water || 0) - waterCost;
    state.lastDelta.food  = (state.lastDelta.food  || 0) - foodCost;

    let hpPenalty = 0;
    if (state.food < 0){
      const miss = -state.food;
      state.food = 0;
      hpPenalty += miss; // -1 HP per missing food
      logEntry(`食物不足，你挨饿受损（-${miss} 生命）。`, `Day ${state.day} / 饥饿`);
    }
    if (state.water < 0){
      const miss = -state.water;
      state.water = 0;
      const dmg = miss * 2; // -2 HP per missing water
      hpPenalty += dmg;
      logEntry(`水不足，你严重脱水（-${dmg} 生命）。`, `Day ${state.day} / 脱水`);
    }
    if (hpPenalty > 0){
      state.hp -= hpPenalty;
      state.lastDelta.hp = (state.lastDelta.hp || 0) - hpPenalty;
      state.hp = clamp(state.hp, 0, state.maxHp);
      if (state.hp <= 0){ gameOver(); return; }
    }

    // threat drifts upward over time
    applyDelta({ threat: + (state.day % 2 === 0 ? 1 : 0) });

    // day advance
    state.day += 1;
    if (state.day % 5 === 0) state.zone += 1;

    render();
  }

  function luckBias(){
    // if lucky, reduce chance of worst outcomes a bit
    return state.flags.lucky ? 0.08 : 0;
  }

  // -----------------------------
  // Event Resolvers
  // -----------------------------
  function scavenge(ctx, {risk}){
    const base = risk==="high" ? 6 : 4;
    const variance = risk==="high" ? 8 : 5;

    // risk check
    const danger = (risk==="high" ? 0.35 : 0.18) + state.threat*0.02;
    const dangerRoll = r();
    const hit = dangerRoll < (danger - luckBias());

    const loot = Math.max(1, Math.floor((base + ri(variance)) * ctx.lootMult));
    const gain = splitLoot(loot);

    if (!hit){
      endTurn({
        log:`你搜到了可用物资：${formatGain(gain)}。`,
        delta: { ...gain, morale:+1, threat:+ (risk==="high" ? 1 : 0) }
      });
    } else {
      const dmg = Math.ceil((risk==="high"?6:4) * (0.6 + r()*0.8) * ctx.ambushDmgMult);
      endTurn({
        log:`你翻柜子时触发了响动！一只感染者扑来，你受伤（-${dmg} 生命），但仍带走了物资：${formatGain(gain)}。`,
        delta: { ...gain, hp:-dmg, morale:-1, threat:+2 }
      });
    }
  }

  function splitLoot(points){
    // distribute points into resources
    const buckets = ["food","water","ammo","scrap","med"];
    const gain = {food:0, water:0, ammo:0, scrap:0, med:0};
    for (let i=0;i<points;i++){
      const k = pick(buckets);
      gain[k] += 1;
    }
    // med rarer
    if (gain.med > 2) { gain.scrap += (gain.med-2); gain.med = 2; }
    return gain;
  }

  function formatGain(g){
    const parts = [];
    for (const k of ["food","water","ammo","med","scrap"]){
      if ((g[k]||0) > 0) parts.push(`${nameOf(k)}+${g[k]}`);
    }
    return parts.join("，") || "无";
  }

  function nameOf(k){
    return ({
      hp:"生命",
      morale:"士气",
      food:"食物",
      water:"水",
      ammo:"弹药",
      med:"医疗",
      scrap:"废料",
      threat:"威胁",
      zone:"区域"
    })[k] || k;
  }

  function combat(ctx, {style}){
    const enemy = 6 + state.zone*2 + Math.floor(state.threat*0.6);
    const sneakRate = clamp(0.45 + ctx.sneakBonus - state.threat*0.03, 0.08, 0.85);
    const escapeRate = clamp(0.35 + ctx.escapeBonus - state.threat*0.02, 0.05, 0.8);

    if (style==="shoot"){
      const needAmmo = Math.max(0, Math.ceil(enemy/3) - ctx.combatAmmoDiscount);
      if (state.ammo < needAmmo){
        endTurn({
          log:`你想开火，但弹药不够（需要${needAmmo}）。你被迫撤退，士气下降。`,
          delta:{ morale:-2, threat:+1 }
        });
        return;
      }
      const hurt = Math.max(0, Math.floor((enemy/6) * (r()<0.5?1:2)));
      const loot = splitLoot(3 + ri(4));
      endTurn({
        log:`你消耗${needAmmo}弹清理了尸群。你${hurt>0?`受了点伤（-${hurt}）`:"几乎毫发无损"}，并搜到：${formatGain(loot)}。`,
        delta:{ ammo:-needAmmo, hp:-hurt, ...loot, morale:+1, threat:+1 }
      });
      return;
    }

    if (style==="sneak"){
      const ok = r() < (sneakRate + luckBias());
      if (ok){
        endTurn({
          log:`你压低呼吸，从阴影里绕开了尸群。虽然慢，但安全。`,
          delta:{ morale:+1, threat:+0 }
        });
      } else {
        const dmg = Math.ceil((4 + state.zone) * (0.8 + r()*0.6));
        endTurn({
          log:`你潜行失败！被突然袭击，慌乱撤退（-${dmg} 生命）。`,
          delta:{ hp:-dmg, morale:-1, threat:+2 }
        });
      }
      return;
    }

    if (style==="run"){
      const ok = r() < (escapeRate + luckBias());
      if (ok){
        endTurn({
          log:`你拔腿就跑，鞋底拍打积水声在巷子里回响，但你甩开了它们。`,
          delta:{ morale:+0, threat:+1 }
        });
      } else {
        const dmg = Math.ceil((6 + state.zone*2) * (0.9 + r()*0.6));
        endTurn({
          log:`你没跑掉，被抓伤（-${dmg} 生命）。你狼狈逃离，威胁上升。`,
          delta:{ hp:-dmg, morale:-2, threat:+3 }
        });
      }
      return;
    }
  }

  function trade(delta, text){
    endTurn({
      log: text,
      delta: { ...delta, morale:+1, threat:+0 }
    });
  }

  function mug(ctx){
    // high variance outcome
    const risk = 0.45 + state.threat*0.02;
    const bad = r() < (risk - luckBias());
    if (!bad){
      const loot = { food: 2+ri(3), water: 1+ri(3), ammo: 1+ri(3), scrap: 1+ri(3) };
      endTurn({
        log:`你成功压制了商人，夺走了补给：${formatGain(loot)}。但这事会传出去。`,
        delta:{ ...loot, morale:+1, threat:+4 }
      });
    } else {
      const dmg = Math.ceil((7 + state.zone) * (0.9 + r()*0.7) * ctx.ambushDmgMult);
      endTurn({
        log:`商人早有准备！你被反击（-${dmg} 生命），还丢了点物资。`,
        delta:{ hp:-dmg, food:-2, water:-1, morale:-2, threat:+5 }
      });
    }
  }

  function weather(ctx, {choice}){
    if (choice==="shelter"){
      endTurn({
        log:`你躲进一辆翻倒的公交车里等雨停。闷热、口渴、心烦。`,
        delta:{ water:-1, morale:-1, threat:+0 }
      });
    } else {
      const dmg = Math.ceil((3 + state.zone) * (0.7 + r()*0.8));
      endTurn({
        log:`你顶着酸雨赶路，皮肤刺痛（-${dmg} 生命）。但你推进了路线。`,
        delta:{ hp:-dmg, threat:+2, morale:+0 }
      });
    }
  }

  function trap(ctx, {choice}){
    if (choice==="disarm"){
      const ok = r() < (0.72 - state.threat*0.02 + luckBias());
      if (ok){
        const scrap = 2 + ri(3);
        endTurn({
          log:`你成功排雷，还拆到一些零件（废料+${scrap}）。`,
          delta:{ scrap:+scrap, morale:+1, threat:+1 }
        });
      } else {
        const dmg = Math.ceil((5 + state.zone) * (0.8 + r()*0.8) * ctx.ambushDmgMult);
        endTurn({
          log:`排雷失误！爆炸把你掀翻（-${dmg} 生命）。`,
          delta:{ hp:-dmg, morale:-2, threat:+3 }
        });
      }
    } else {
      const dmg = (r() < (0.45 + state.threat*0.02 - luckBias()))
        ? Math.ceil((6 + state.zone) * (0.9 + r()*0.8) * ctx.ambushDmgMult)
        : 0;
      endTurn({
        log:`你冲了过去。${dmg>0?`还是踩到了一枚（-${dmg} 生命）`:"侥幸没事"}。`,
        delta:{ hp:-dmg, morale: (dmg>0?-1:+1), threat:+2 }
      });
    }
  }

  // -----------------------------
  // Actions: Rest / Craft / Upgrade
  // -----------------------------
  function doRest(){
    if (state.pendingChoice) return;
    const ctx = ctxBase();
    const heal = ctx.restHeal;
    const morale = 2;
    endTurn({
      log:`你在废楼里睡了个浅觉，稍微恢复了状态（生命+${heal}，士气+${morale}）。`,
      delta:{ hp:+heal, morale:+morale, threat:+0 }
    });
  }

  function doCraft(){
    if (state.pendingChoice) return;
    const ctx = ctxBase();

    const recipes = [
      {
        name: "制造弹药",
        cost: { scrap: Math.max(0, 2 - ctx.craftScrapDiscount) },
        gain: { ammo: state.flags.ammoCraft ? 6 : 5 },
        kind: "good",
        desc: "把零件压成可用子弹"
      },
      {
        name: "简易医疗包",
        cost: { scrap: Math.max(0, 3 - ctx.craftScrapDiscount) },
        gain: { med: 2 },
        kind: "good",
        desc: "止血、消毒、固定"
      },
      {
        name: "应急口粮",
        cost: { scrap: Math.max(0, 1 - ctx.craftScrapDiscount) },
        gain: { food: 4 },
        kind: "good",
        desc: "热量补给"
      }
    ];

    logEventCard(
      "制造",
      `你整理了一下零件。当前废料：${state.scrap}`,
      [
        ...recipes.map(r => ({
          text: `${r.name}（消耗：${Object.entries(r.cost).map(([k,v])=>`${nameOf(k)}-${v}`).join("，")} → 获得：${formatGain(r.gain)}）`,
          kind: r.kind,
          req: () => Object.entries(r.cost).every(([k,v]) => state[k] >= v),
          resolve: () => {
            // 不消耗天数：不调用 endTurn，只更新资源并立刻刷新
            applyDelta({ ...Object.fromEntries(Object.entries(r.cost).map(([k,v]) => [k, -v])), ...r.gain, morale:+1 });
            logEntry(`你制造了【${r.name}】。`, `Day ${state.day} / 制造`);
            render();
          }
        })),
        {
          text: "取消（不制造）",
          kind: "primary",
          resolve: () => { logEntry("你决定先不制造。", `Day ${state.day} / 制造`); render(); }
        }
      ]
    );
  }

  function doUpgrade(){
    if (state.pendingChoice) return;
    // upgrade costs morale + scrap, but gives random upgrade
    const costScrap = 3;
    const costMorale = 2;
    if (state.scrap < costScrap || state.morale < costMorale){
      logEntry(`升级需要废料${costScrap}和士气${costMorale}。你现在不够。`, `Day ${state.day} / 升级`);
      render();
      return;
    }

    // pick 3 random upgrades to choose
    const pool = shuffle([...UPGRADE_POOL]).slice(0,3);
    const ctx = ctxBase();

    logEventCard("升级选择", "你把废料摊开，开始改造装备。选一个。", pool.map(up => ({
      text:`${up.name} — ${up.desc}`,
      kind:"primary",
      resolve:()=>{
        applyDelta({ scrap:-costScrap, morale:-costMorale });
        up.apply();
        logEntry(`你获得升级：${up.name}。`, `Day ${state.day} / 升级`);
        // upgrades raise threat slightly (noise / attention)
        endTurn({ log:"改造完成，你继续行动。", delta:{ threat:+1 }, meta:`Day ${state.day} / 结果` });
      }
    })));
  }

  // -----------------------------
  // Turn: Next Event
  // -----------------------------
  function nextDayEvent(){
    if (state.pendingChoice) return;

    const ctx = ctxBase();

    // Pick event with weights depending on threat/zone
    const weights = EVENT_TEMPLATES.map(e=>{
      let w = 1;
      if (e.type==="combat") w += state.threat*0.25 + state.zone*0.2;
      if (e.type==="scavenge") w += 0.6;
      if (e.type==="trade") w += Math.max(0, 0.8 - state.threat*0.08);
      if (e.type==="trap") w += state.threat*0.2;
      if (e.type==="weather") w += 0.3 + state.zone*0.1;
      return w;
    });

    const ev = weightedPick(EVENT_TEMPLATES, weights);
    const options = ev.options(ctx);

    logEventCard(ev.title, ev.intro, options);
    render();
  }

  function weightedPick(items, weights){
    const total = weights.reduce((a,b)=>a+b,0);
    let x = r()*total;
    for (let i=0;i<items.length;i++){
      x -= weights[i];
      if (x <= 0) return items[i];
    }
    return items[items.length-1];
  }

  function shuffle(arr){
    for (let i=arr.length-1;i>0;i--){
      const j = Math.floor(r()*(i+1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  // -----------------------------
  // Zombie progress UI (flavor)
  // -----------------------------
  function zombieStatus(){
    // purely UI flavor: based on day+threat
    const p = clamp((state.day*1.8 + state.threat*3) / 100, 0, 1);
    const pct = Math.floor(p*100);
    let stage = "低";
    let impact = "零星感染者活动。";
    if (pct >= 25){ stage="中"; impact="街区危险显著上升。"; }
    if (pct >= 50){ stage="高"; impact="成群游荡，补给点变少。"; }
    if (pct >= 75){ stage="极高"; impact="大范围失守，战斗频繁。"; }
    return { pct, stage, impact };
  }

  // -----------------------------
  // UI Rendering
  // -----------------------------
  function render(){
    $("seedBadge").textContent = "seed: " + state.seedText;
    $("runBadge").textContent = `Day ${state.day} · Zone ${state.zone}`;
    $("threatPill").textContent = `威胁：${state.threat}`;

    const z = zombieStatus();
    $("zombiePill").textContent = `僵尸进度：${z.pct}%（${z.stage}）`;
    $("hintLine").textContent = z.impact;

    const waterCost = state.flags.waterSaver ? 1 : 2;
    const foodCost = 2;
    const warnFood = state.food < foodCost;
    const warnWater = state.water < waterCost;
    const consumeMsg = `每日消耗：食物 ${foodCost} / 水 ${waterCost}` + (warnFood || warnWater ? `  ⚠ 明天可能缺${warnFood?"食物":""}${warnFood&&warnWater?"和":""}${warnWater?"水":""}` : "");
    const consumeEl = $("consumeLine");
    if (consumeEl) consumeEl.textContent = consumeMsg;

    const stats = [
      {k:"生命", v:`${state.hp}/${state.maxHp}`, key:"hp"},
      {k:"士气", v:`${state.morale}/${state.maxMorale}`, key:"morale"},
      {k:"食物", v:state.food, key:"food"},
      {k:"水", v:state.water, key:"water"},
      {k:"弹药", v:state.ammo, key:"ammo"},
      {k:"医疗", v:state.med, key:"med"},
      {k:"废料", v:state.scrap, key:"scrap"},
      {k:"威胁", v:state.threat, key:"threat"},
    ];

    const grid = $("statsGrid");
    grid.innerHTML = "";
    const last = state.lastDelta || {};
    for (const s of stats){
      const el = document.createElement("div");
      el.className = "stat";
      const d = last[s.key];
      const deltaBadge = (typeof d === "number" && d !== 0)
        ? `<span class="delta ${d>0?"good":"bad"}">${d>0?"+":""}${d}</span>`
        : `<span class="delta">${" "}</span>`;
      el.innerHTML = `
        <div class="k">${s.k}</div>
        <div class="v"><span>${s.v}</span>${deltaBadge}</div>
      `;
      // low resource highlighting
      if (s.key === "food" || s.key === "water"){
        const val = Number(state[s.key]);
        if (val === 0) el.classList.add("zero");
        else if (val <= 2) el.classList.add("low");
      }
      grid.appendChild(el);
    }

    const traits = $("traitsList");
    traits.innerHTML = "";
    if (!state.traits.length){
      const p = document.createElement("span");
      p.className = "pill muted";
      p.textContent = "（无）";
      traits.appendChild(p);
    } else {
      for (const t of state.traits){
        const def = TRAITS.find(x=>x.id===t.id);
        const p = document.createElement("span");
        p.className = "pill accent";
        p.title = def?.desc || "";
        p.textContent = def ? `${def.name}` : t.id;
        traits.appendChild(p);
      }
    }

    // buttons availability
    $("btnNext").disabled = !!state.pendingChoice;
    $("btnRest").disabled = !!state.pendingChoice;
    $("btnCraft").disabled = !!state.pendingChoice;
    $("btnUpgrade").disabled = !!state.pendingChoice;

    // auto game over check
    if (state.hp <= 0 || state.morale <= 0){
      $("btnNext").disabled = true;
      $("btnRest").disabled = true;
      $("btnCraft").disabled = true;
      $("btnUpgrade").disabled = true;
    }
  }

  // -----------------------------
  // Game flow
  // -----------------------------
  function startNewRun(seedText){
    state = DEFAULTS();
    if (seedText) state.seedText = seedText;
    rng = mulberry32(hashSeed(state.seedText));

    // roll traits (2 random)
    const pool = shuffle([...TRAITS]).slice(0,2);
    state.traits = pool.map(t=>({id:t.id}));
    state.lastDelta = {};
    state.pendingChoice = null;

    $("log").innerHTML = "";
    logEntry("你从避难所醒来。外面风里夹着灰，远处的城市像一具巨大的尸体。", "开局");
    logEntry(`你的特性：${pool.map(x=>x.name).join("、")}。活下去。`, "开局");
    render();
  }

  function gameOver(){
    state.pendingChoice = null;
    logEntry("你撑不下去了。世界没有为你停下。", "GAME OVER");
    render();
  }

  // -----------------------------
  // Save/Load
  // -----------------------------
  function exportSave(){
    const data = JSON.stringify(state);
    const blob = new Blob([data], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `save_${state.seedText}_day${state.day}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }
  function importSave(){
    const inp = document.createElement("input");
    inp.type="file";
    inp.accept="application/json";
    inp.onchange = async () => {
      const file = inp.files?.[0];
      if (!file) return;
      const text = await file.text();
      try{
        const obj = JSON.parse(text);
        // minimal validation
        if (!obj || typeof obj !== "object" || !("day" in obj)) throw new Error("bad save");
        state = obj;
        rng = mulberry32(hashSeed(state.seedText || randomSeedText()));
        state.pendingChoice = null;
        state.lastDelta = {};
        $("log").innerHTML = "";
        logEntry("已载入存档。你回到那一天。", "系统");
        render();
      }catch(e){
        alert("存档格式不对。");
      }
    };
    inp.click();
  }

  // -----------------------------
  // Wire UI
  // -----------------------------
  $("btnNext").onclick = nextDayEvent;
  $("btnRest").onclick = doRest;
  $("btnCraft").onclick = doCraft;
  $("btnUpgrade").onclick = doUpgrade;
  $("btnNewRun").onclick = () => startNewRun();
  $("btnSave").onclick = exportSave;
  $("btnLoad").onclick = importSave;

  window.addEventListener("keydown", (e)=>{
    if (e.target && ["INPUT","TEXTAREA"].includes(e.target.tagName)) return;
    if (e.key==="n" || e.key==="N") nextDayEvent();
    if (e.key==="r" || e.key==="R") doRest();
    if (e.key==="c" || e.key==="C") doCraft();
    if (e.key==="u" || e.key==="U") doUpgrade();
  });

  // Start
  startNewRun();

})();
</script>
</body>
</html>
