<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æœ«æ—¥é€‰æ‹©ï¼šåŸºåœ°æ±‚ç”Ÿï¼ˆå…¨é¢å‡çº§ç‰ˆï¼‰</title>
  <style>
    /* Enhanced contrast, readable font sizes, touch-friendly spacing */
    :root{
      --bg:#041018;
      --panel:#072029;
      --accent:#ff9f1c;
      --accent-2:#ffb86b;
      --muted:#a8c0c8;
      --text:#eaf6ff;      /* brighter text for readability */
      --muted-2:#9eb6bd;
      --danger:#ff6b6b;
      --good:#6ee7b7;
      --glass: rgba(255,255,255,0.03);
      --card: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));
      --focus: 0 0 0 3px rgba(255,159,28,0.14);
      font-family: Inter, "Noto Sans SC", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      font-size: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#021217,#041018);color:var(--text);-webkit-font-smoothing:antialiased}
    .wrap{max-width:1200px;margin:18px auto;padding:14px;display:flex;flex-direction:column;gap:14px}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px}
    header h1{margin:0;font-size:1.25rem;letter-spacing:0.2px;color:var(--text)}
    .controls{display:flex;gap:8px;align-items:center}
    .controls input,.controls select{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--panel);color:var(--text);min-width:140px}
    .controls button{background:var(--accent);border:none;padding:8px 12px;border-radius:10px;color:#041017;cursor:pointer;box-shadow:0 6px 14px rgba(255,159,28,0.06)}
    .controls .ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text);padding:7px 10px;border-radius:8px}
    main{display:flex;gap:14px}
    #left{flex:1;display:flex;flex-direction:column;gap:12px}
    .panel{background:var(--panel);padding:14px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.02)}
    #story-panel{min-height:440px;display:flex;flex-direction:column;gap:10px}
    #meta{display:flex;gap:10px;align-items:center;font-size:0.95rem;color:var(--muted)}
    .pill{background:var(--glass);padding:6px 10px;border-radius:8px;font-size:0.95rem;display:inline-flex;gap:10px;align-items:center;color:var(--muted)}
    #story{min-height:240px;font-size:1.03rem;line-height:1.7;white-space:pre-wrap;color:var(--text)}
    #choices{display:flex;flex-direction:column;gap:12px;margin-top:6px}
    .choice{background:var(--card);border:1px solid rgba(255,255,255,0.03);padding:14px;border-radius:12px;cursor:pointer;text-align:left;display:flex;justify-content:space-between;align-items:center;transition:transform .12s ease, box-shadow .12s ease;outline:none}
    .choice:hover{transform:translateY(-4px);box-shadow:0 18px 40px rgba(0,0,0,0.6)}
    .choice:focus{box-shadow:var(--focus)}
    .choice.disabled{opacity:0.45;cursor:not-allowed;transform:none;box-shadow:none}
    .choice .left{display:flex;gap:14px;align-items:center}
    .choice .icon{width:52px;height:52px;border-radius:10px;background:linear-gradient(180deg,#0f2a33,#042226);display:inline-flex;align-items:center;justify-content:center;font-size:22px}
    .choice .title{font-weight:700;color:var(--text);font-size:1.02rem}
    .choice .meta{font-size:0.9rem;color:var(--muted)}
    .costs{display:flex;gap:8px;align-items:center;font-size:0.9rem}
    .cost-badge{background:rgba(0,0,0,0.12);padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.03);font-weight:600}
    .tiny{font-size:0.85rem;color:var(--muted)}
    #event-panel .small{margin-bottom:6px}
    #tags{display:flex;gap:8px;flex-wrap:wrap}
    .tag{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px;font-size:0.86rem;color:var(--muted)}
    #right{width:380px;display:flex;flex-direction:column;gap:12px}
    .res-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px dashed rgba(255,255,255,0.03)}
    .res-left{display:flex;gap:12px;align-items:center}
    .res-ico{width:36px;height:36px;border-radius:8px;background:linear-gradient(180deg,#062a35,#04222a);display:flex;align-items:center;justify-content:center;font-size:18px}
    .bar{height:10px;background:rgba(255,255,255,0.04);border-radius:999px;overflow:hidden}
    .bar > i{display:block;height:100%;background:linear-gradient(90deg,var(--good),#ffd27a);width:0%}
    .survivor-card{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px}
    .survivor-info{display:flex;gap:10px;align-items:center}
    .hp{height:10px;background:rgba(0,0,0,0.14);border-radius:999px;overflow:hidden;width:140px}
    .hp > i{display:block;height:100%;background:linear-gradient(90deg,#ff8b6b,#ffea7a);width:0%}
    #log{height:220px;overflow:auto;font-family:monospace;font-size:0.95rem;padding:8px;background:rgba(0,0,0,0.04);border-radius:8px}
    #log .entry{padding:6px 4px;border-bottom:1px dashed rgba(255,255,255,0.02)}
    #log .entry.good{color:var(--good)}
    #log .entry.danger{color:var(--danger)}
    #log .entry.info{color:var(--muted)}
    .log-controls{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
    footer{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:0.95rem}
    .hint{font-size:0.95rem;color:var(--muted)}
    /* Tutorial overlay */
    .overlay{position:fixed;inset:0;background:linear-gradient(180deg, rgba(2,6,10,0.6), rgba(2,6,10,0.85));display:flex;align-items:center;justify-content:center;z-index:60}
    .modal{background:var(--panel);padding:18px;border-radius:12px;max-width:780px;width:96%;box-shadow:0 18px 60px rgba(0,0,0,0.8);border:1px solid rgba(255,255,255,0.03)}
    .modal h3{margin:0 0 8px 0;color:var(--text)}
    .modal p{margin:8px 0;color:var(--muted)}
    .flex{display:flex;gap:8px;align-items:center}
    .muted-btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;color:var(--text);cursor:pointer}
    @media (max-width:980px){ main{flex-direction:column} #right{width:100%} .choice{flex-direction:column;align-items:flex-start} .choice .icon{width:46px;height:46px} }
  </style>
</head>
<body>
  <div class="wrap" role="application" aria-label="æœ«æ—¥é€‰æ‹©ï¼šåŸºåœ°æ±‚ç”Ÿ">
    <header>
      <h1>æœ«æ—¥é€‰æ‹©ï¼šåŸºåœ°æ±‚ç”Ÿï¼ˆå…¨é¢å‡çº§ï¼‰</h1>
      <div class="controls" aria-hidden="false">
        ç§å­: <input id="seed" placeholder="å¯ç©ºï¼ˆå¤ç°å¡«å…¥ï¼‰" aria-label="ç§å­" />
        éš¾åº¦:
        <select id="difficulty" aria-label="éš¾åº¦">
          <option value="easy">ç®€å•</option>
          <option value="normal" selected>æ™®é€š</option>
          <option value="hard">å›°éš¾</option>
        </select>
        <button id="new" title="å¼€å§‹æ–°æ¸¸æˆ">æ–°æ¸¸æˆ</button>
        <button id="save" class="ghost" title="ä¿å­˜">ä¿å­˜</button>
        <button id="load" class="ghost" title="è¯»å–">è¯»å–</button>
        <button id="export" class="ghost" title="å¯¼å‡ºå­˜æ¡£">å¯¼å‡º</button>
        <button id="import" class="ghost" title="å¯¼å…¥å­˜æ¡£">å¯¼å…¥</button>
      </div>
    </header>

    <main>
      <section id="left">
        <div class="panel" id="story-panel" aria-live="polite">
          <div id="meta" class="small" role="region" aria-label="çŠ¶æ€æ¦‚è§ˆ">
            <div class="pill">ç¬¬ <strong id="day">1</strong> å¤©</div>
            <div class="pill">å¹¸å­˜è€…: <strong id="count">0</strong></div>
            <div class="pill">å£«æ°”: <strong id="morale">0</strong></div>
            <div class="pill" title="è¿™æ˜¯ç¦»è¦å¡èƒœåˆ©æ‰€éœ€å¤©æ•°çš„è¿›åº¦">èƒœåˆ©è¿›åº¦ï¼š<strong id="progress">0%</strong></div>
          </div>

          <div id="story" aria-atomic="true"></div>

          <div id="choices" role="list" aria-label="å¯é€‰è¡ŒåŠ¨"></div>
        </div>

        <div class="panel" id="log-panel" aria-label="æ¸¸æˆæ—¥å¿—">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="small">æ—¥å¿—ï¼ˆæœ€è¿‘ï¼‰</div>
            <div class="small" style="display:flex;gap:8px;align-items:center">
              <button id="toggle-log" class="muted-btn">æ”¶èµ·</button>
              <button id="clear-log" class="muted-btn">æ¸…é™¤</button>
            </div>
          </div>
          <div id="log" role="log" aria-live="polite"></div>
          <div class="log-controls">
            <div class="tiny">æ—¥å¿—æŒ‰æ—¶é—´å€’åºï¼ˆæœ€æ–°åœ¨ä¸Šï¼‰</div>
          </div>
        </div>

        <div class="panel" id="event-panel">
          <div class="small">çº¿ç´¢ / äº‹ä»¶æ ‡è®°</div>
          <div id="tags" class="small" style="margin-top:8px"></div>
        </div>
      </section>

      <aside id="right">
        <div class="panel" aria-label="èµ„æºé¢æ¿">
          <div class="small" style="margin-bottom:8px">èµ„æº</div>
          <div class="res-row"><div class="res-left"><div class="res-ico" aria-hidden>ğŸ—</div><div>é£Ÿç‰©</div></div><div><strong id="res-food">0</strong></div></div>
          <div class="res-row"><div class="res-left"><div class="res-ico" aria-hidden>ğŸ”§</div><div>ææ–™</div></div><div><strong id="res-materials">0</strong></div></div>
          <div class="res-row"><div class="res-left"><div class="res-ico" aria-hidden>ğŸ”«</div><div>å¼¹è¯</div></div><div><strong id="res-ammo">0</strong></div></div>
          <div style="margin-top:8px" class="tiny">æç¤ºï¼šæ‚¬åœé€‰é¡¹å¯æŸ¥çœ‹èŠ±è´¹ / é£é™© / é¢„è®¡æ”¶ç›Š</div>
        </div>

        <div class="panel" aria-label="åŸºåœ°é¢æ¿">
          <div class="small">åŸºåœ°</div>
          <div id="base-stats" style="margin-top:8px">
            <div class="res-row"><div>å¢™ç­‰çº§</div><div id="wall">0</div></div>
            <div class="res-row"><div>å†œåœºç­‰çº§</div><div id="farm">0</div></div>
            <div class="res-row"><div>å·¥åŠç­‰çº§</div><div id="workshop">0</div></div>
          </div>
        </div>

        <div class="panel" aria-label="å¹¸å­˜è€…é¢æ¿">
          <div class="small">å¹¸å­˜è€…</div>
          <div id="survivors" style="margin-top:8px"></div>
          <div style="margin-top:8px" class="tiny">è§’è‰²ï¼šScavengerï¼ˆæ‹¾è’è€…ï¼‰ã€Fighterï¼ˆæˆ˜æ–—è€…ï¼‰ã€Medicï¼ˆæ²»ç–—è€…ï¼‰ã€‚è§’è‰²ä¼šå½±å“è¡ŒåŠ¨è¡¨ç°ã€‚</div>
        </div>
      </aside>
    </main>

    <footer>
      <div class="hint">ç©æ³•ï¼šæ¯å¤©é€‰æ‹©ä¸€é¡¹è¡ŒåŠ¨ â†’ ç«‹åˆ»çœ‹åˆ°ç»“æœ â†’ æ¬¡æ—¥æ¨è¿›ã€‚ç›®æ ‡ï¼šä¿æŒç”Ÿè¿˜å¹¶è¾¾æˆä¸åŒç»“å±€ã€‚</div>
      <div>
        <button id="sound-toggle" class="ghost">éŸ³æ•ˆ: å¼€</button>
        <button id="help" class="muted-btn" style="margin-left:8px">æ–°æ‰‹å¼•å¯¼</button>
      </div>
    </footer>
  </div>

  <!-- Tutorial / Onboarding Overlay -->
  <div id="overlay" class="overlay" style="display:none" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <h3>æ¬¢è¿ â€” æ–°æ‰‹å¼•å¯¼</h3>
      <p>è¿™æ˜¯å‰§æƒ…é€‰æ‹©å‹æœ«æ—¥æ±‚ç”Ÿæ¸¸æˆã€‚æ¯ä¸€å¤©å¯ä»¥é€‰æ‹©ä¸€é¡¹è¡ŒåŠ¨ï¼šæ‹¾è’ã€åŠ å›ºã€ä¼‘æ•´ã€ä¿®æ”¶ï¿½ï¿½æœºç­‰ã€‚é€‰æ‹©ä¼šç›´æ¥å½±å“èµ„æºã€å¹¸å­˜è€…ä¸å£«æ°”ã€‚</p>
      <ul>
        <li>å³ä¾§é¢æ¿æ˜¾ç¤ºå½“å‰èµ„æºä¸å¹¸å­˜è€…ã€‚å·¦ä¾§ä¸ºä»Šå¤©çš„äº‹ä»¶åŠå¯é€‰æ“ä½œã€‚</li>
        <li>æ¯ä¸ªå¹¸å­˜è€…æœ‰è§’è‰²ï¼ˆæ‹¾è’è€…/æˆ˜æ–—è€…/æ²»ç–—è€…ï¼‰ä¸ä½“åŠ›ï¼ˆStaminaï¼‰ã€‚ä½“åŠ›ä½çš„äººä¸èƒ½è¢«æ´¾å‡ºã€‚</li>
        <li>æ‚¬åœé€‰é¡¹å¯æŸ¥çœ‹é¢„è®¡æ”¶ç›Šï¼ˆæœŸæœ›å€¼ï¼‰ä¸é£é™©æç¤ºï¼Œå¸®åŠ©å†³ç­–ã€‚</li>
      </ul>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button id="start-tutorial" class="muted-btn">æ¼”ç¤ºä¸€è½®</button>
        <button id="close-tutorial" class="muted-btn">å…³é—­</button>
      </div>
    </div>
  </div>

<script>
/*
  å…¨é¢å‡çº§ç‰ˆè„šæœ¬ï¼ˆv3ï¼‰
  - å¿…è¦ä¿®å¤ï¼ˆç‰ˆæœ¬/garbageä¿®æ­£/game-overä¿æŠ¤/éŸ³é¢‘resume/å®‰å…¨DOMï¼‰
  - UI/å¯è®¿é—®æ€§åŠ å¼ºï¼ˆèšç„¦/tooltip/æ—¥å¿—æ›´é†’ç›®ï¼‰
  - æ–°å¢ï¼šäº‹ä»¶æ•°æ®åŒ–ã€å¹¸å­˜è€…èŒä¸šä¸ä½“åŠ›ï¼ˆstaminaï¼‰ã€hoveré¢„æœŸæ”¶ç›Šæç¤º
  - å­˜æ¡£ version = v3
*/

/* ---------------- RNG ---------------- */
function createRNG(seed) {
  let h = 2166136261 >>> 0;
  if (!seed) seed = Math.random().toString();
  for (let i=0;i<seed.length;i++) h = Math.imul(h ^ seed.charCodeAt(i), 16777619);
  let state = h >>> 0;
  return {
    next() { state ^= state << 13; state ^= state >>> 17; state ^= state << 5; state = state >>> 0; return state / 0x100000000; },
    chance(p){ return this.next() < p; },
    int(min,max){ return Math.floor(this.next()*(max-min+1))+min; }
  };
}

/* ---------------- Defaults & Data-driven events ---------------- */
const DEFAULT = {
  resources: { food: 65, materials: 44, ammo: 18 },
  baseModules: { wall: 1, farm: 0, workshop: 0 },
  survivors: [
    { id:1, name:'é˜¿æ˜', role:'Scavenger', hp:8, maxHp:8, stamina:8, maxStamina:8, task:'idle' },
    { id:2, name:'è‰è', role:'Fighter', hp:7, maxHp:7, stamina:7, maxStamina:7, task:'idle' }
  ],
  dayLimitWin: 30
};

/* Data-driven event definitions (extendable) */
const EVENT_LIBRARY = [
  {
    id: 'abandoned_house',
    title: 'æ—§å®…çº¿ç´¢',
    desc: 'éƒŠå¤–æ—§å®…å¯èƒ½æœ‰å‚¨å¤‡ï¼Œä½†é™„è¿‘æœ‰æ´»åŠ¨ç—•è¿¹ã€‚',
    choices: [
      { id:'scout_one', text:'æ´¾ä¸€äººä¾¦æŸ¥ï¼ˆä½é£é™©ï¼‰', effect: (s,e,ctx)=> { /* handled in code */ } },
      { id:'full_search', text:'æ´¾å…¨ä½“æœæŸ¥ï¼ˆé«˜é£é™©ï¼‰', effect: (s,e,ctx)=>{} },
      { id:'ignore', text:'æ”¾å¼ƒ', effect: (s,e,ctx)=>{} }
    ]
  },
  {
    id: 'strange_signal',
    title: 'ç¥ç§˜ä¿¡å·',
    desc: 'å¤œé‡Œå¬åˆ°è¿œå¤„åå¤çš„ä¿¡å·å£°ï¼Œå¯èƒ½æ˜¯æ±‚æ•‘ä¹Ÿå¯èƒ½æ˜¯é™·é˜±ã€‚',
    choices: [ { id:'respond', text:'å›åº”ä¿¡å·' }, { id:'observe', text:'æ´¾å“¨è§‚å¯Ÿ' }, { id:'ignore', text:'å¿½ç•¥' } ]
  },
  {
    id: 'wounded_traveller',
    title: 'å—ä¼¤æ—…äºº',
    desc: 'ä¸€ä¸ªå—ä¼¤æ—…äººæ±‚åŠ©ï¼Œæ„¿ç”¨ä¿¡æ¯æˆ–åŠ³åŠ›äº¤æ¢ã€‚',
    choices: [ { id:'treat', text:'æ”¶ç•™å¹¶æ²»ç–—' }, { id:'trade', text:'äº¤æ˜“ä¿¡æ¯' }, { id:'reject', text:'æ‹’ç»' } ]
  },
  {
    id: 'ration_find',
    title: 'è·¯è¾¹èƒŒåŒ…',
    desc: 'å‘ç°ç ´æ—§èƒŒåŒ…ï¼Œå¯èƒ½æœ‰å°‘é‡ç‰©èµ„ï¼Œä¹Ÿå¯èƒ½æ˜¯é™·é˜±ã€‚',
    choices: [ { id:'search', text:'æœæŸ¥' }, { id:'skip', text:'æ”¾è¿‡' } ]
  }
];

let state = null;
let rng = createRNG(Date.now().toString());
let audioEnabled = true;
let audioCtx = null;
const SAVE_KEY = 'story_rogue_save_v3';

/* ---------------- Utilities ---------------- */
function uid(){ return Math.floor(Math.random()*1e9).toString(36) + Date.now().toString(36); }
function el(id){ return document.getElementById(id); }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function isGameOver(){ return !!(state && state.endings && state.endings.reached); }

/* Resume audio on first user gesture */
window.addEventListener('pointerdown', function _resumeAudioOnce(){
  try{ if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); }catch(e){}
  window.removeEventListener('pointerdown', _resumeAudioOnce);
}, { once:true });

function playTone(freq=440, duration=0.12, type='sine', gain=0.06){
  if (!audioEnabled) return;
  try{
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
    o.type = type; o.frequency.value = freq; g.gain.value = gain;
    o.connect(g); g.connect(audioCtx.destination); o.start();
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
    setTimeout(()=>o.stop(), duration*1000 + 20);
  }catch(e){}
}

/* ---------------- Persistence ---------------- */
function saveAuto(){ try{ localStorage.setItem(SAVE_KEY, JSON.stringify(state)); }catch(e){ console.error(e); } }
function manualSave(){ saveAuto(); logAdd('æ¸¸æˆå·²ä¿å­˜'); renderLog(); }
function manualLoad(){
  try{
    const raw = localStorage.getItem(SAVE_KEY);
    if (!raw) { logAdd('æœªæ‰¾åˆ°å­˜æ¡£'); renderLog(); return; }
    const loaded = JSON.parse(raw);
    if (loaded.version && loaded.version !== 'v3') console.warn('åŠ è½½ä¸åŒç‰ˆæœ¬å­˜æ¡£ï¼š', loaded.version);
    state = loaded;
    rng = createRNG(state.seed || Date.now().toString());
    logAdd('å­˜æ¡£å·²åŠ è½½');
    renderAll();
  }catch(e){ logAdd('è¯»å–å­˜æ¡£å¤±è´¥'); console.error(e); }
}
function exportSave(){
  try{
    const raw = JSON.stringify(state);
    const blob = new Blob([raw], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'save_story_v3.json'; a.click(); URL.revokeObjectURL(url);
    logAdd('å·²å¯¼å‡ºå­˜æ¡£');
  }catch(e){ logAdd('å¯¼å‡ºå¤±è´¥'); }
}
function importSave(){
  const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange = ()=> {
    const f = inp.files[0]; if (!f) return;
    const r = new FileReader();
    r.onload = ()=> {
      try{ localStorage.setItem(SAVE_KEY, r.result); manualLoad(); logAdd('å·²å¯¼å…¥å­˜æ¡£'); }catch(e){ logAdd('å¯¼å…¥å¤±è´¥'); }
    };
    r.readAsText(f);
  };
  inp.click();
}

/* ---------------- Logging ---------------- */
function logAdd(text, type='info'){
  if (!state) return;
  state.log.unshift({ id: uid(), t: text, ts: Date.now(), type });
  if (state.log.length > 400) state.log.length = 400;
  renderLog();
}
function scrollLogToTop(){ const node = el('log'); if (node) node.scrollTop = 0; }

/* ---------------- Rendering ---------------- */
function renderAll(){
  if (!state) return;
  el('day').textContent = state.day;
  el('count').textContent = state.survivors.length;
  el('morale').textContent = state.morale;
  el('res-food').textContent = state.resources.food;
  el('res-materials').textContent = state.resources.materials;
  el('res-ammo').textContent = state.resources.ammo;
  el('wall').textContent = state.base.wall;
  el('farm').textContent = state.base.farm;
  el('workshop').textContent = state.base.workshop;
  const progress = Math.round((state.day / DEFAULT.dayLimitWin) * 100);
  el('progress').textContent = progress + '%';
  renderSurvivors();
  renderLog();
  renderTags();
  if (!currentNode) presentDayOptions();
}

function renderSurvivors(){
  const box = el('survivors'); box.innerHTML = '';
  for (const s of state.survivors){
    const div = document.createElement('div'); div.className='survivor-card';
    const left = document.createElement('div'); left.className='survivor-info';
    const avatar = document.createElement('div'); avatar.style.width='46px'; avatar.style.height='46px'; avatar.style.borderRadius='8px';
    avatar.style.background='linear-gradient(180deg,#0b2c2f,#042022)'; avatar.style.display='flex'; avatar.style.alignItems='center'; avatar.style.justifyContent='center';
    avatar.textContent = s.name.charAt(0);
    const info = document.createElement('div');
    const name = document.createElement('div'); name.style.fontWeight='700'; name.textContent = `${s.name} (${s.role})`;
    const statRow = document.createElement('div'); statRow.style.display='flex'; statRow.style.gap='8px'; statRow.style.alignItems='center'; statRow.style.marginTop='6px';
    const hpWrap = document.createElement('div'); hpWrap.className='hp'; const hpBar = document.createElement('i'); hpBar.style.width = Math.round((s.hp/s.maxHp)*100) + '%'; hpWrap.appendChild(hpBar);
    const staminaWrap = document.createElement('div'); staminaWrap.className='hp'; staminaWrap.title='ä½“åŠ›'; const stBar = document.createElement('i'); stBar.style.background='linear-gradient(90deg,#7bdcff,#4aa0ff)'; stBar.style.width = Math.round((s.stamina/s.maxStamina)*100) + '%'; staminaWrap.appendChild(stBar);
    const small = document.createElement('div'); small.className='tiny'; small.textContent = `HP ${s.hp}/${s.maxHp} Â· Sta ${s.stamina}/${s.maxStamina}`;
    statRow.appendChild(hpWrap); statRow.appendChild(staminaWrap); statRow.appendChild(small);
    info.appendChild(name); info.appendChild(statRow);
    left.appendChild(avatar); left.appendChild(info);

    const right = document.createElement('div'); right.style.textAlign='right';
    const task = document.createElement('div'); task.className='tiny'; task.textContent = s.task || 'ç©ºé—²';
    right.appendChild(task);
    const btn = document.createElement('button'); btn.className='muted-btn'; btn.style.marginTop='8px'; btn.textContent='åˆ‡æ¢ä»»åŠ¡';
    btn.onclick = ()=> { s.task = (s.task === 'idle') ? 'sentry' : 'idle'; logAdd(`${s.name} ä»»åŠ¡å˜æ›´ä¸º ${s.task}`); saveAuto(); renderAll(); };
    right.appendChild(btn);
    div.appendChild(left); div.appendChild(right);
    box.appendChild(div);
  }
}

function renderLog(){
  const node = el('log'); if (!node) return;
  node.innerHTML = '';
  for (const e of state.log.slice(0,120)){
    const d = document.createElement('div'); d.className = 'entry ' + (e.type || 'info');
    const t = new Date(e.ts).toLocaleTimeString();
    d.textContent = `[${t}] ${e.t}`;
    node.appendChild(d);
  }
  scrollLogToTop();
}

function renderTags(){
  const container = el('tags'); container.innerHTML = '';
  for (const k of Object.keys(state.eventsFlags || {})) {
    if (state.eventsFlags[k]) {
      const t = document.createElement('div'); t.className='tag'; t.textContent = k.replace('_',' ');
      container.appendChild(t);
    }
  }
}

/* ---------------- Story system ---------------- */
const storyEl = el('story');
const choicesEl = el('choices');
let currentNode = null;

/* Compute expected value tooltip for actions */
function expectedValueFor(actionId){
  // Provide rough expected resource change and risk score for tooltip
  // This is conservative and meant as a guide; can be extended.
  switch(actionId){
    case 'scavenge': return { text:'æœŸæœ›ï¼šé£Ÿç‰© +2~8 / é£é™©ï¼šå—ä¼¤æˆ–å¤±å»å°æ¦‚ç‡', score:0.45 };
    case 'fortify': return { text:'æœŸæœ›ï¼šå¢™/å†œåœº/å·¥åŠ å¢ç›Šï¼Œæ¶ˆè€—ææ–™', score:0.15 };
    case 'rest': return { text:'æœŸæœ›ï¼šæ¢å¤ HP & ä½“åŠ›ï¼Œæ¶ˆè€—é£Ÿç‰©', score:-0.05 };
    case 'radio': return { text:'æœŸæœ›ï¼šæœ‰æ¦‚ç‡è·å¾—æ’¤ç¦»çº¿ç´¢ï¼Œéœ€ææ–™', score:0.2 };
    case 'raid': return { text:'æœŸæœ›ï¼šé«˜å›æŠ¥é£Ÿç‰©ï¼Œé£é™©é«˜', score:0.6 };
    default: return { text:'äº‹ä»¶ / å‰§æƒ…é€‰æ‹©ï¼Œç»“æœå¤šå˜', score:0.3 };
  }
}

function presentDayOptions(){
  if (isGameOver()){
    storyEl.textContent = 'æ¸¸æˆå·²ç»“æŸï¼š' + (state.endings.reached || 'ç»“å±€å·²è¾¾æˆ') + 'ã€‚ä½ å¯ä»¥å¼€å§‹æ–°æ¸¸æˆã€‚';
    choicesEl.innerHTML = '';
    const btn = document.createElement('button'); btn.className='choice'; btn.textContent = 'å¼€å§‹æ–°æ¸¸æˆ'; btn.onclick = ()=> { const seed = el('seed').value || Date.now().toString(); const diff = el('difficulty').value; newGame(seed, diff); };
    choicesEl.appendChild(btn);
    return;
  }

  storyEl.textContent = `ç¬¬ ${state.day} å¤©ã€‚\n\næ¸…æ™¨ï¼Œä½ æŸ¥çœ‹åŸºåœ°ï¼šé£Ÿç‰© ${state.resources.food}ã€ææ–™ ${state.resources.materials}ã€å¼¹è¯ ${state.resources.ammo}ã€‚å¹¸å­˜è€…ï¼š${state.survivors.length}ã€‚é€‰æ‹©ä»Šå¤©çš„ä¸»è¦è¡ŒåŠ¨ï¼š`;

  const options = [
    { id:'scavenge', title:'æ´¾äººå¤–å‡ºæ‹¾è’', subtitle:'é«˜é£é™©Â·é«˜å›æŠ¥', icon:'ğŸ§­', fn: actionScavenge, enabled: state.survivors.some(s=>s.stamina > 2) },
    { id:'fortify', title:'åŠ å›ºé˜²å¾¡ / å‡çº§æ¨¡å—', subtitle:'æ¶ˆè€—ææ–™ï¼Œæå‡ç”Ÿå­˜', icon:'ğŸ› ï¸', fn: actionFortify, enabled: state.resources.materials >= 4 },
    { id:'rest', title:'å…¨ä½“ä¼‘æ•´', subtitle:'æ¢å¤ç”Ÿå‘½ä¸ä½“åŠ›ï¼Œæ¶ˆè€—å°‘é‡é£Ÿç‰©', icon:'ğŸ›Œ', fn: actionRest, enabled: state.resources.food >= Math.max(1, Math.floor(state.survivors.length/2)) }
  ];
  if (state.base.workshop >= 1) options.push({ id:'radio', title:'ä¿®å¤æ”¶éŸ³æœºå¹¶å‘é€ä¿¡å·', subtitle:'å¯èƒ½è·å¾—æ’¤ç¦»çº¿ç´¢', icon:'ğŸ“»', fn: actionRadio, enabled: state.resources.materials >= 6 });
  options.push({ id:'event', title:'è°ƒæŸ¥é™„è¿‘å¼‚å¸¸', subtitle:'è§¦å‘éšæœºäº‹ä»¶', icon:'â“', fn: actionEvent, enabled:true });
  if (state.resources.food < 20) options.push({ id:'raid', title:'ç»„ç»‡åŠ«æ ï¼ˆé«˜é£é™©ï¼‰', subtitle:'å¯èƒ½è·å¾—å¤§é‡é£Ÿï¿½ï¿½', icon:'âš”ï¸', fn: actionRaid, enabled: state.survivors.length > 0 });

  renderChoices(options.map(o=>({
    id: o.id, text: o.title, description: o.subtitle, icon: o.icon, onClick: ()=> o.enabled ? o.fn() : (logAdd('å½“å‰æ¡ä»¶ä¸æ»¡è¶³è¯¥è¡ŒåŠ¨'), playTone(240,0.06,'sine',0.03)), enabled: o.enabled
  })));
}

/* Safe choices renderer with tooltip of expected value */
function renderChoices(items){
  choicesEl.innerHTML = '';
  for (const it of items){
    const btn = document.createElement('button'); btn.className='choice' + (it.enabled ? '' : ' disabled'); btn.setAttribute('role','listitem'); btn.setAttribute('tabindex','0');
    const left = document.createElement('div'); left.className='left';
    const ico = document.createElement('div'); ico.className='icon'; ico.textContent = it.icon || 'â”';
    const txt = document.createElement('div');
    const title = document.createElement('div'); title.className='title'; title.textContent = it.text;
    const meta = document.createElement('div'); meta.className='meta'; meta.textContent = it.description || '';
    txt.appendChild(title); txt.appendChild(meta);
    left.appendChild(ico); left.appendChild(txt);
    const right = document.createElement('div'); right.style.display='flex'; right.style.flexDirection='column'; right.style.alignItems='flex-end';
    const ev = expectedValueFor(it.id);
    const expectation = document.createElement('div'); expectation.className='tiny'; expectation.textContent = ev.text;
    right.appendChild(expectation);
    btn.appendChild(left); btn.appendChild(right);
    btn.onclick = ()=> { if (!it.enabled) return; it.onClick && it.onClick(); };
    btn.title = `${it.text} â€” ${it.description || ''} Â· ${ev.text}`;
    choicesEl.appendChild(btn);
  }
  // focus first available choice
  setTimeout(()=> { const first = choicesEl.querySelector('.choice:not(.disabled)'); if (first) first.focus(); }, 0);
}

/* ---------------- Actions (with roles & stamina) ---------------- */

/* Helper: choose team from healthy survivors (stamina > threshold) */
function getHealthyList(minStamina=2){
  return state.survivors.filter(s=>s.stamina > minStamina && s.hp > 1);
}

/* Scavenge behavior using roles and stamina */
function actionScavenge(){
  const healthy = getHealthyList(2);
  if (healthy.length === 0) { logAdd('æ²¡æœ‰è¶³å¤Ÿä½“åŠ›çš„å¹¸å­˜è€…å¯ä»¥å¤–å‡ºï¼'); renderAll(); return; }
  // Allow single pick choices + "all"
  const choices = healthy.map(s=>({ text:`ï¿½ï¿½ ${s.name} (${s.role}) å•ç‹¬å¤–å‡º`, handler: ()=> scavengeRun([s]), meta:'å•äººé£é™©è¾ƒä½' }));
  choices.push({ text:'æ´¾å‡ºå…¨éƒ¨å¯ç”¨ï¼ˆæ›´é«˜å›æŠ¥ï¼Œé£é™©å¢åŠ ï¼‰', handler: ()=> scavengeRun(healthy.slice()), meta:'å…¨é˜Ÿè¡ŒåŠ¨' });
  choices.push({ text:'å–æ¶ˆ', handler: ()=> popStoryNode(false) });
  pushStoryNode({ text:'é€‰æ‹©è¦æ´¾å‡ºçš„é˜Ÿä¼ï¼ˆä½“åŠ›ä½çš„ä¸å¯è¢«æ´¾ï¼‰', choices });
}

/* Scavenge calculation: roles affect success/loot, stamina reduces */
function scavengeRun(team){
  const teamNames = team.map(s=>s.name).join('ã€');
  logAdd(`${teamNames} å‡ºå‘æ‹¾è’`);
  playTone(880,0.06,'triangle',0.04);

  // compute role bonuses
  let roleBonus = 0;
  for (const s of team){
    if (s.role === 'Scavenger') roleBonus += 0.12;
    else if (s.role === 'Fighter') roleBonus += 0.02;
    else if (s.role === 'Medic') roleBonus += 0.05;
  }
  // average stamina factor
  const avgSta = Math.round(team.reduce((a,b)=>a+b.stamina,0) / team.length);
  const staminaFactor = clamp((avgSta / 8), 0.5, 1.15);

  const baseSuccess = 0.46 + (team.length-1)*0.08 + roleBonus + (state.morale-50)/500;
  const successProb = clamp(baseSuccess * staminaFactor, 0.08, 0.97);
  const success = rng.chance(successProb);

  // consume stamina
  for (const s of team){ s.stamina = Math.max(0, s.stamina - rng.int(2,4)); }

  if (success){
    // Loot scales with team size and scavenger presence
    const scavCount = team.filter(s=>s.role === 'Scavenger').length;
    const food = rng.int(2,5) * (1 + Math.floor(team.length/2)) + scavCount * rng.int(1,3);
    const mats = rng.int(1,3) * Math.max(1, Math.floor(team.length/2));
    const ammo = rng.int(0,2) * Math.max(1, Math.floor(team.length/2));
    state.resources.food += food; state.resources.materials += mats; state.resources.ammo += ammo;
    if (rng.chance(0.08)) { state.eventsFlags['distress_note'] = true; logAdd(`${teamNames} å‘ç°æ±‚æ•‘çº¿ç´¢`, 'good'); }
    else logAdd(`${teamNames} å®‰å…¨è¿”å›ï¼šé£Ÿç‰© +${food}ã€ææ–™ +${mats}ã€å¼¹è¯ +${ammo}`, 'good');
    state.morale = clamp(state.morale + rng.int(1,3), 0, 100);
  } else {
    // prefer injuries over death; fighters mitigate loss chance
    const fighterCount = team.filter(s=>s.role === 'Fighter').length;
    if (team.length > 1 && rng.chance(0.18 - fighterCount*0.03)) {
      const lost = team.splice(rng.int(0, team.length-1),1)[0];
      state.survivors = state.survivors.filter(s=>s.id !== lost.id);
      logAdd(`${teamNames} é­é‡å†²çªï¼Œ${lost.name} æœªèƒ½è¿”å›`, 'danger');
      playTone(120,0.28,'sawtooth',0.08);
      state.morale = clamp(state.morale - rng.int(6,12), 0, 100);
    } else {
      for (const mem of team){
        if (rng.chance(0.45)) {
          const dmg = rng.int(1,3); mem.hp = Math.max(0, mem.hp - dmg); logAdd(`${mem.name} å—ä¼¤ -${dmg} HP`);
        }
        // small resource return
        if (rng.chance(0.4)) {
          state.resources.food += rng.int(0,2);
        }
      }
      logAdd(`${teamNames} å—æŒ«è¿”å›ï¼ˆå¸¦å›å°‘é‡ç‰©èµ„ï¼‰`, 'danger');
      playTone(220,0.08,'square',0.05);
      state.morale = clamp(state.morale - rng.int(2,6), 0, 100);
    }
  }
  popStoryNode(true);
}

/* Fortify / upgrades */
function actionFortify(){
  const choices = [
    { text:'æ¶ˆè€— 10 ææ–™ å»ºé€ /å‡çº§ å¢™ (+1)', handler: ()=> { if (state.resources.materials < 10) { logAdd('ææ–™ä¸è¶³'); renderAll(); return; } state.resources.materials -= 10; state.base.wall += 1; logAdd('åŠ å›ºå¢™ä½“ï¼Œæå‡é˜²å¾¡', 'good'); playTone(520,0.08,'sine',0.06); advanceDay(); }, meta:'è€ä¹…æå‡' },
    { text:'æ¶ˆè€— 8 ææ–™ å‡çº§ å†œåœº (+1)', handler: ()=> { if (state.resources.materials < 8) { logAdd('ææ–™ä¸è¶³'); renderAll(); return; } state.resources.materials -= 8; state.base.farm += 1; logAdd('å‡çº§å†œåœºï¼Œæé«˜äº§å‡º', 'good'); playTone(660,0.08,'sine',0.06); advanceDay(); }, meta:'ç¨³å®šäº§å‡º' },
    { text:'æ¶ˆè€— 12 ææ–™ å‡çº§ å·¥åŠ (+1)', handler: ()=> { if (state.resources.materials < 12) { logAdd('ææ–™ä¸è¶³'); renderAll(); return; } state.resources.materials -= 12; state.base.workshop += 1; logAdd('å·¥åŠå‡çº§ï¼Œè§£é”ä¿®æ”¶éŸ³æœºç­‰é€‰é¡¹', 'good'); playTone(720,0.08,'sine',0.06); advanceDay(); }, meta:'è§£é”é€‰é¡¹' },
    { text:'å–æ¶ˆ', handler: ()=> popStoryNode(false) }
  ];
  pushStoryNode({ text:'é€‰æ‹©è¦å»ºé€ /å‡çº§çš„æ¨¡å—ï¼š', choices });
}

/* Rest restores HP & stamina */
function actionRest(){
  const healTotal = rng.int(1,3);
  for (const s of state.survivors){ s.hp = Math.min(s.maxHp, s.hp + healTotal); s.stamina = Math.min(s.maxStamina, s.stamina + rng.int(2,4)); }
  state.morale = clamp(state.morale + rng.int(4,9), 0, 100);
  const foodCost = Math.max(1, Math.floor(state.survivors.length/2));
  state.resources.food = Math.max(0, state.resources.food - foodCost);
  logAdd(`å…¨ä½“ä¼‘æ•´ï¼šå›å¤ HP ${healTotal}ã€ä½“åŠ›å°‘é‡æ¢å¤ï¼Œæ¶ˆè€— é£Ÿç‰© ${foodCost}`, 'info');
  playTone(440,0.12,'sine',0.06);
  advanceDay();
}

/* Radio (repair) */
function actionRadio(){
  if (state.base.workshop < 1){ logAdd('éœ€è¦å·¥åŠæ¥ä¿®ç†æ”¶éŸ³æœº'); renderAll(); return; }
  const choices = [
    { text:'ç”¨ææ–™ä¿®å¤å¤©çº¿ï¼ˆ6 ææ–™ï¼‰', handler: ()=> {
      if (state.resources.materials < 6) { logAdd('ææ–™ä¸è¶³'); renderAll(); return; }
      state.resources.materials -= 6;
      const base = 0.45 + state.base.workshop * 0.12;
      if (rng.chance(clamp(base,0.22,0.95))) {
        state.eventsFlags['radio_fixed'] = true;
        logAdd('æ”¶éŸ³æœºä¿®å¤æˆåŠŸå¹¶å‘é€ä¿¡å·ï¼Œä½ è·å¾—äº†æ’¤ç¦»çº¿ç´¢', 'good');
        playTone(980,0.12,'triangle',0.07);
      } else {
        state.eventsFlags['radio_partial'] = true;
        logAdd('ä¿®å¤å°è¯•å¤±è´¥ï¼Œä½†è®°å½•äº†ä¿®å¤è¦ç‚¹', 'info');
        playTone(240,0.08,'sine',0.04);
      }
      popStoryNode(true);
    }},
    { text:'æ”¾å¼ƒå¹¶è¿”å›', handler: ()=> popStoryNode(false) }
  ];
  pushStoryNode({ text:'ä¿®ç†æ”¶éŸ³æœºéœ€è¦ææ–™å¹¶æœ‰æˆåŠŸç‡ï¼Œä½ è¦å¦‚ä½•æ“ä½œï¼Ÿ', choices });
}

/* Event dispatcher uses EVENT_LIBRARY (data-driven) */
function actionEvent(){
  const ev = EVENT_LIBRARY[rng.int(0, EVENT_LIBRARY.length-1)];
  if (!ev) { logAdd('æœªæ‰¾åˆ°äº‹ä»¶'); return; }
  // Build choices from event definition and use handlers mapped here
  const choices = ev.choices.map(c => ({
    text: c.text,
    meta: '',
    handler: ()=> handleEventChoice(ev.id, c.id)
  }));
  choices.push({ text:'å–æ¶ˆ', handler: ()=> popStoryNode(false) });
  pushStoryNode({ text: `${ev.title}\n\n${ev.desc}`, choices });
}

function handleEventChoice(eventId, choiceId){
  // Map event outcomes; this keeps event definitions simple and moves logic here.
  if (eventId === 'abandoned_house') {
    if (choiceId === 'scout_one') {
      if (state.survivors.length === 0) { logAdd('æ²¡æœ‰äººå¯æ´¾'); popStoryNode(false); return; }
      const s = state.survivors[rng.int(0, state.survivors.length-1)];
      logAdd(`${s.name} å»ä¾¦æŸ¥æ—§å®…`);
      if (rng.chance(0.55 + (s.role === 'Scavenger' ? 0.08 : 0))) {
        const food = rng.int(3,9); state.resources.food += food; logAdd(`${s.name} æ‰¾åˆ° é£Ÿç‰© ${food}`, 'good');
      } else {
        pushStoryNode({
          text: `${s.name} é‡åˆ°å¦ä¸€ç»„å¹¸å­˜è€…ï¼Œå¯¹æ–¹æˆ’å¤‡ã€‚ä½ è¦ï¼š`,
          choices:[
            { text:'å°è¯•è°ˆåˆ¤ï¼ˆå¯èƒ½å’Œå¹³ï¼‰', handler: ()=> {
              if (rng.chance(0.48 + (state.morale-50)/200)) {
                const newOne = { id: uid(), name: 'ç±³å¨…', role:'Scavenger', hp:7, maxHp:7, stamina:7, maxStamina:7, task:'idle' };
                state.survivors.push(newOne);
                state.morale = clamp(state.morale+6,0,100);
                logAdd('è°ˆåˆ¤æˆåŠŸï¼šç±³å¨… åŠ å…¥', 'good');
                popStoryNode(true);
              } else {
                state.resources.materials = Math.max(0, state.resources.materials - rng.int(1,4));
                logAdd('è°ˆåˆ¤å¤±è´¥ï¼Œå¤±å»éƒ¨åˆ†ææ–™', 'danger');
                popStoryNode(true);
              }
            }},
            { text:'æ’¤é€€', handler: ()=> { logAdd('æ’¤é€€ï¼Œé¿å…å†²çª'); popStoryNode(true); } }
          ]
        });
      }
    } else if (choiceId === 'full_search') {
      if (state.survivors.length <= 0) { logAdd('æ²¡æœ‰äººå¯æ´¾'); popStoryNode(false); return; }
      if (rng.chance(0.42 + state.survivors.length*0.04)) {
        const f = rng.int(6,14); state.resources.food += f; state.resources.materials += rng.int(1,4);
        logAdd('å…¨ä½“æœæŸ¥å¤§è·æ”¶è·ï¼šé£Ÿç‰© '+f, 'good');
      } else {
        const lost = state.survivors.splice(rng.int(0, state.survivors.length-1),1)[0];
        logAdd(`${lost.name} åœ¨å†²çªä¸­ç‰ºç‰²`, 'danger');
        state.morale = clamp(state.morale - 10, 0, 100);
      }
      popStoryNode(true);
    } else {
      logAdd('æ”¾å¼ƒè¯¥åœ°ç‚¹'); popStoryNode(false);
    }
  } else if (eventId === 'strange_signal') {
    if (choiceId === 'respond') {
      if (rng.chance(0.4 + (state.base.workshop*0.06))) {
        state.eventsFlags['evac_hint'] = true; logAdd('å›åº”ä¿¡å·åè·å¾—äº†æ’¤ç¦»çº¿ç´¢', 'good'); playTone(990,0.08,'sine',0.06);
      } else {
        state.resources.food = Math.max(0, state.resources.food - rng.int(2,6)); state.morale = clamp(state.morale - rng.int(3,7),0,100);
        logAdd('ä¿¡å·æ˜¯é™·é˜±ï¼ŒæŸå¤±é£Ÿç‰©ä¸”å£«æ°”ä¸‹é™', 'danger'); playTone(200,0.12,'sawtooth',0.08);
      }
      popStoryNode(true);
    } else if (choiceId === 'observe') {
      if (rng.chance(0.5)) { state.resources.materials += rng.int(1,4); logAdd('è§‚å¯Ÿåˆ°çº¿ç´¢å¹¶å›æ”¶ææ–™', 'good'); } else logAdd('è§‚å¯Ÿæœªå‘ç°å®è´¨ä¿¡æ¯');
      popStoryNode(true);
    } else { logAdd('å¿½ç•¥ä¿¡å·'); popStoryNode(true); }
  } else if (eventId === 'wounded_traveller') {
    if (choiceId === 'treat') {
      if (state.resources.food < 4 || state.resources.materials < 2) { logAdd('èµ„æºä¸è¶³æ— æ³•æ”¶ç•™'); popStoryNode(false); return; }
      state.resources.food -= 4; state.resources.materials -= 2;
      const newOne = { id: uid(), name: 'æ—…äºº', role:'Medic', hp: rng.int(4,8), maxHp: rng.int(6,9), stamina:6, maxStamina:6, task:'idle' };
      state.survivors.push(newOne); state.morale = clamp(state.morale + 8, 0, 100); logAdd('æ•‘åŠ©æ—…äººï¼ŒåŠ å…¥é˜Ÿä¼', 'good');
      popStoryNode(true);
    } else if (choiceId === 'trade') {
      if (state.resources.food < 2) { logAdd('é£Ÿç‰©ä¸è¶³'); popStoryNode(false); return; }
      state.resources.food -= 2; state.eventsFlags['map_clue'] = true; logAdd('ç”¨é£Ÿç‰©æ¢æ¥æ—§åœ°å›¾çº¿ç´¢', 'good'); popStoryNode(true);
    } else { logAdd('æ‹’ç»æ—…äººï¼Œå£«æ°”ä¸‹é™'); state.morale = clamp(state.morale-3,0,100); popStoryNode(true); }
  } else if (eventId === 'ration_find') {
    if (choiceId === 'search') {
      if (rng.chance(0.58)) { const f = rng.int(1,4), a = rng.int(0,2); state.resources.food += f; state.resources.ammo += a; logAdd(`æ‰¾åˆ° é£Ÿç‰© ${f}ã€å¼¹è¯ ${a}`, 'good'); }
      else logAdd('èƒŒåŒ…ç©ºæˆ–å·²è¢«æœè¿‡');
      popStoryNode(true);
    } else { logAdd('æ”¾è¿‡èƒŒåŒ…ä»¥å…é‡åˆ°é™·é˜±'); popStoryNode(true); }
  } else {
    logAdd('äº‹ä»¶å¤„ç†æœªå®šä¹‰'); popStoryNode(true);
  }
}

/* Raid */
function actionRaid(){
  const choices = [
    { text:'å‘èµ·åŠ«æ ï¼ˆé«˜é£é™©ï¼‰', handler: ()=> {
      logAdd('ç»„ç»‡åŠ«æ è¡ŒåŠ¨');
      const chance = 0.35 + (state.survivors.length*0.03);
      if (rng.chance(chance)) {
        const f = rng.int(12, 26); state.resources.food += f; state.morale = clamp(state.morale - rng.int(1,4),0,100);
        logAdd('åŠ«æ æˆåŠŸï¼è·å¾—é£Ÿç‰© '+f, 'good'); playTone(760,0.08,'triangle',0.06);
      } else {
        if (rng.chance(0.45) && state.survivors.length>0) {
          const lost = state.survivors.splice(rng.int(0, state.survivors.length-1),1)[0];
          logAdd(`${lost.name} åœ¨åŠ«æ ä¸­ç‰ºç‰²`, 'danger'); playTone(120,0.22,'sawtooth',0.09);
        }
        state.resources.food = Math.max(0, state.resources.food - rng.int(3,10));
        state.morale = clamp(state.morale - rng.int(6,14),0,100);
        logAdd('åŠ«æ å¤±è´¥ï¼Œä»˜å‡ºæƒ¨ç—›ä»£ä»·', 'danger');
      }
      popStoryNode(true);
    }},
    { text:'å–æ¶ˆ', handler: ()=> popStoryNode(false) }
  ];
  pushStoryNode({ text:'æ˜¯å¦ç»„ç»‡åŠ«æ ï¼Ÿï¼ˆé«˜é£é™©ï¼‰', choices });
}

/* ---------------- Advance Day & Endings ---------------- */
function advanceDay(){
  state.day += 1;
  // farm output
  if (state.base.farm > 0) {
    const gain = rng.int(1,2) * state.base.farm;
    state.resources.food += gain;
    logAdd(`å†œåœºäº§å‡º ${gain} é£Ÿç‰©`, 'good');
  }
  // consumption
  const eat = Math.max(1, state.survivors.length);
  state.resources.food = Math.max(0, state.resources.food - eat);
  if (state.resources.food === 0) {
    for (const s of state.survivors){ if (rng.chance(0.22)) s.hp = Math.max(0, s.hp - 1); }
    state.morale = clamp(state.morale - rng.int(5,10),0,100);
    logAdd('é£Ÿç‰©è€—å°½ï¼Œå¤§å®¶é¥¥é¥¿ä¸”å£«æ°”ä¸‹é™', 'danger');
  } else {
    state.morale = clamp(state.morale + rng.int(-1,2),0,100);
  }

  // nightly attack
  const attackChance = clamp(0.12 + state.day*0.008 - state.base.wall*0.03 + (state.difficulty==='hard'?0.03:0), 0.05, 0.5);
  if (rng.chance(attackChance)){
    const severity = rng.int(1,8), defense = state.base.wall;
    if (severity > 5 + defense) {
      state.resources.materials = Math.max(0, state.resources.materials - rng.int(3,8));
      if (state.survivors.length>0 && rng.chance(0.35)) {
        const lost = state.survivors.splice(rng.int(0,state.survivors.length-1),1)[0];
        logAdd(`å¤œé—´è¢­å‡»ï¼${lost.name} ç‰ºç‰²`, 'danger');
      } else logAdd('å¤œé—´è¢­å‡»é€ æˆç ´åï¼Œä½†å®ˆä½äº†é˜²çº¿', 'danger');
      state.morale = clamp(state.morale - rng.int(6,12),0,100); playTone(160,0.2,'sawtooth',0.12);
    } else {
      state.resources.materials = Math.max(0, state.resources.materials - rng.int(1,3));
      state.morale = clamp(state.morale - rng.int(1,4),0,100);
      logAdd('æœ‰è¢­å‡»è¢«æŠµæŒ¡ï¼ŒæŸå¤±è‹¥å¹²ææ–™', 'info'); playTone(240,0.12,'square',0.06);
    }
  }

  // survivors small regen of stamina & hp
  for (const s of state.survivors){
    s.hp = Math.min(s.maxHp, s.hp + rng.int(0,1));
    s.stamina = Math.min(s.maxStamina, s.stamina + rng.int(0,2));
  }

  const end = checkEndings();
  if (end) { state.endings.reached = end.key; logAdd(`ç»“å±€è¾¾æˆï¼š${end.title}`, end.type === 'win' ? 'good' : 'danger'); presentEnding(end); saveAuto(); return; }

  saveAuto(); renderAll();
}

/* Endings */
function checkEndings(){
  if (state.survivors.length === 0) return { key:'all_dead', title:'å…¨å‘˜è¦†ç­', type:'lose' };
  if (state.eventsFlags['radio_fixed'] && state.eventsFlags['evac_hint'] && state.resources.materials >= 20 && state.day >= 5) {
    return { key:'evacuate_ready', title:'æ¥æ”¶åˆ°æ’¤ç¦»åæ ‡ï¼Œå¯ä»¥é€‰æ‹©æ’¤ç¦»', type:'win' };
  }
  if (state.day >= DEFAULT.dayLimitWin && state.base.wall >= 5) return { key:'fortress', title:'å»ºæˆè¦å¡ï¼Œåº¦è¿‡å±æœº', type:'win' };
  if (state.resources.food === 0 && state.morale < 8) return { key:'starvation', title:'é•¿æœŸé¥¥è’å¯¼è‡´å´©æºƒ', type:'lose' };
  return null;
}

function presentEnding(end){
  let text = '', choices = [];
  if (end.key === 'evacuate_ready') {
    text = `ä½ è·å¾—äº†æ’¤ç¦»åæ ‡ã€‚ç°åœ¨å¯ä»¥é€‰æ‹©ç«‹å³æ’¤ç¦»æˆ–ç»§ç»­ç•™å®ˆã€‚`;
    choices = [
      { text:'ç«‹å³æ’¤ç¦»ï¼ˆæœ‰æˆåŠŸç‡ï¼‰', handler: ()=> {
        const chance = clamp(0.5 + state.base.workshop*0.08 + (state.morale-50)/200, 0.15, 0.95);
        if (rng.chance(chance)) presentFinalScreen('æ’¤ç¦»æˆåŠŸï¼šè¢«æ•‘æ´é˜Ÿæ¥èµ°ï¼Œå¹¸å­˜ï¼', true);
        else { if (state.survivors.length>0) state.survivors.splice(0, Math.min(2, state.survivors.length)); presentFinalScreen('æ’¤ç¦»å¤±è´¥ï¼šæŸå¤±æƒ¨é‡', false); }
      }},
      { text:'æ‹’ç»æ’¤ç¦»ï¼Œç»§ç»­å·©å›ºåŸºåœ°', handler: ()=> { logAdd('é€‰æ‹©ç»§ç»­ç•™å®ˆ'); advanceDay(); } }
    ];
  } else if (end.key === 'fortress') {
    presentFinalScreen('ä½ ä»¬å»ºæˆäº†è¦å¡ï¼Œé•¿æœŸç”Ÿå­˜ä¸‹æ¥ã€‚', true); return;
  } else if (end.key === 'all_dead') {
    presentFinalScreen('æ²¡æœ‰å¹¸å­˜è€…ï¼Œæ•…äº‹ç»ˆç»“ã€‚', false); return;
  } else if (end.key === 'starvation') {
    presentFinalScreen('é¥¥é¥¿ä¸å£«æ°”å´©æºƒå¯¼è‡´å¤±è´¥ã€‚', false); return;
  } else {
    presentFinalScreen(end.title || 'ç»“å±€', end.type === 'win'); return;
  }
  pushStoryNode({ text, choices });
}

function presentFinalScreen(message, win){
  storyEl.textContent = message;
  choicesEl.innerHTML = '';
  const btn = document.createElement('button'); btn.className='choice'; btn.textContent='å¼€å§‹æ–°æ¸¸æˆ'; btn.onclick = ()=> { const seed = el('seed').value || Date.now().toString(); const diff = el('difficulty').value; newGame(seed, diff); };
  choicesEl.appendChild(btn);
  const note = document.createElement('div'); note.className='tiny'; note.style.marginTop='8px'; note.textContent = win ? 'ç»“å±€ï¼šç”Ÿå­˜' : 'ç»“å±€ï¼šå¤±è´¥';
  choicesEl.appendChild(note);
  if (win) playTone(880,0.24,'triangle',0.08); else playTone(140,0.5,'sawtooth',0.14);
  saveAuto();
}

/* ---------------- UI Bindings & Tutorial ---------------- */
el('new').addEventListener('click', ()=> { if (!confirm('å¼€å§‹æ–°æ¸¸æˆä¼šè¦†ç›–å½“å‰è¿›åº¦ï¼Œç¡®å®šï¼Ÿ')) return; const seed = el('seed').value || Date.now().toString(); const diff = el('difficulty').value; newGame(seed, diff); });
el('save').addEventListener('click', manualSave);
el('load').addEventListener('click', manualLoad);
el('export').addEventListener('click', exportSave);
el('import').addEventListener('click', importSave);
el('sound-toggle').addEventListener('click', (e)=>{ audioEnabled = !audioEnabled; e.target.textContent = 'éŸ³æ•ˆ: ' + (audioEnabled ? 'å¼€' : 'å…³'); });
el('help').addEventListener('click', ()=> showTutorial());

window.addEventListener('keydown', (ev)=>{
  if (!choicesEl) return;
  const items = Array.from(choicesEl.querySelectorAll('.choice:not(.disabled)'));
  if (ev.key === 'Enter' && items[0]) { items[0].click(); }
  if (/^[1-9]$/.test(ev.key)) { const idx = parseInt(ev.key,10)-1; if (items[idx]) items[idx].click(); }
});

/* Log panel controls */
el('toggle-log').addEventListener('click', ()=>{
  const panel = el('log-panel'); const btn = el('toggle-log');
  if (panel.style.display === 'none') { panel.style.display = 'block'; btn.textContent = 'æ”¶èµ·'; }
  else { panel.style.display = 'none'; btn.textContent = 'å±•å¼€'; }
});
el('clear-log').addEventListener('click', ()=> { if (!confirm('æ¸…é™¤æ—¥å¿—ï¼Ÿ')) return; state.log = []; renderLog(); });

/* Tutorial overlay */
function showTutorial(){ const ov = el('overlay'); ov.style.display='flex'; ov.setAttribute('aria-hidden','false'); }
function hideTutorial(){ const ov = el('overlay'); ov.style.display='none'; ov.setAttribute('aria-hidden','true'); }

el('close-tutorial').addEventListener('click', ()=> { hideTutorial(); state.eventsFlags.tutorialSeen = true; saveAuto(); });
el('start-tutorial').addEventListener('click', ()=> { hideTutorial(); demoOneTurn(); state.eventsFlags.tutorialSeen = true; saveAuto(); });

/* Demo a single guided turn */
function demoOneTurn(){
  logAdd('æ¼”ç¤ºï¼šæ´¾ä¸€äººæ‹¾è’ä½œä¸ºå¿«é€Ÿç¤ºä¾‹');
  const s = state.survivors.find(x=>x.stamina>2 && x.hp>1);
  if (!s) { logAdd('æ²¡æœ‰å¯ç¤ºèŒƒçš„å¥åº·å¹¸å­˜è€…'); renderAll(); return; }
  pushStoryNode({
    text: `ç¤ºä¾‹ï¼šä½ æ´¾ ${s.name} (${s.role}) å•ç‹¬å‡ºå¤–æ‹¾è’ã€‚æˆåŠŸæ—¶å°†å¸¦å›ç‰©èµ„ï¼Œå¤±è´¥å¯èƒ½å—ä¼¤ã€‚ä»¥ä¸‹ä¸ºä¸€æ¬¡ç¤ºä¾‹å®‰å…¨è¿”å›ï¼š`,
    choices: [
      { text:'æŸ¥çœ‹ç¤ºä¾‹ç»“æœ', handler: ()=> {
        const f = rng.int(3,6); const m = rng.int(1,3); state.resources.food += f; state.resources.materials += m; state.morale = clamp(state.morale + 2,0,100);
        logAdd(`${s.name} å®‰å…¨è¿”å›ï¼ˆç¤ºä¾‹ï¼‰ï¼šé£Ÿç‰© +${f}ã€ææ–™ +${m}`, 'good'); popStoryNode(true);
      }}
    ]
  });
}

/* ---------------- Init & New Game ---------------- */
function newGame(seedText, difficulty='normal'){
  rng = createRNG(seedText || Date.now().toString());
  state = {
    id: uid(),
    seed: seedText || '',
    version: 'v3',
    difficulty: difficulty || 'normal',
    day: 1,
    resources: JSON.parse(JSON.stringify(DEFAULT.resources)),
    base: JSON.parse(JSON.stringify(DEFAULT.baseModules)),
    survivors: JSON.parse(JSON.stringify(DEFAULT.survivors)),
    morale: 68,
    eventsFlags: { tutorialSeen:false },
    log: [],
    endings: { reached: null }
  };
  if (state.difficulty === 'hard') { state.resources.food = Math.max(8, Math.floor(state.resources.food*0.72)); state.resources.materials = Math.max(6, Math.floor(state.resources.materials*0.75)); state.morale = 52; }
  if (state.difficulty === 'easy') { state.resources.food = Math.floor(state.resources.food*1.25); state.resources.materials = Math.floor(state.resources.materials*1.2); state.morale = 75; }
  logAdd('æ¸¸æˆå¼€å§‹ï¼šä½ æ˜¯åŸºåœ°æŒ‡æŒ¥ã€‚ä½¿ç”¨å³ä¾§ç›‘æ§çŠ¶æ€ï¼Œå·¦ä¾§é€‰æ‹©ä»Šæ—¥è¡ŒåŠ¨ã€‚');
  saveAuto();
  renderAll();
  if (!state.eventsFlags.tutorialSeen) setTimeout(()=> showTutorial(), 350);
}

/* Load or new on start */
(function init(){
  try{
    const raw = localStorage.getItem(SAVE_KEY);
    if (raw) {
      if (confirm('æ£€æµ‹åˆ°å­˜æ¡£ï¼Œæ˜¯å¦åŠ è½½ï¼Ÿ(å–æ¶ˆå°†å¼€å§‹æ–°æ¸¸æˆ)')) { manualLoad(); return; }
    }
  }catch(e){}
  newGame(Date.now().toString(), el('difficulty').value);
})();
</script>
</body>
</html>
