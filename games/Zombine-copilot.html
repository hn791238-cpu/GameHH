<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æœ«æ—¥é€‰æ‹©ï¼šåŸºåœ°æ±‚ç”Ÿï¼ˆå‰§æƒ…åˆ†æ”¯ç‰ˆ â€” ä¼˜åŒ–ç‰ˆï¼‰</title>
  <style>
    :root{
      --bg:#06121a;
      --panel:#0b1f28;
      --accent:#ff9f1c;
      --accent-2:#ffb86b;
      --muted:#9fb0bd;
      --text:#e6eef6;
      --danger:#ff6b6b;
      --good:#6ee7b7;
      --glass: rgba(255,255,255,0.03);
      --card: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));
      font-family: Inter, "Noto Sans SC", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#041018,#07121a);color:var(--text);-webkit-font-smoothing:antialiased}
    .wrap{max-width:1180px;margin:18px auto;padding:14px;display:flex;flex-direction:column;gap:14px}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px}
    header h1{margin:0;font-size:1.15rem;letter-spacing:0.2px}
    .controls{display:flex;gap:8px;align-items:center}
    .controls input,.controls select{padding:7px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--panel);color:var(--text);min-width:120px}
    .controls button{background:var(--accent);border:none;padding:8px 12px;border-radius:10px;color:#041017;cursor:pointer;box-shadow:0 6px 14px rgba(255,159,28,0.06)}
    .controls .ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text);padding:7px 10px;border-radius:8px}
    main{display:flex;gap:14px}
    #left{flex:1;display:flex;flex-direction:column;gap:12px}
    .panel{background:var(--panel);padding:14px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.02)}
    #story-panel{min-height:420px;display:flex;flex-direction:column;gap:10px}
    #meta{display:flex;gap:10px;align-items:center;font-size:0.92rem;color:var(--muted)}
    .pill{background:var(--glass);padding:6px 8px;border-radius:8px;font-size:0.9rem;display:inline-flex;gap:8px;align-items:center}
    #story{min-height:260px;font-size:1rem;line-height:1.7;white-space:pre-wrap}
    #choices{display:flex;flex-direction:column;gap:10px;margin-top:4px}
    .choice{background:var(--card);border:1px solid rgba(255,255,255,0.03);padding:12px;border-radius:10px;cursor:pointer;text-align:left;display:flex;justify-content:space-between;align-items:center;transition:transform .12s ease, box-shadow .12s ease}
    .choice:hover{transform:translateY(-4px);box-shadow:0 10px 30px rgba(0,0,0,0.6)}
    .choice.disabled{opacity:0.45;cursor:not-allowed;transform:none;box-shadow:none}
    .choice .left{display:flex;gap:12px;align-items:center}
    .choice .icon{width:46px;height:46px;border-radius:8px;background:linear-gradient(180deg,#0f2a33,#042226);display:inline-flex;align-items:center;justify-content:center;font-size:20px}
    .choice .title{font-weight:600}
    .choice .meta{font-size:0.88rem;color:var(--muted)}
    .costs{display:flex;gap:8px;align-items:center;font-size:0.88rem}
    .cost-badge{background:rgba(0,0,0,0.12);padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,0.03)}
    #event-panel .small{margin-bottom:6px}
    #tags{display:flex;gap:8px;flex-wrap:wrap}
    .tag{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px;font-size:0.86rem;color:var(--muted)}
    #right{width:360px;display:flex;flex-direction:column;gap:12px}
    .res-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,0.03)}
    .res-left{display:flex;gap:12px;align-items:center}
    .res-ico{width:34px;height:34px;border-radius:8px;background:linear-gradient(180deg,#062a35,#04222a);display:flex;align-items:center;justify-content:center;font-size:18px}
    .bar{height:10px;background:rgba(255,255,255,0.04);border-radius:999px;overflow:hidden}
    .bar > i{display:block;height:100%;background:linear-gradient(90deg,var(--good),#ffd27a);width:0%}
    .survivor-card{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px}
    .survivor-info{display:flex;gap:8px;align-items:center}
    .hp{height:8px;background:rgba(0,0,0,0.14);border-radius:999px;overflow:hidden;width:120px}
    .hp > i{display:block;height:100%;background:linear-gradient(90deg,#ff8b6b,#ffea7a);width:0%}
    .small{font-size:0.86rem;color:var(--muted)}
    #log{height:220px;overflow:auto;font-family:monospace;font-size:0.85rem;padding:8px;background:rgba(0,0,0,0.04);border-radius:8px}
    footer{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:0.9rem}
    .hint{font-size:0.9rem;color:var(--muted)}
    /* Tutorial overlay */
    .overlay{position:fixed;inset:0;background:linear-gradient(180deg, rgba(2,6,10,0.6), rgba(2,6,10,0.8));display:flex;align-items:center;justify-content:center;z-index:60}
    .modal{background:var(--panel);padding:18px;border-radius:12px;max-width:720px;width:96%;box-shadow:0 18px 60px rgba(0,0,0,0.8);border:1px solid rgba(255,255,255,0.03)}
    .modal h3{margin:0 0 8px 0}
    .modal p{margin:8px 0;color:var(--muted)}
    .flex{display:flex;gap:8px;align-items:center}
    .muted-btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;color:var(--text);cursor:pointer}
    @media (max-width:980px){ main{flex-direction:column} #right{width:100%} .choice{flex-direction:column;align-items:flex-start} .choice .icon{width:40px;height:40px} }
  </style>
</head>
<body>
  <div class="wrap" role="application" aria-label="æœ«æ—¥é€‰æ‹©ï¼šåŸºåœ°æ±‚ç”Ÿ">
    <header>
      <h1>æœ«æ—¥é€‰æ‹©ï¼šåŸºåœ°æ±‚ç”Ÿï¼ˆä¼˜åŒ–ç‰ˆï¼‰</h1>
      <div class="controls" aria-hidden="false">
        ç§å­: <input id="seed" placeholder="å¯ç©ºï¼ˆå¤ç°å¡«å…¥ï¼‰" aria-label="ç§å­" />
        éš¾åº¦:
        <select id="difficulty" aria-label="éš¾åº¦">
          <option value="easy">ç®€å•</option>
          <option value="normal" selected>æ™®é€š</option>
          <option value="hard">å›°éš¾</option>
        </select>
        <button id="new" title="å¼€å§‹æ–°æ¸¸æˆ">æ–°æ¸¸æˆ</button>
        <button id="save" class="ghost muted" title="ä¿å­˜">ä¿å­˜</button>
        <button id="load" class="ghost muted" title="è¯»å–">è¯»å–</button>
        <button id="export" class="ghost muted" title="å¯¼å‡ºå­˜æ¡£">å¯¼å‡º</button>
        <button id="import" class="ghost muted" title="å¯¼å…¥å­˜æ¡£">å¯¼å…¥</button>
      </div>
    </header>

    <main>
      <section id="left">
        <div class="panel" id="story-panel" aria-live="polite">
          <div id="meta" class="small">
            <div class="pill">ç¬¬ <strong id="day">1</strong> å¤©</div>
            <div class="pill">å¹¸å­˜è€…: <strong id="count">0</strong></div>
            <div class="pill">å£«æ°”: <strong id="morale">0</strong></div>
            <div class="pill" title="è¿™æ˜¯ç¦»è¦å¡èƒœåˆ©æ‰€éœ€å¤©æ•°çš„è¿›åº¦">èƒœåˆ©è¿›åº¦ï¼š<strong id="progress">0%</strong></div>
          </div>

          <div id="story" aria-atomic="true"></div>

          <div id="choices" role="list"></div>
        </div>

        <div class="panel" id="event-panel">
          <div class="small">çº¿ç´¢ / äº‹ä»¶æ ‡è®°</div>
          <div id="tags" class="small" style="margin-top:8px"></div>
        </div>
      </section>

      <aside id="right">
        <div class="panel" aria-label="èµ„æºé¢æ¿">
          <div class="small" style="margin-bottom:8px">èµ„æº</div>
          <div class="res-row"><div class="res-left"><div class="res-ico">ğŸ—</div><div>é£Ÿç‰©</div></div><div><strong id="res-food">0</strong></div></div>
          <div class="res-row"><div class="res-left"><div class="res-ico">ğŸ”§</div><div>ææ–™</div></div><div><strong id="res-materials">0</strong></div></div>
          <div class="res-row"><div class="res-left"><div class="res-ico">ğŸ”«</div><div>å¼¹è¯</div></div><div><strong id="res-ammo">0</strong></div></div>
          <div style="margin-top:8px" class="small">æç¤ºï¼šé¼ æ ‡æ‚¬åœé€‰é¡¹å¯æŸ¥çœ‹èŠ±è´¹/é£é™©</div>
        </div>

        <div class="panel" aria-label="åŸºåœ°é¢æ¿">
          <div class="small">åŸºåœ°</div>
          <div id="base-stats" style="margin-top:8px">
            <div class="res-row"><div>å¢™ç­‰çº§</div><div id="wall">0</div></div>
            <div class="res-row"><div>å†œåœºç­‰çº§</div><div id="farm">0</div></div>
            <div class="res-row"><div>å·¥åŠç­‰çº§</div><div id="workshop">0</div></div>
          </div>
        </div>

        <div class="panel" aria-label="å¹¸å­˜è€…é¢æ¿">
          <div class="small">å¹¸å­˜è€…</div>
          <div id="survivors" style="margin-top:8px"></div>
          <div style="margin-top:8px" class="small">ä½ å¯ä»¥åœ¨â€œæ´¾äººæ‹¾è’â€æ—¶é€‰æ‹©å•äººæˆ–å…¨é˜Ÿã€‚å—ä¼¤çš„å¹¸å­˜è€…ä¸å¯æ´¾å‡ºã€‚</div>
        </div>

        <div class="panel" aria-label="æ—¥å¿—">
          <div class="small">æ—¥å¿—</div>
          <div id="log"></div>
        </div>
      </aside>
    </main>

    <footer>
      <div class="hint">ç©æ³•ï¼šæ¯å¤©é€‰æ‹©ä¸€é¡¹è¡ŒåŠ¨ â†’ ç«‹å³æŸ¥çœ‹ç»“æœ â†’ æ¬¡æ—¥è‡ªåŠ¨æ¨è¿›ã€‚ç›®æ ‡ï¼šä¿æŒç”Ÿè¿˜å¹¶è¾¾æˆä¸åŒç»“å±€ã€‚</div>
      <div>
        <button id="sound-toggle" class="ghost muted">éŸ³æ•ˆ: å¼€</button>
        <button id="help" class="muted-btn" style="margin-left:8px">æ–°æ‰‹å¼•å¯¼</button>
      </div>
    </footer>
  </div>

  <!-- Tutorial / Onboarding Overlay -->
  <div id="overlay" class="overlay" style="display:none" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <h3>æ¬¢è¿æ¥åˆ°åŸºåœ°æ±‚ç”Ÿ â€” å¿«é€Ÿæ–°æ‰‹å¼•å¯¼</h3>
      <p>è¿™æ˜¯ä¸€ä¸ªå‰§æƒ…é€‰æ‹©ä¸ºæ ¸å¿ƒçš„æœ«æ—¥æ±‚ç”Ÿæ¸¸æˆã€‚æ¯ä¸€å¤©ä½ å¯ä»¥é€‰æ‹©ä¸€é¡¹ä¸»è¦è¡ŒåŠ¨ï¼ˆä¾‹å¦‚ï¼šæ‹¾è’ã€åŠ å›ºã€é˜²å®ˆã€ä¿®ç†æ”¶éŸ³æœºç­‰ï¼‰ã€‚é€‰æ‹©ä¼šç«‹å³äº§ç”Ÿç»“æœï¼Œå¹¶å½±å“èµ„æºã€å¹¸å­˜è€…å’Œå£«æ°”ã€‚</p>
      <ul>
        <li>å±å¹•å³ä¾§æ˜¾ç¤ºèµ„æºä¸å¹¸å­˜è€…çŠ¶æ€ï¼Œå·¦ä¾§æ˜¯å½“å‰äº‹ä»¶ä¸å¯é€‰æ“ä½œã€‚</li>
        <li>ç¬¬ä¸€æ¬¡æ¸¸ç©æ—¶ï¼Œå»ºè®®å…ˆæ´¾ 1 äººæ‹¾è’ä»¥ç†Ÿæ‚‰æˆåŠŸ/å¤±è´¥çš„èŠ‚å¥ï¼Œä¿å­˜å¤šæ¬¡å°è¯•ã€‚</li>
        <li>å·¥åŠå‡çº§èƒ½è§£é”å…³é”®é€‰é¡¹ï¼ˆå¦‚ä¿®æ”¶éŸ³æœºï¼‰ã€‚å†œåœºæå‡å¯ç¨³å®šé£Ÿç‰©äº§å‡ºã€‚</li>
        <li>æ³¨æ„å£«æ°”å’Œé£Ÿç‰©ï¼Œé•¿æœŸä½é£Ÿç‰©ä¼šå¯¼è‡´ä¼¤äº¡æˆ–å¤±è´¥ã€‚</li>
      </ul>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button id="start-tutorial" class="muted-btn">æ¼”ç¤ºä¸€è½®</button>
        <button id="close-tutorial" class="muted-btn">å…³é—­</button>
      </div>
    </div>
  </div>

<script>
/* ä¼˜åŒ–ç‰ˆ game.jsï¼ˆå†…åµŒï¼‰
   ä¸»è¦æ”¹åŠ¨ï¼š
   - æ–°æ‰‹å¼•å¯¼ overlay / tutorial ä¸€é”®æ¼”ç¤º
   - UI æ”¹å–„ï¼šchoice å¡ç‰‡æ˜¾ç¤ºæˆæœ¬/å›¾æ ‡ï¼Œdisabled çŠ¶æ€ï¼Œèµ„æºæç¤º
   - Gameplay balance è°ƒæ•´ï¼šæ‹¾è’/åŠ«æ æˆåŠŸç‡/æ”¶ç›Šæ›´å¹³æ»‘ï¼Œäº‹ä»¶æ›´å°‘éšæœºæç«¯ç»“æœ
   - æ–°å¢ progress æ˜¾ç¤ºï¼ˆåˆ° fortress èƒœåˆ©çš„è¿›åº¦æç¤ºï¼‰
   - æ›´ä¸¥æ ¼çš„ç©ºçŠ¶æ€æ£€æŸ¥ï¼ˆé¿å…æ“ä½œå—ä¼¤æˆ–æ— äººçš„æƒ…å†µï¼‰
*/

/* --------- RNG --------- */
function createRNG(seed) {
  let h = 2166136261 >>> 0;
  if (!seed) seed = Math.random().toString();
  for (let i=0;i<seed.length;i++){ h = Math.imul(h ^ seed.charCodeAt(i), 16777619); }
  let state = h >>> 0;
  return {
    next() { state ^= state << 13; state ^= state >>> 17; state ^= state << 5; state = state >>> 0; return state / 0x100000000; },
    chance(p){ return this.next() < p; },
    int(min,max){ return Math.floor(this.next()*(max-min+1))+min; }
  };
}

/* --------- Defaults & State --------- */
const DEFAULT = {
  resources: { food: 65, materials: 44, ammo: 18 },
  baseModules: { wall: 1, farm: 0, workshop: 0 },
  survivors: [
    { id:1, name:'é˜¿æ˜', hp:8, maxHp:8, task:'idle' },
    { id:2, name:'è‰è', hp:7, maxHp:7, task:'idle' }
  ],
  dayLimitWin: 30
};

let state = null;
let rng = createRNG(Date.now().toString());
let audioEnabled = true;
let audioCtx = null;
const SAVE_KEY = 'story_rogue_save_v2';

/* --------- Utilities --------- */
function uid(){ return Math.floor(Math.random()*1e9).toString(36) + Date.now().toString(36); }
function el(id){ return document.getElementById(id); }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function playTone(freq=440, duration=0.12, type='sine', gain=0.06){
  if (!audioEnabled) return;
  try{
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type; o.frequency.value = freq;
    g.gain.value = gain;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
    setTimeout(()=>o.stop(), duration*1000 + 20);
  }catch(e){ /* audio may be blocked by browser until gesture */ }
}

/* --------- Persistence --------- */
function saveAuto(){ try{ localStorage.setItem(SAVE_KEY, JSON.stringify(state)); }catch(e){ console.error(e); } }
function manualSave(){ saveAuto(); logAdd('æ¸¸æˆå·²ä¿å­˜'); renderLog(); }
function manualLoad(){
  try{
    const raw = localStorage.getItem(SAVE_KEY);
    if (!raw) { logAdd('æœªæ‰¾åˆ°å­˜æ¡£'); renderLog(); return; }
    state = JSON.parse(raw);
    rng = createRNG(state.seed || Date.now().toString());
    logAdd('å­˜æ¡£å·²åŠ è½½');
    renderAll();
  }catch(e){ logAdd('è¯»å–å­˜æ¡£å¤±è´¥'); console.error(e); }
}
function exportSave(){
  try{
    const raw = JSON.stringify(state);
    const blob = new Blob([raw], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'save_story.json'; a.click();
    URL.revokeObjectURL(url);
    logAdd('å·²å¯¼å‡ºå­˜æ¡£');
  }catch(e){ logAdd('å¯¼å‡ºå¤±è´¥'); }
}
function importSave(){
  const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange = ()=> {
    const f = inp.files[0]; if (!f) return;
    const r = new FileReader();
    r.onload = ()=> {
      try{
        localStorage.setItem(SAVE_KEY, r.result);
        manualLoad();
        logAdd('å·²å¯¼å…¥å­˜æ¡£');
      }catch(e){ logAdd('å¯¼å…¥å¤±è´¥'); }
    };
    r.readAsText(f);
  };
  inp.click();
}

/* --------- Logging --------- */
function logAdd(text, type='info'){
  if (!state) return;
  state.log.unshift({ id: uid(), t: text, ts: Date.now(), type });
  if (state.log.length > 250) state.log.length = 250;
  renderLog();
}

/* --------- Rendering --------- */
function renderAll(){
  if (!state) return;
  el('day').textContent = state.day;
  el('count').textContent = state.survivors.length;
  el('morale').textContent = state.morale;
  el('res-food').textContent = state.resources.food;
  el('res-materials').textContent = state.resources.materials;
  el('res-ammo').textContent = state.resources.ammo;
  el('wall').textContent = state.base.wall;
  el('farm').textContent = state.base.farm;
  el('workshop').textContent = state.base.workshop;
  const progress = Math.round((state.day / DEFAULT.dayLimitWin) * 100);
  el('progress').textContent = progress + '%';
  renderSurvivors();
  renderLog();
  // presentDayOptions only if not in a sub-node
  if (!currentNode) presentDayOptions();
  renderTags();
}

/* Survivors */
function renderSurvivors(){
  const box = el('survivors'); box.innerHTML = '';
  for (const s of state.survivors){
    const div = document.createElement('div'); div.className='survivor-card';
    const left = document.createElement('div'); left.className='survivor-info';
    left.innerHTML = `<div style="width:42px;height:42px;border-radius:8px;background:linear-gradient(180deg,#0b2c2f,#042022);display:flex;align-items:center;justify-content:center">${s.name.charAt(0)}</div>
      <div><div style="font-weight:600">${s.name}</div>
      <div style="display:flex;gap:8px;align-items:center"><div class="hp" title="ç”Ÿå‘½å€¼"><i style="width:${Math.round((s.hp/s.maxHp)*100)}%"></i></div><div class="small">${s.hp}/${s.maxHp}</div></div></div>`;
    const right = document.createElement('div'); right.style.textAlign='right';
    const task = document.createElement('div'); task.className='small'; task.textContent = s.task || 'ç©ºé—²';
    right.appendChild(task);
    // add quick action only for idle & healthy survivors
    if (s.hp > 1) {
      const btn = document.createElement('button'); btn.className='muted-btn'; btn.style.marginTop='6px'; btn.textContent='æ ‡è®°ä¸ºå“¨å…µ';
      btn.onclick = ()=> { s.task = s.task === 'sentry' ? 'idle' : 'sentry'; logAdd(`${s.name} çš„ä»»åŠ¡å˜æ›´ä¸º ${s.task}`); saveAuto(); renderAll(); };
      right.appendChild(btn);
    }
    div.appendChild(left); div.appendChild(right);
    box.appendChild(div);
  }
}

/* Log */
function renderLog(){
  const node = el('log'); if (!node) return;
  node.innerHTML = '';
  for (const e of state.log.slice(0,80)){
    const d = document.createElement('div');
    d.textContent = `[${new Date(e.ts).toLocaleTimeString()}] ${e.t}`;
    d.style.opacity = e.type === 'danger' ? '1' : '0.95';
    node.appendChild(d);
  }
}

/* Tags */
function renderTags(){
  const container = el('tags'); container.innerHTML = '';
  for (const k of Object.keys(state.eventsFlags || {})) {
    if (state.eventsFlags[k]) {
      const t = document.createElement('div'); t.className='tag'; t.textContent = k.replace('_',' ');
      container.appendChild(t);
    }
  }
}

/* --------- Story System --------- */
const storyEl = el('story');
const choicesEl = el('choices');
let currentNode = null;

function presentDayOptions(){
  if (currentNode) return;
  storyEl.textContent = `ç¬¬ ${state.day} å¤©ã€‚\n\næ¸…æ™¨ï¼Œä½ æ£€æŸ¥åŸºåœ°ï¼šé£Ÿç‰© ${state.resources.food}ï¼Œææ–™ ${state.resources.materials}ï¼Œå¹¸å­˜è€… ${state.survivors.length}ã€‚é€‰æ‹©ä»Šå¤©çš„ä¸»è¦è¡ŒåŠ¨ï¼š`;
  const options = [
    { id:'scavenge', title:'æ´¾äººå¤–å‡ºæ‹¾è’', subtitle:'é«˜é£é™©ï¼Œé«˜å›æŠ¥', icon:'ğŸ§­', fn: actionScavenge, costs: null, enabled: state.survivors.some(s=>s.hp>1) },
    { id:'fortify', title:'åŠ å›ºé˜²å¾¡ / å‡çº§æ¨¡å—', subtitle:'æ¶ˆè€—ææ–™ï¼Œæå‡ç”Ÿå­˜', icon:'ğŸ› ï¸', fn: actionFortify, costs:{materials:8}, enabled: state.resources.materials >= 4 },
    { id:'rest', title:'å…¨ä½“ä¼‘æ•´', subtitle:'æ¢å¤ç”Ÿå‘½ä¸å£«æ°”ï¼Œæ¶ˆè€—å°‘é‡é£Ÿç‰©', icon:'ğŸ›Œ', fn: actionRest, costs:{food: state.survivors.length}, enabled: state.resources.food >= 1 }
  ];
  if (state.base.workshop >= 1) options.push({ id:'radio', title:'ä¿®å¤æ”¶éŸ³æœºå¹¶å‘é€ä¿¡å·', subtitle:'å¯èƒ½è·å¾—æ’¤ç¦»çº¿ç´¢', icon:'ğŸ“»', fn: actionRadio, costs:{materials:6}, enabled: state.resources.materials >= 6 });
  options.push({ id:'event', title:'è°ƒæŸ¥é™„è¿‘å¼‚å¸¸', subtitle:'è§¦å‘éšæœºäº‹ä»¶', icon:'â“', fn: actionEvent, costs:null, enabled:true });
  if (state.resources.food < 18) options.push({ id:'raid', title:'ç»„ç»‡åŠ«æ ï¼ˆé«˜é£é™©ï¼‰', subtitle:'é«˜é£é™©ä½†å¯èƒ½å¤§é‡è·å¾—é£Ÿç‰©', icon:'âš”ï¸', fn: actionRaid, costs:null, enabled: state.survivors.length > 0 });

  renderChoices(options.map(o=>({
    text: o.title,
    description: o.subtitle,
    icon: o.icon,
    onClick: ()=> o.enabled ? o.fn() : (logAdd('å½“å‰æ¡ä»¶ä¸æ»¡è¶³è¯¥è¡ŒåŠ¨'), playTone(240,0.06,'sine',0.03)),
    costs: o.costs,
    enabled: o.enabled
  })));
}

/* Render choices with cost badges and disabled state */
function renderChoices(items){
  choicesEl.innerHTML = '';
  for (const it of items){
    const btn = document.createElement('button'); btn.className='choice' + (it.enabled ? '' : ' disabled'); btn.setAttribute('role','listitem');
    const left = document.createElement('div'); left.className='left';
    const ico = document.createElement('div'); ico.className='icon'; ico.textContent = it.icon || 'â”';
    const txt = document.createElement('div');
    const title = document.createElement('div'); title.className='title'; title.textContent = it.text;
    const meta = document.createElement('div'); meta.className='meta'; meta.textContent = it.description || '';
    txt.appendChild(title); txt.appendChild(meta);
    left.appendChild(ico); left.appendChild(txt);
    const right = document.createElement('div'); right.style.display='flex'; right.style.flexDirection='column'; right.style.alignItems='flex-end';
    if (it.costs) {
      const costsWrap = document.createElement('div'); costsWrap.className='costs';
      for (const k of Object.keys(it.costs)) {
        const b = document.createElement('div'); b.className='cost-badge'; b.textContent = `${k}: ${it.costs[k]}`; costsWrap.appendChild(b);
      }
      right.appendChild(costsWrap);
    }
    const hint = document.createElement('div'); hint.className='small'; hint.style.marginTop='6px'; hint.textContent = it.enabled ? '' : 'æ¡ä»¶ä¸æ»¡è¶³';
    right.appendChild(hint);
    btn.appendChild(left); btn.appendChild(right);
    btn.onclick = ()=> { if (!it.enabled) return; it.onClick && it.onClick(); };
    // hover tooltip showing costs & risks for accessibility
    btn.title = `${it.text} â€” ${it.description || ''}` + (it.costs ? ' | æˆæœ¬ï¼š' + Object.entries(it.costs).map(([k,v])=>k+':'+v).join(',') : '');
    choicesEl.appendChild(btn);
  }
}

/* Story node push/pop */
function pushStoryNode(node){
  currentNode = node;
  storyEl.innerHTML = node.text;
  choicesEl.innerHTML = '';
  node.choices.forEach(c=>{
    const btn = document.createElement('button'); btn.className='choice';
    btn.innerHTML = `<div class="left"><div class="icon">â€¢</div><div><div class="title">${c.text}</div><div class="meta">${c.meta||''}</div></div></div><div style="display:flex;flex-direction:column;align-items:flex-end"><div class="small">${c.hint||''}</div></div>`;
    btn.onclick = ()=> { if (c.handler) c.handler(); };
    choicesEl.appendChild(btn);
  });
}

function popStoryNode(advance=true){
  currentNode = null;
  if (advance) advanceDay(); else renderAll();
}

/* --------- Actions (improved balance & safety checks) --------- */

function actionScavenge(){
  if (state.survivors.length === 0) { logAdd('æ²¡æœ‰å¯æ´¾å‡ºçš„äººæ‰‹ï¼'); renderAll(); return; }
  const healthy = state.survivors.filter(s=>s.hp>1);
  if (healthy.length === 0) { logAdd('ç›®å‰æ²¡æœ‰å¥åº·çš„å¹¸å­˜è€…å¯ä»¥å¤–å‡º'); renderAll(); return; }
  const choices = healthy.map(s=>({ text:`æ´¾ ${s.name} å•ç‹¬å¤–å‡º`, handler: ()=> scavengeRun([s]), meta:'å•äººé£é™©è¾ƒä½' }));
  choices.push({ text:'æ´¾å‡ºå…¨éƒ¨é˜Ÿä¼ï¼ˆé«˜å›æŠ¥ã€é«˜é£é™©ï¼‰', handler: ()=> scavengeRun(state.survivors.slice()), meta:'æ¶ˆè€—æ›´å¤šä½“åŠ›/é£é™©' });
  choices.push({ text:'å–æ¶ˆ', handler: ()=> popStoryNode(false) });
  pushStoryNode({ text:'ä½ è¦æ´¾è°å»æ‹¾è’ï¼Ÿ', choices });
}

function scavengeRun(team){
  const teamNames = team.map(s=>s.name).join('ã€');
  logAdd(`${teamNames} å‡ºå‘æ‹¾è’`);
  playTone(880,0.06,'triangle',0.04);
  const baseSuccess = 0.48 + (team.length-1)*0.10 + (state.morale-50)/400 + (state.base.workshop*0.02);
  const success = rng.chance(clamp(baseSuccess, 0.1, 0.95));
  if (success){
    const food = rng.int(2,6) * team.length;
    const mats = rng.int(1,4) * Math.max(1, Math.floor(team.length/2));
    const ammo = rng.int(0,2) * Math.max(1, Math.floor(team.length/2));
    state.resources.food += food; state.resources.materials += mats; state.resources.ammo += ammo;
    if (rng.chance(0.09)) { state.eventsFlags['distress_note'] = true; logAdd(`${teamNames} å‘ç°æ±‚æ•‘ä¾¿ç­¾ / çº¿ç´¢`, 'good'); }
    else logAdd(`${teamNames} å®‰å…¨è¿”å›ï¼šé£Ÿç‰© ${food}ã€ææ–™ ${mats}ã€å¼¹è¯ ${ammo}`, 'good');
    state.morale = clamp(state.morale + rng.int(1,3), 0, 100);
  } else {
    // less brutal: prefer injuries over instant death, but possible loss if large raid
    if (team.length > 1 && rng.chance(0.25)) {
      const lost = team.splice(rng.int(0, team.length-1),1)[0];
      state.survivors = state.survivors.filter(s=>s.id !== lost.id);
      logAdd(`${teamNames} é­é‡å†²çªï¼Œ${lost.name} æœªèƒ½è¿”å›`, 'danger');
      playTone(120,0.28,'sawtooth',0.08);
      state.morale = clamp(state.morale - rng.int(6,11), 0, 100);
    } else {
      for (const mem of team){
        if (rng.chance(0.45)) {
          const dmg = rng.int(1,3); mem.hp = Math.max(0, mem.hp - dmg); logAdd(`${mem.name} å—ä¼¤ -${dmg} HP`);
        }
      }
      const f = rng.int(0,3); const m = rng.int(0,2);
      state.resources.food += f; state.resources.materials += m;
      logAdd(`${teamNames} å—æŒ«è¿”å›ï¼ˆå¸¦å›å°‘é‡ç‰©èµ„ï¼‰`, 'danger');
      playTone(220,0.08,'square',0.05);
      state.morale = clamp(state.morale - rng.int(2,5), 0, 100);
    }
  }
  popStoryNode(true);
}

function actionFortify(){
  const choices = [
    { text:'æ¶ˆè€— 10 ææ–™ å»ºé€ /å‡çº§ å¢™ (+1)', handler: ()=> {
      if (state.resources.materials < 10) { logAdd('ææ–™ä¸è¶³'); renderAll(); return; }
      state.resources.materials -= 10; state.base.wall += 1;
      logAdd('åŠ å›ºå¢™ä½“ï¼Œæå‡é˜²å¾¡', 'good'); playTone(520,0.08,'sine',0.06);
      advanceDay();
    }, meta:'è€ä¹…æå‡' },
    { text:'æ¶ˆè€— 8 ææ–™ å‡çº§ å†œåœº (+1)', handler: ()=> {
      if (state.resources.materials < 8) { logAdd('ææ–™ä¸è¶³'); renderAll(); return; }
      state.resources.materials -= 8; state.base.farm += 1;
      logAdd('å‡çº§å†œåœºï¼Œæé«˜äº§å‡º', 'good'); playTone(660,0.08,'sine',0.06);
      advanceDay();
    }, meta:'ç¨³å®šäº§å‡º' },
    { text:'æ¶ˆè€— 12 ææ–™ å‡çº§ å·¥åŠ (+1)', handler: ()=> {
      if (state.resources.materials < 12) { logAdd('ææ–™ä¸è¶³'); renderAll(); return; }
      state.resources.materials -= 12; state.base.workshop += 1;
      logAdd('å·¥åŠå‡çº§ï¼Œè§£é”ä¿®æ”¶éŸ³æœºç­‰é€‰é¡¹', 'good'); playTone(720,0.08,'sine',0.06);
      advanceDay();
    }, meta:'è§£é”é€‰é¡¹' },
    { text:'å–æ¶ˆ', handler: ()=> popStoryNode(false) }
  ];
  pushStoryNode({ text:'é€‰æ‹©è¦å»ºé€ /å‡çº§çš„æ¨¡å—ï¼š', choices });
}

function actionRest(){
  const healTotal = rng.int(1,3);
  for (const s of state.survivors){ s.hp = Math.min(s.maxHp, s.hp + healTotal); }
  state.morale = clamp(state.morale + rng.int(4,9), 0, 100);
  state.resources.food = Math.max(0, state.resources.food - state.survivors.length);
  logAdd(`å…¨ä½“ä¼‘æ•´ï¼šæ¢å¤ ${healTotal} HPï¼Œæ¶ˆè€— é£Ÿç‰© ${state.survivors.length}`,'info');
  playTone(440,0.12,'sine',0.06);
  advanceDay();
}

function actionRadio(){
  if (state.base.workshop < 1){ logAdd('éœ€è¦å·¥åŠæ¥ä¿®ç†æ”¶éŸ³æœº'); renderAll(); return; }
  const choices = [
    { text:'ç”¨ææ–™ä¿®å¤å¤©çº¿ï¼ˆ6 ææ–™ï¼‰', handler: ()=> {
      if (state.resources.materials < 6) { logAdd('ææ–™ä¸è¶³'); renderAll(); return; }
      state.resources.materials -= 6;
      const base = 0.45 + state.base.workshop * 0.12;
      if (rng.chance(clamp(base,0.22,0.95))) {
        state.eventsFlags['radio_fixed'] = true;
        logAdd('æ”¶éŸ³æœºä¿®å¤æˆåŠŸå¹¶å‘é€ä¿¡å·ï¼Œä½ è·å¾—äº†æ’¤ç¦»çº¿ç´¢ï¼ˆéœ€æ›´å¤šæ¡ä»¶ï¼‰', 'good');
        playTone(980,0.12,'triangle',0.07);
      } else {
        state.eventsFlags['radio_partial'] = true;
        logAdd('ä¿®å¤å°è¯•å¤±è´¥ï¼Œä½†è®°å½•äº†ä¿®å¤è¦ç‚¹', 'info');
        playTone(240,0.08,'sine',0.04);
      }
      popStoryNode(true);
    }},
    { text:'æ”¾å¼ƒå¹¶è¿”å›', handler: ()=> popStoryNode(false) }
  ];
  pushStoryNode({ text:'ä¿®ç†æ”¶éŸ³æœºéœ€è¦ææ–™å¹¶æœ‰æˆåŠŸç‡ï¼Œä½ è¦å¦‚ä½•æ“ä½œï¼Ÿ', choices });
}

function actionEvent(){
  const pool = [eventAbandonedHouse, eventStrangeSignal, eventWoundedTraveller, eventRationFind];
  const ev = pool[rng.int(0, pool.length-1)]; ev();
}

/* Events (cleaned & balanced) */
function eventAbandonedHouse(){
  const text = `éƒŠå¤–ä¸€å¤„æ—§å®…å¯èƒ½æœ‰å‚¨å¤‡ï¼Œä½†é™„è¿‘æœ‰æ´»åŠ¨ç—•è¿¹ã€‚è¦å»ä¾¦æŸ¥å—ï¼Ÿ`;
  const choices = [
    { text:'æ´¾ä¸€äººä¾¦æŸ¥ï¼ˆä½é£é™©ï¼‰', handler: ()=> {
      if (state.survivors.length === 0) { logAdd('æ²¡æœ‰äººå¯æ´¾'); popStoryNode(false); return; }
      const s = state.survivors[rng.int(0, state.survivors.length-1)];
      logAdd(`${s.name} å•ç‹¬ä¾¦æŸ¥æ—§å®…`);
      if (rng.chance(0.55)) {
        const food = rng.int(3,8); state.resources.food += food; logAdd(`${s.name} æ‰¾åˆ° é£Ÿç‰© ${food}`, 'good');
      } else {
        pushStoryNode({
          text: `${s.name} é‡åˆ°å¦ä¸€ç»„å¹¸å­˜è€…ï¼Œå¯¹æ–¹æˆ’å¤‡ã€‚åº”è¯¥å¦‚ä½•åº”å¯¹ï¼Ÿ`,
          choices:[
            { text:'è°ˆåˆ¤ï¼ˆæœ‰æœºä¼šè·å¾—ç›Ÿå‹ï¼‰', handler: ()=> {
              if (rng.chance(0.48 + (state.morale-50)/200)) {
                const newOne = { id: uid(), name: 'ç±³å¨…', hp:7, maxHp:7, task:'idle' };
                state.survivors.push(newOne);
                state.morale = clamp(state.morale+6,0,100);
                logAdd('è°ˆåˆ¤æˆåŠŸï¼šç±³å¨… åŠ å…¥', 'good');
                popStoryNode(true);
              } else {
                state.resources.materials = Math.max(0, state.resources.materials - rng.int(1,4));
                logAdd('è°ˆåˆ¤å¤±è´¥ï¼Œå¤±å»éƒ¨åˆ†ææ–™', 'danger');
                popStoryNode(true);
              }
            }},
            { text:'æ’¤é€€', handler: ()=> { logAdd('æ’¤é€€ï¼Œé¿å…å†²çª'); popStoryNode(true); } }
          ]
        });
      }
    }},
    { text:'æ´¾å…¨ä½“æœæŸ¥ï¼ˆé«˜é£é™©ï¼‰', handler: ()=> {
      if (state.survivors.length <= 0) { logAdd('æ²¡æœ‰äººå¯æ´¾'); popStoryNode(false); return; }
      if (rng.chance(0.42 + state.survivors.length*0.04)) {
        const f = rng.int(6,14); state.resources.food += f; state.resources.materials += rng.int(1,4);
        logAdd('å…¨ä½“æœæŸ¥å¤§è·æ”¶è·ï¼šé£Ÿç‰© '+f, 'good');
      } else {
        const lost = state.survivors.splice(rng.int(0, state.survivors.length-1),1)[0];
        logAdd(`${lost.name} åœ¨å†²çªä¸­ç‰ºç‰²`, 'danger');
        state.morale = clamp(state.morale - 10, 0, 100);
      }
      popStoryNode(true);
    }},
    { text:'æ”¾å¼ƒ', handler: ()=> { logAdd('æ”¾å¼ƒè¯¥åœ°ç‚¹'); popStoryNode(false); } }
  ];
  pushStoryNode({ text, choices });
}

function eventStrangeSignal(){
  const text = `å¤œé‡Œæœ‰äººå¬è§è¿œå¤„åå¤çš„ä¿¡å·å£°ï¼Œå¯èƒ½æ˜¯æ±‚æ•‘ä¹Ÿå¯èƒ½æ˜¯é™·é˜±ã€‚`;
  const choices = [
    { text:'å›åº”ä¿¡å·ï¼ˆå¯èƒ½è·å¾—æ’¤ç¦»çº¿ç´¢ï¼‰', handler: ()=> {
      if (rng.chance(0.4 + (state.base.workshop*0.06))) {
        state.eventsFlags['evac_hint'] = true;
        logAdd('å›åº”ä¿¡å·åè·å¾—äº†æ’¤ç¦»çº¿ç´¢', 'good'); playTone(990,0.08,'sine',0.06);
      } else {
        state.resources.food = Math.max(0, state.resources.food - rng.int(2,6));
        state.morale = clamp(state.morale - rng.int(3,7),0,100);
        logAdd('ä¿¡å·æ˜¯é™·é˜±ï¼ŒæŸå¤±é£Ÿç‰©ä¸”å£«æ°”ä¸‹é™', 'danger'); playTone(200,0.12,'sawtooth',0.08);
      }
      popStoryNode(true);
    }},
    { text:'æ´¾å“¨è§‚å¯Ÿï¼ˆä½é£é™©ï¼‰', handler: ()=> {
      if (rng.chance(0.5)) { state.resources.materials += rng.int(1,4); logAdd('è§‚å¯Ÿåˆ°çº¿ç´¢å¹¶å›æ”¶ææ–™', 'good'); }
      else logAdd('è§‚å¯Ÿæœªå‘ç°å®è´¨ä¿¡æ¯');
      popStoryNode(true);
    }},
    { text:'å¿½ç•¥', handler: ()=> { logAdd('é€‰æ‹©å¿½ç•¥ä¿¡å·'); popStoryNode(true); } }
  ];
  pushStoryNode({ text, choices });
}

function eventWoundedTraveller(){
  const text = `å—ä¼¤çš„æ—…äººï¿½ï¿½é—¨æ±‚åŠ©ï¼Œä»–æ„¿æ„äº¤æ¢ä¿¡æ¯æˆ–åŠ³åŠ›ã€‚`;
  const choices = [
    { text:'æ”¶ç•™å¹¶æ²»ç–—ï¼ˆ4 é£Ÿç‰©, 2 ææ–™ï¼‰', handler: ()=> {
      if (state.resources.food < 4 || state.resources.materials < 2) { logAdd('èµ„æºä¸è¶³æ— æ³•æ”¶ç•™'); popStoryNode(false); return; }
      state.resources.food -= 4; state.resources.materials -= 2;
      const newOne = { id: uid(), name: 'æ—…äºº', hp: rng.int(4,8), maxHp: rng.int(6,9), task:'idle' };
      state.survivors.push(newOne);
      state.morale = clamp(state.morale + 8, 0, 100);
      logAdd('æ•‘åŠ©æ—…äººï¼ŒåŠ å…¥é˜Ÿä¼', 'good');
      popStoryNode(true);
    }},
    { text:'ç”¨å°‘é‡é£Ÿç‰©æ¢ä¿¡æ¯ï¼ˆ2 é£Ÿç‰©ï¼‰', handler: ()=> {
      if (state.resources.food < 2) { logAdd('é£Ÿç‰©ä¸è¶³'); popStoryNode(false); return; }
      state.resources.food -= 2; state.eventsFlags['map_clue'] = true; logAdd('ç”¨é£Ÿç‰©æ¢æ¥æ—§åœ°å›¾çº¿ç´¢', 'good'); popStoryNode(true);
    }},
    { text:'æ‹’ç»', handler: ()=> { logAdd('æ‹’ç»æ—…äººï¼Œå£«æ°”ä¸‹é™'); state.morale = clamp(state.morale-3,0,100); popStoryNode(true); } }
  ];
  pushStoryNode({ text, choices });
}

function eventRationFind(){
  const text = `å‘ç°ä¸€ä¸ªç ´æ—§èƒŒåŒ…ï¼Œå¯èƒ½æœ‰å°é‡ç‰©èµ„æˆ–ç©ºåŒ…ã€‚`;
  const choices = [
    { text:'æœæŸ¥ï¼ˆå°æ¦‚ç‡è·ç‰©èµ„ï¼‰', handler: ()=> {
      if (rng.chance(0.58)) { const f = rng.int(1,4), a = rng.int(0,2); state.resources.food += f; state.resources.ammo += a; logAdd(`æ‰¾åˆ° é£Ÿç‰© ${f}ã€å¼¹è¯ ${a}`, 'good'); }
      else logAdd('èƒŒåŒ…ç©ºæˆ–å·²è¢«æœè¿‡');
      popStoryNode(true);
    }},
    { text:'æ”¾è¿‡', handler: ()=> { logAdd('æ”¾è¿‡èƒŒåŒ…ä»¥å…é‡åˆ°é™·é˜±'); popStoryNode(true); } }
  ];
  pushStoryNode({ text, choices });
}

/* Raid */
function actionRaid(){
  const choices = [
    { text:'å‘èµ·åŠ«æ ï¼ˆé«˜é£é™©ï¼‰', handler: ()=> {
      logAdd('ç»„ç»‡åŠ«æ è¡ŒåŠ¨');
      const chance = 0.35 + (state.survivors.length*0.03);
      if (rng.chance(chance)) {
        const f = rng.int(12, 26); state.resources.food += f; state.morale = clamp(state.morale - rng.int(1,4),0,100);
        logAdd('åŠ«æ æˆåŠŸï¼è·å¾—é£Ÿç‰© '+f, 'good'); playTone(760,0.08,'triangle',0.06);
      } else {
        if (rng.chance(0.45) && state.survivors.length>0) {
          const lost = state.survivors.splice(rng.int(0, state.survivors.length-1),1)[0];
          logAdd(`${lost.name} åœ¨åŠ«æ ä¸­ç‰ºç‰²`, 'danger'); playTone(120,0.22,'sawtooth',0.09);
        }
        state.resources.food = Math.max(0, state.resources.food - rng.int(3,10));
        state.morale = clamp(state.morale - rng.int(6,14),0,100);
        logAdd('åŠ«æ å¤±è´¥ï¼Œä»˜å‡ºæƒ¨ç—›ä»£ä»·', 'danger');
      }
      popStoryNode(true);
    }},
    { text:'å–æ¶ˆ', handler: ()=> popStoryNode(false) }
  ];
  pushStoryNode({ text:'æ˜¯å¦ç»„ç»‡åŠ«æ ï¼Ÿï¼ˆé«˜é£é™©ï¼‰', choices });
}

/* --------- Advance Day & Endings --------- */
function advanceDay(){
  state.day += 1;
  // farm output
  if (state.base.farm > 0) {
    const gain = rng.int(1,2) * state.base.farm;
    state.resources.food += gain;
    logAdd(`å†œåœºäº§å‡º ${gain} é£Ÿç‰©`, 'good');
  }
  // consumption
  const eat = Math.max(1, state.survivors.length);
  state.resources.food = Math.max(0, state.resources.food - eat);
  if (state.resources.food === 0) {
    for (const s of state.survivors){
      if (rng.chance(0.22)) s.hp = Math.max(0, s.hp - 1);
    }
    state.morale = clamp(state.morale - rng.int(5,10),0,100);
    logAdd('é£Ÿç‰©è€—å°½ï¼Œå¤§å®¶é¥¥é¥¿ä¸”å£«æ°”ä¸‹é™', 'danger');
  } else {
    state.morale = clamp(state.morale + rng.int(-1,2),0,100);
  }

  // nightly attack chance
  const attackChance = clamp(0.12 + state.day*0.008 - state.base.wall*0.03 + (state.difficulty==='hard'?0.03:0), 0.05, 0.5);
  if (rng.chance(attackChance)){
    const severity = rng.int(1,8); const defense = state.base.wall;
    if (severity > 5 + defense) {
      state.resources.materials = Math.max(0, state.resources.materials - rng.int(3,8));
      if (state.survivors.length>0 && rng.chance(0.35)) {
        const lost = state.survivors.splice(rng.int(0,state.survivors.length-1),1)[0];
        logAdd(`å¤œé—´è¢­å‡»ï¼${lost.name} ç‰ºç‰²`, 'danger');
      } else logAdd('å¤œé—´è¢­å‡»é€ æˆç ´åï¼Œä½†å®ˆä½äº†é˜²çº¿', 'danger');
      state.morale = clamp(state.morale - rng.int(6,12),0,100);
      playTone(160,0.2,'sawtooth',0.12);
    } else {
      state.resources.materials = Math.max(0, state.resources.materials - rng.int(1,3));
      state.morale = clamp(state.morale - rng.int(1,4),0,100);
      logAdd('æœ‰è¢­å‡»è¢«æŠµæŒ¡ï¼ŒæŸå¤±è‹¥å¹²ææ–™', 'info');
      playTone(240,0.12,'square',0.06);
    }
  }

  // survivors small regen
  for (const s of state.survivors) s.hp = Math.min(s.maxHp, s.hp + rng.int(0,1));

  const end = checkEndings();
  if (end) { state.endings.reached = end.key; logAdd(`ç»“å±€è¾¾æˆï¼š${end.title}`, end.type === 'win' ? 'good' : 'danger'); presentEnding(end); saveAuto(); return; }

  saveAuto(); renderAll();
}

/* --------- Endings --------- */
function checkEndings(){
  if (state.survivors.length === 0) return { key:'all_dead', title:'å…¨å‘˜è¦†ç­', type:'lose' };
  if (state.eventsFlags['radio_fixed'] && state.eventsFlags['evac_hint'] && state.resources.materials >= 20 && state.day >= 5) {
    return { key:'evacuate_ready', title:'æ¥æ”¶åˆ°æ’¤ç¦»åæ ‡ï¼Œå¯ä»¥é€‰æ‹©æ’¤ç¦»', type:'win' };
  }
  if (state.day >= DEFAULT.dayLimitWin && state.base.wall >= 5) return { key:'fortress', title:'å»ºæˆè¦å¡ï¼Œåº¦è¿‡å±æœº', type:'win' };
  if (state.resources.food === 0 && state.morale < 8) return { key:'starvation', title:'é•¿æœŸé¥¥è’å¯¼è‡´å´©æºƒ', type:'lose' };
  return null;
}

function presentEnding(end){
  let text = '', choices = [];
  if (end.key === 'evacuate_ready') {
    text = `ä½ è·å¾—äº†æ’¤ç¦»åæ ‡ã€‚ç°åœ¨å¯ä»¥é€‰æ‹©ç«‹å³æ’¤ç¦»æˆ–ç»§ç»­ç•™å®ˆã€‚`;
    choices = [
      { text:'ç«‹å³æ’¤ç¦»ï¼ˆæœ‰æˆåŠŸç‡ï¼‰', handler: ()=> {
        const chance = clamp(0.5 + state.base.workshop*0.08 + (state.morale-50)/200, 0.15, 0.95);
        if (rng.chance(chance)) { presentFinalScreen('æ’¤ç¦»æˆåŠŸï¼šè¢«æ•‘æ´é˜Ÿæ¥èµ°ï¼Œå¹¸å­˜ï¼', true); }
        else { if (state.survivors.length>0) state.survivors.splice(0, Math.min(2, state.survivors.length)); presentFinalScreen('æ’¤ç¦»å¤±è´¥ï¼šæŸå¤±æƒ¨é‡', false); }
      }},
      { text:'æ‹’ç»æ’¤ç¦»ï¼Œç»§ç»­å·©å›ºåŸºåœ°', handler: ()=> { logAdd('é€‰æ‹©ç»§ç»­ç•™å®ˆ'); advanceDay(); } }
    ];
  } else if (end.key === 'fortress') {
    presentFinalScreen('ä½ ä»¬å»ºæˆäº†è¦å¡ï¼Œé•¿æœŸç”Ÿå­˜ä¸‹æ¥ã€‚', true); return;
  } else if (end.key === 'all_dead') {
    presentFinalScreen('æ²¡æœ‰å¹¸å­˜è€…ï¼Œæ•…äº‹ç»ˆç»“ã€‚', false); return;
  } else if (end.key === 'starvation') {
    presentFinalScreen('é¥¥é¥¿ä¸å£«æ°”å´©æºƒå¯¼è‡´å¤±è´¥ã€‚', false); return;
  } else {
    presentFinalScreen(end.title || 'ç»“å±€', end.type === 'win'); return;
  }
  pushStoryNode({ text, choices });
}

function presentFinalScreen(message, win){
  storyEl.textContent = message;
  choicesEl.innerHTML = '';
  const btn = document.createElement('button'); btn.className='choice'; btn.textContent='å¼€å§‹æ–°æ¸¸æˆ'; btn.onclick = ()=> { const seed = el('seed').value || Date.now().toString(); const diff = el('difficulty').value; newGame(seed, diff); };
  choicesEl.appendChild(btn);
  const note = document.createElement('div'); note.className='small'; note.style.marginTop='8px'; note.textContent = win ? 'ç»“å±€ï¼šç”Ÿå­˜' : 'ç»“å±€ï¼šå¤±è´¥';
  choicesEl.appendChild(note);
  if (win) playTone(880,0.24,'triangle',0.08); else playTone(140,0.5,'sawtooth',0.14);
  saveAuto();
}

/* --------- UI Bindings & Tutorial --------- */
document.getElementById('new').addEventListener('click', ()=>{
  if (!confirm('å¼€å§‹æ–°æ¸¸æˆä¼šè¦†ç›–å½“å‰è¿›åº¦ï¼Œç¡®å®šï¼Ÿ')) return;
  const seed = el('seed').value || Date.now().toString();
  const diff = el('difficulty').value;
  newGame(seed, diff);
});
el('save').addEventListener('click', manualSave);
el('load').addEventListener('click', manualLoad);
el('export').addEventListener('click', exportSave);
el('import').addEventListener('click', importSave);
el('sound-toggle').addEventListener('click', (e)=>{ audioEnabled = !audioEnabled; e.target.textContent = 'éŸ³æ•ˆ: ' + (audioEnabled ? 'å¼€' : 'å…³'); });
el('help').addEventListener('click', ()=> showTutorial());

window.addEventListener('keydown', (ev)=>{
  if (!choicesEl) return;
  const items = Array.from(choicesEl.querySelectorAll('.choice'));
  if (ev.key === 'Enter' && items[0]) { items[0].click(); }
  if (/^[1-9]$/.test(ev.key)) { const idx = parseInt(ev.key,10)-1; if (items[idx]) items[idx].click(); }
});

/* Tutorial overlay */
function showTutorial(){
  const ov = el('overlay'); ov.style.display='flex'; ov.setAttribute('aria-hidden','false');
}
function hideTutorial(){ const ov = el('overlay'); ov.style.display='none'; ov.setAttribute('aria-hidden','true'); }

el('close-tutorial').addEventListener('click', ()=> { hideTutorial(); state.eventsFlags.tutorialSeen = true; saveAuto(); });
el('start-tutorial').addEventListener('click', ()=> {
  hideTutorial();
  demoOneTurn();
  state.eventsFlags.tutorialSeen = true;
  saveAuto();
});

/* Demo a single guided turn to show flow */
function demoOneTurn(){
  logAdd('æ¼”ç¤ºï¼šæ´¾ä¸€äººæ‹¾è’ä½œä¸ºå¿«é€Ÿç¤ºä¾‹');
  // If someone healthy, automatically simulate scavenge result then render
  const s = state.survivors.find(x=>x.hp>1);
  if (!s) { logAdd('æ²¡æœ‰å¯ç¤ºèŒƒçš„å¥åº·å¹¸å­˜è€…'); renderAll(); return; }
  // Simulate a favorable scavenge with explanation
  pushStoryNode({
    text: `ç¤ºä¾‹ï¼šä½ æ´¾ ${s.name} å•ç‹¬å¤–å‡ºæ‹¾è’ã€‚æˆåŠŸæ—¶ä½ ä¼šè·å¾—é£Ÿç‰©/ææ–™ï¼Œå¤±è´¥å¯èƒ½å¯¼è‡´å—ä¼¤æˆ–å¤±å»é˜Ÿå‹ã€‚ç°åœ¨æ¼”ç¤ºä¸€æ¬¡å®‰å…¨è¿”å›çš„åœºæ™¯ï¼š`,
    choices: [
      { text:'æŸ¥çœ‹ç¤ºä¾‹ç»“æœ', handler: ()=> {
        const f = rng.int(3,6); const m = rng.int(1,3);
        state.resources.food += f; state.resources.materials += m;
        state.morale = clamp(state.morale + 2,0,100);
        logAdd(`${s.name} å®‰å…¨è¿”å›ï¼ˆç¤ºä¾‹ï¼‰ï¼šé£Ÿç‰© ${f}ã€ææ–™ ${m}`, 'good');
        popStoryNode(true);
      }}
    ]
  });
}

/* --------- Init & New Game --------- */
function newGame(seedText, difficulty='normal'){
  rng = createRNG(seedText || Date.now().toString());
  state = {
    id: uid(),
    seed: seedText || '',
    difficulty: difficulty || 'normal',
    day: 1,
    resources: JSON.parse(JSON.stringify(DEFAULT.resources)),
    base: JSON.parse(JSON.stringify(DEFAULT.baseModules)),
    survivors: JSON.parse(JSON.stringify(DEFAULT.survivors)),
    morale: 65,
    eventsFlags: { tutorialSeen:false },
    log: [],
    endings: { reached: null }
  };
  if (state.difficulty === 'hard') { state.resources.food = Math.max(8, Math.floor(state.resources.food*0.72)); state.resources.materials = Math.max(6, Math.floor(state.resources.materials*0.75)); state.morale = 52; }
  if (state.difficulty === 'easy') { state.resources.food = Math.floor(state.resources.food*1.25); state.resources.materials = Math.floor(state.resources.materials*1.2); state.morale = 75; }
  logAdd('æ¸¸æˆå¼€å§‹ï¼šä½ æ˜¯åŸºåœ°çš„æŒ‡æŒ¥ã€‚ä½¿ç”¨å³ä¾§é¢æ¿è§‚å¯ŸçŠ¶æ€å¹¶åœ¨å·¦ä¾§åšå‡ºæ¯æ—¥å†³ç­–ã€‚');
  saveAuto();
  renderAll();
  // show tutorial on first run
  if (!state.eventsFlags.tutorialSeen) setTimeout(()=> showTutorial(), 350);
}

/* Try load existing save or start new */
(function init(){
  try{
    const raw = localStorage.getItem(SAVE_KEY);
    if (raw) {
      if (confirm('æ£€æµ‹åˆ°å­˜æ¡£ï¼Œæ˜¯å¦åŠ è½½ï¼Ÿ(å–æ¶ˆå°†å¼€å§‹æ–°æ¸¸æˆ)')) { manualLoad(); return; }
    }
  }catch(e){}
  newGame(Date.now().toString(), el('difficulty').value);
})();
</script>
</body>
</html>
