<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>末日文字Roguelike：避难所日志</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#111a24;
      --panel2:#0f1720;
      --text:#d7e2ee;
      --muted:#8fa3b8;
      --good:#5ee28b;
      --bad:#ff5f6d;
      --warn:#ffd166;
      --accent:#62a7ff;
      --border: rgba(255,255,255,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 30% 10%, rgba(98,167,255,.12), transparent 60%),
                  radial-gradient(900px 600px at 70% 0%, rgba(94,226,139,.10), transparent 55%),
                  var(--bg);
      color: var(--text);
      font-family: var(--sans);
      line-height:1.25;
    }
    header{
      padding:18px 16px 10px;
      max-width: 1100px;
      margin: 0 auto;
    }
    h1{
      margin:0;
      font-size: 18px;
      letter-spacing:.4px;
      color:#e9f2ff;
    }
    .sub{
      margin-top:6px;
      color: var(--muted);
      font-size: 12px;
    }
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding: 12px 16px 26px;
      display:grid;
      grid-template-columns: 340px 1fr;
      gap: 14px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 14px;
      background: rgba(255,255,255,.03);
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .card .hd .t{
      font-weight:650;
      font-size: 13px;
      color:#e9f2ff;
    }
    .badge{
      font-family: var(--mono);
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid var(--border);
      color: var(--muted);
      background: rgba(255,255,255,.02);
      white-space:nowrap;
    }
    .content{ padding: 12px 14px 14px; }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .stat{
      padding: 10px 10px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.15);
    }
    .stat.low .v span{ color: var(--warn); }
    .stat.zero .v span{ color: var(--bad); }
    .stat .k{ color: var(--muted); font-size: 11px; }
    .stat .v{
      margin-top:6px;
      font-family: var(--mono);
      font-size: 16px;
      display:flex;
      align-items:baseline;
      gap:8px;
    }
    .delta{
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border:1px solid var(--border);
      color: var(--muted);
    }
    .delta.good{ color: var(--good); border-color: rgba(94,226,139,.25); background: rgba(94,226,139,.08);}
    .delta.bad{ color: var(--bad); border-color: rgba(255,95,109,.25); background: rgba(255,95,109,.08);}
    .delta.warn{ color: var(--warn); border-color: rgba(255,209,102,.25); background: rgba(255,209,102,.08);}

    .list{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .pill{
      font-size: 11px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
      color: var(--text);
      padding: 6px 8px;
      border-radius: 999px;
      max-width: 100%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pill.muted{ color: var(--muted); }
    .pill.accent{ border-color: rgba(98,167,255,.35); background: rgba(98,167,255,.08); }
    .pill.good{ border-color: rgba(94,226,139,.35); background: rgba(94,226,139,.08); }
    .pill.warn{ border-color: rgba(255,209,102,.35); background: rgba(255,209,102,.08); }
    .pill.bad{ border-color: rgba(255,95,109,.35); background: rgba(255,95,109,.08); }

    .log{
      height: 430px;
      overflow:auto;
      padding: 10px 14px 14px;
      background: rgba(0,0,0,.16);
    }
    .entry{
      padding: 10px 10px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.02);
      margin: 10px 0;
    }
    .entry .meta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color: var(--muted);
      font-size: 11px;
      font-family: var(--mono);
    }
    .entry .text{ margin-top: 8px; font-size: 13px; color: var(--text); }
    .entry .opts{
      margin-top: 10px;
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
    }
    button{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 9px 10px;
      border-radius: 12px;
      font-size: 12px;
      cursor:pointer;
      transition: transform .06s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    button:hover{
      background: rgba(255,255,255,.07);
      border-color: rgba(255,255,255,.14);
    }
    button:active{ transform: translateY(1px); }
    button.primary{
      border-color: rgba(98,167,255,.35);
      background: rgba(98,167,255,.10);
    }
    button.danger{
      border-color: rgba(255,95,109,.35);
      background: rgba(255,95,109,.09);
    }
    button.good{
      border-color: rgba(94,226,139,.35);
      background: rgba(94,226,139,.09);
    }
    button:disabled{
      cursor:not-allowed;
      opacity:.55;
      transform:none;
    }

    .row{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      align-items:center;
    }
    .small{
      font-size: 11px;
      color: var(--muted);
    }
    .divider{
      height:1px;
      background: var(--border);
      margin: 12px 0;
    }

    .footerbar{
      padding: 10px 14px;
      border-top:1px solid var(--border);
      background: rgba(255,255,255,.02);
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      justify-content:space-between;
      align-items:center;
    }
    .kbd{
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted);
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      padding: 3px 7px;
      border-radius: 8px;
    }
    @media (max-width: 920px){
      .wrap{ grid-template-columns: 1fr; }
      .log{ height: 420px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>避难所日志（文字Roguelike）</h1>
    <div class="sub">随机事件 + 随机奖励 + 资源管理。每回合做关键选择，活下去。</div>
  </header>

  <div class="wrap">
    <!-- LEFT: STATS -->
    <div class="card">
      <div class="hd">
        <div class="t">状态面板</div>
        <div class="badge" id="seedBadge">seed: -</div>
      </div>
      <div class="content">
        <div class="grid2" id="statsGrid"></div>

        <div class="small" id="consumeLine" style="margin-top:10px;"></div>

        <div class="divider"></div>

        <div class="row">
          <span class="pill muted">特性</span>
          <span class="small">（每局不同，影响事件与收益）</span>
        </div>
        <div class="list" id="traitsList"></div>

        <div class="divider"></div>

        <div class="row">
          <button class="primary" id="btnNext">下一天：触发随机事件</button>
          <button id="btnRest">休整</button>
          <button id="btnCraft">制造</button>
          <button id="btnUpgrade">升级</button>
        </div>

        <div class="divider"></div>

        <div class="row">
          <button class="danger" id="btnNewRun">新开一局</button>
          <button id="btnSave">导出存档</button>
          <button id="btnLoad">导入存档</button>
        </div>
        <div class="small" style="margin-top:8px;">
          小提示：<span class="kbd">N</span> 下一天，<span class="kbd">R</span> 休整，<span class="kbd">C</span> 制造，<span class="kbd">U</span> 升级
        </div>
      </div>
    </div>

    <!-- RIGHT: LOG -->
    <div class="card">
      <div class="hd">
        <div class="t">事件日志</div>
        <div class="badge" id="runBadge">Day 1</div>
      </div>
      <div class="log" id="log"></div>
      <div class="footerbar">
        <div class="row">
          <span class="pill accent" id="threatPill">威胁：0</span>
          <span class="pill" id="zombiePill">僵尸进度：-</span>
        </div>
        <div class="row small" id="hintLine">做选择会改变资源与威胁，威胁越高，事件越凶。</div>
      </div>
    </div>
  </div>

<script>
(() => {
  // -----------------------------
  // RNG (seeded)
  // -----------------------------
  function mulberry32(a){
    return function(){
      let t = a += 0x6D2B79F5;
      t = Math.imul(t ^ (t >>> 15), t | 1);
      t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    };
  }
  function hashSeed(str){
    // simple string hash -> uint32
    let h = 2166136261 >>> 0;
    for (let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }

  // -----------------------------
  // Game State
  // -----------------------------
  const DEFAULTS = () => ({
    seedText: randomSeedText(),
    day: 1,
    hp: 20,
    maxHp: 20,
    morale: 10,
    maxMorale: 20,

    food: 10,
    water: 12,
    ammo: 6,
    med: 2,
    scrap: 4,

    threat: 0,      // increases difficulty
    zone: 1,        // "distance" / stage
    traits: [],
    inventory: [],  // future extension
    flags: {},

    story: storyDefaults(),

    pendingChoice: null, // if an event is waiting for player choice
    lastDelta: {},

    settings: { difficulty: 'normal' }
  });

  let state = DEFAULTS();
  let rng = mulberry32(hashSeed(state.seedText));
  const $ = (id) => document.getElementById(id);


  // -----------------------------
  // Story System (stateful, linked narrative)
  // -----------------------------
  function storyDefaults(){
    return {
      queue: ["st_intro"],      // upcoming story nodes influenced by choices
      seen: {},                  // nodeId -> true
      vars: { chapter: 1, trust: 0, faction: null, clueTrail: 0 }, // story variables
      last: null                 // last node id
    };
  }

  function storyHas(id){
    return !!state.story.seen[id];
  }

  function storyEnqueue(id){
    if (!id) return;
    if (storyHas(id)) return;
    if (state.story.queue.includes(id)) return;
    state.story.queue.push(id);
  }

  function storyEnqueueMany(ids){
    if (!ids) return;
    for (const id of ids) storyEnqueue(id);
  }

  function setFlag(k, v=true){
    state.flags[k] = v;
  }

  // Convert a story node to logEventCard options with automatic state linkage.
  function storyOptions(node, ctx){
    return node.options(ctx).map(opt => ({
      text: opt.text,
      kind: opt.kind || "primary",
      req: opt.req || (()=>true),
      resolve: ()=>{
        // apply flag/var effects
        if (opt.setFlags){
          for (const [k,v] of Object.entries(opt.setFlags)) setFlag(k, v);
        }
        if (opt.setVars){
          for (const [k,v] of Object.entries(opt.setVars)) state.story.vars[k]=v;
        }
        // mark and link
        state.story.seen[node.id] = true;
        state.story.last = node.id;

        // allow custom resolve (can call endTurn internally)
        if (typeof opt.resolve === 'function'){
          opt.resolve(ctx);
          return;
        }

        // otherwise do default endTurn with delta and enqueue next
        storyEnqueueMany(opt.next);
        endTurn({
          log: opt.log || `你的选择让事情向前推进。`,
          delta: opt.delta || { morale:+0, threat:+0 }
        });
      }
    }));
  }

  // Story nodes: random *within* a continuous, choice-driven graph.
  // Rules:
  // - Nodes become eligible if their requirements are met.
  // - Player choices enqueue follow-ups, so the next days reflect what you did.
  const STORY_NODES = [
    {
      id:"st_intro",
      dayMin: 1,
      title:"一张被雨淋湿的地图",
      intro:"你在避难所门口的垃圾堆里翻到一张被雨水泡皱的城市地图，角落写着：‘不要相信晚上会亮灯的楼。’",
      requires:()=> true,
      options:(ctx)=>[
        {
          text:"把地图收好（+士气，解锁线索）",
          kind:"good",
          log:"你把地图折好塞进内袋。也许它能救你一命。",
          delta:{ morale:+1, threat:+0 },
          setVars:{ clue:"map" },
          next:["radio_1","diary_1"]
        },
        {
          text:"用来加固窗缝（+防御感，解锁‘稳健’路线）",
          kind:"primary",
          log:"你用地图把窗缝堵了堵，至少今晚风不会那么冷。",
          delta:{ morale:+1, threat:+0 },
          setVars:{ clue:"fortify" },
          next:["diary_1","water_line_1"]
        },
        {
          text:"丢掉它（更快行动）",
          kind:"bad",
          log:"你不想被旧纸牵着走，直接把它丢进积水里。",
          delta:{ morale:+0, threat:+0 },
          next:["radio_1"]
        }
      ]
    },

    {
      id:"radio_1",
      dayMin: 2,
      title:"广播电台残响",
      intro:"你在一间办公室里发现一台半坏的短波电台，喇叭里断断续续传来有人在喊坐标。",
      requires:()=> !storyHas("radio_1"),
      options:(ctx)=>[
        {
          text:"调频收听（+士气，写下坐标）",
          kind:"good",
          log:"你记下了断续的坐标与一句暗号：‘海鸥不在夜里飞。’",
          delta:{ morale:+2, threat:+0 },
          setFlags:{ radioClue:true },
          next:["radio_2","blackflag_1"]
        },
        {
          text:"拆下零件（+废料，动静更大）",
          kind:"primary",
          log:"你把电台拆成可用的零件。金属撞击声在楼道里回荡。",
          delta:{ scrap:+3, morale:+0, threat:+1 },
          next:["blackflag_1"]
        },
        {
          text:"离开（不暴露位置）",
          kind:"muted",
          log:"你决定不浪费时间，先活过今天再说。",
          delta:{ morale:+0, threat:+0 },
          next:["diary_1"]
        }
      ]
    },

    {
      id:"radio_2",
      dayMin: 3,
      title:"坐标的第二半句",
      intro:"你反复回想那串坐标，突然意识到少了一段。也许有人知道补全方法。",
      requires:()=> state.flags.radioClue && !storyHas("radio_2"),
      options:(ctx)=>[
        {
          text:"去找‘懂无线电的人’（更冒险，但推进剧情）",
          kind:"primary",
          log:"你决定去碰一碰运气：找到懂行的人，补全坐标。",
          delta:{ morale:+0, threat:+1 },
          setVars:{ pursuit:"radio" },
          next:["survivor_signal_1","subway_1"]
        },
        {
          text:"先把坐标刻在墙上（留后路）",
          kind:"good",
          log:"你把坐标刻在避难所内墙上。就算丢了纸，也不会丢了路。",
          delta:{ morale:+1, threat:+0 },
          setVars:{ pursuit:"stay" },
          next:["water_line_1","kid_arrow_1"]
        }
      ]
    },

    {
      id:"diary_1",
      dayMin: 2,
      title:"日记残页",
      intro:"一沓发黄的纸夹在抽屉里，像是某人的日记。字迹潦草，但能读出恐惧与坚持。",
      requires:()=> !storyHas("diary_1"),
      options:(ctx)=>[
        {
          text:"认真读完（+士气，得到警告）",
          kind:"good",
          log:"你记下最重要的一句：‘不要在夜里走那条桥。’",
          delta:{ morale:+2, threat:+0 },
          setFlags:{ diaryClue:true },
          next:["bridge_1","kid_arrow_1"]
        },
        {
          text:"收好带走（以后或许能换信任）",
          kind:"primary",
          log:"你把日记塞进包里。也许它能证明你不是骗子。",
          delta:{ morale:+1, threat:+0 },
          setFlags:{ diaryKept:true },
          next:["survivor_signal_1","blackflag_1"]
        },
        {
          text:"当引火物（立刻收益）",
          kind:"muted",
          log:"你撕了几张纸当引火物，至少能热一顿。",
          delta:{ food:+1, morale:+0, threat:+0 },
          next:["water_line_1"]
        }
      ]
    },

    {
      id:"bridge_1",
      dayMin: 4,
      title:"那座桥",
      intro:"你绕到地图上提到的那座桥。白天看起来很普通，但桥下的回声让你不舒服。",
      requires:()=> state.flags.diaryClue && !storyHas("bridge_1"),
      options:(ctx)=>[
        {
          text:"白天快速通过（稳）",
          kind:"good",
          log:"你压低脚步快速通过。桥下的影子没追上来。",
          delta:{ morale:+1, threat:+0 },
          next:["survivor_signal_1","safehouse_1"]
        },
        {
          text:"下桥查看（可能高收益也可能出事）",
          kind:"primary",
          resolve:(ctx)=>{
            const bad = r() < (0.22 + state.threat*0.02 - (state.flags.lucky?0.06:0));
            if (!bad){
              storyEnqueueMany(["safehouse_1"]);
              endTurn({log:"桥下藏着一个旧背包。你拿走了补给。", delta:{food:+3, water:+2, ammo:+2, morale:+1, threat:+0}});
            } else {
              storyEnqueueMany(["blackflag_1"]);
              const dmg = Math.ceil((3+state.zone)*(0.7+r()*0.8)*ctx.ambushDmgMult);
              endTurn({log:`桥下的声响引来游荡者，你狼狈逃离（-${dmg} 生命）。`, delta:{hp:-dmg, morale:-1, threat:+2}});
            }
          }
        }
      ]
    },

    {
      id:"water_line_1",
      dayMin: 3,
      title:"临时净水点",
      intro:"你看到一处被塑料布遮住的水桶，旁边有粗糙的过滤装置。看起来有人在这里取水。",
      requires:()=> !storyHas("water_line_1"),
      options:(ctx)=>[
        {
          text:"补满水袋（+水，但可能引人注意）",
          kind:"primary",
          log:"你装了些水离开。",
          delta:{ water:+diff().waterEvent.fill, morale:+0, threat:+1 },
          next:["blackflag_1"]
        },
        {
          text:"先过滤再装（耗废料，降低风险）",
          kind:"good",
          req:()=> state.scrap>=1,
          log:"你用一点零件加固过滤装置，取水更安心。",
          delta:{ scrap:-1, water:+diff().waterEvent.fortify, morale:+1, threat:+0 },
          next:["safehouse_1"]
        },
        {
          text:"不碰它",
          kind:"muted",
          log:"你不确定这里是否安全，选择离开。",
          delta:{ morale:+0, threat:+0 },
          next:["kid_arrow_1"]
        }
      ]
    },

    {
      id:"survivor_signal_1",
      dayMin: 4,
      title:"求救信号",
      intro:"远处楼里闪了两下灯。有人用镜面反光引你注意。",
      requires:()=> !storyHas("survivor_signal_1"),
      options:(ctx)=>[
        {
          text:"回应并靠近（可能结识同伴）",
          kind:"good",
          resolve:(ctx)=>{
            const bad = r() < (0.25 + state.threat*0.02 - (state.flags.lucky?0.06:0));
            if (!bad){
              setFlag('survivorMet', true);
              storyEnqueueMany(["safehouse_1","radio_helper_1"]);
              endTurn({log:"你遇到一位幸存者，对方给了你一点物资作为谢意，并说‘北边有个安全点’。", delta:{food:+2, water:+1, morale:+2, threat:+0}});
            }else{
              storyEnqueueMany(["blackflag_1"]);
              endTurn({log:"你靠近后发现是诱饵。你仓促撤离，心情糟透了。", delta:{morale:-2, threat:+2}});
            }
          }
        },
        {
          text:"保持距离观察（小收益）",
          kind:"primary",
          log:"你确认附近没人跟踪，顺手搜到点零件。",
          delta:{ scrap:+1, morale:+1, threat:+0 },
          next:["kid_arrow_1"]
        },
        {
          text:"无视",
          kind:"muted",
          log:"你不想冒险。",
          delta:{ morale:+0, threat:+0 },
          next:["blackflag_1"]
        }
      ]
    },

    {
      id:"radio_helper_1",
      dayMin: 5,
      title:"懂无线电的人",
      intro:"那位幸存者说，他认识一个会修无线电的人，但那人躲在地铁附近。",
      requires:()=> state.flags.survivorMet && state.flags.radioClue && !storyHas("radio_helper_1"),
      options:(ctx)=>[
        {
          text:"去地铁找他（推进坐标线）",
          kind:"primary",
          log:"你决定赌一把：坐标可能意味着真正的出路。",
          delta:{ morale:+0, threat:+1 },
          next:["subway_1"]
        },
        {
          text:"暂缓（先稳住补给）",
          kind:"good",
          log:"你决定先把状态拉稳，再去碰那条线。",
          delta:{ morale:+1, threat:+0 },
          next:["kid_arrow_1","blackflag_1"]
        }
      ]
    },

    {
      id:"subway_1",
      dayMin: 5,
      title:"封闭的地铁闸门",
      intro:"地铁口被铁闸封死，里面黑得像墨。你听见里面有水滴声，也许有物资，也许有麻烦。",
      requires:()=> !storyHas("subway_1"),
      options:(ctx)=>[
        {
          text:"用工具撬开（耗废料，收益更高）",
          kind:"primary",
          req:()=> state.scrap>=2,
          resolve:(ctx)=>{
            const bad = r() < (0.18 + state.threat*0.02 - (state.flags.lucky?0.05:0));
            if(!bad){
              setFlag('subwayOpened', true);
              storyEnqueueMany(["safehouse_1","blackflag_1"]);
              endTurn({log:"你撬开闸门，从站台角落带走了补给。", delta:{scrap:-2, food:+3, water:+3, ammo:+2, morale:+1, threat:+1}});
            }else{
              storyEnqueueMany(["blackflag_1"]);
              endTurn({log:"闸门一响就惊动了东西，你只能撤退。", delta:{scrap:-2, morale:-1, threat:+2}});
            }
          }
        },
        {
          text:"丢石子探路（低成本）",
          kind:"good",
          log:"回声很空。你捡了点散落的零件就走。",
          delta:{ scrap:+1, morale:+0, threat:+0 },
          next:["kid_arrow_1"]
        },
        {
          text:"离开",
          kind:"muted",
          log:"你不想进这种地方。",
          delta:{ morale:+0, threat:+0 },
          next:["blackflag_1"]
        }
      ]
    },

    {
      id:"kid_arrow_1",
      dayMin: 4,
      title:"小孩的涂鸦箭头",
      intro:"墙上有新鲜的涂鸦箭头，像是在指向某处：‘这里有吃的’。",
      requires:()=> !storyHas("kid_arrow_1"),
      options:(ctx)=>[
        {
          text:"跟着箭头走（可能有补给，也可能是陷阱）",
          kind:"primary",
          resolve:(ctx)=>{
            const bad = r() < (0.22 + state.threat*0.02 - (state.flags.lucky?0.06:0));
            if(!bad){
              setFlag('trustedSigns', true);
              storyEnqueueMany(["safehouse_1"]);
              endTurn({log:"你找到一处隐藏的储物箱。", delta:{food:+4, water:+2, morale:+2, threat:+0}});
            }else{
              storyEnqueueMany(["blackflag_1"]);
              const dmg = Math.ceil((3+state.zone)*(0.7+r()*0.8)*ctx.ambushDmgMult);
              endTurn({log:`你踩到碎玻璃引来动静，被迫冲出去（-${dmg} 生命）。`, delta:{hp:-dmg, morale:-1, threat:+2}});
            }
          }
        },
        {
          text:"只在附近搜一下（稳）",
          kind:"good",
          log:"你在附近捡到些可用的小东西。",
          delta:{ scrap:+2, morale:+1, threat:+0 },
          next:["safehouse_1"]
        },
        {
          text:"不信这种话",
          kind:"muted",
          log:"你不想被牵着鼻子走。",
          delta:{ morale:+0, threat:+0 },
          next:["blackflag_1"]
        }
      ]
    },

    {
      id:"blackflag_1",
      dayMin: 5,
      title:"黑旗帮哨",
      intro:"一名持械的哨兵挡住去路，臂章上画着黑色旗帜。‘过路费。’",
      requires:()=> !storyHas("blackflag_1"),
      options:(ctx)=>[
        {
          text:"交废料（2废料换平安）",
          kind:"primary",
          req:()=> state.scrap>=2,
          log:"你把废料递过去，对方放你离开。",
          delta:{ scrap:-2, morale:+0, threat:+0 },
          setFlags:{ blackflagPaid:true },
          next:["safehouse_1"]
        },
        {
          text:"尝试谈判（需要士气）",
          kind:"good",
          req:()=> state.morale>=8,
          log:"你稳住语气讲明处境，对方嘟囔两句，还是放你过去。",
          delta:{ morale:+1, threat:+0 },
          setFlags:{ blackflagTalked:true },
          next:["safehouse_1"]
        },
        {
          text:"鸣枪逼退（消耗弹药，惹麻烦）",
          kind:"bad",
          req:()=> state.ammo>=2,
          log:"你朝天鸣枪，对方退后让路，但动静引来关注。",
          delta:{ ammo:-2, morale:+0, threat:+2 },
          setFlags:{ blackflagHostile:true },
          next:["finale_1"]
        },
        {
          text:"撤退绕路（耗神）",
          kind:"muted",
          log:"你绕了一大圈，安全但很累。",
          delta:{ morale:-1, threat:+0 },
          next:["safehouse_1"]
        }
      ]
    },

    {
      id:"safehouse_1",
      dayMin: 7,
      title:"北边的安全点",
      intro:"你再次想起那句‘北边有个安全点’。如果它是真的，也许你能换到长期生存的机会。",
      requires:()=> !storyHas("safehouse_1") && (state.flags.survivorMet || state.flags.radioClue || state.flags.trustedSigns),
      options:(ctx)=>[
        {
          text:"动身去找（推进主线）",
          kind:"primary",
          log:"你决定把命押在‘安全点’上。",
          delta:{ morale:+1, threat:+1 },
          setFlags:{ seekingSafehouse:true },
          next:["safehouse_2","finale_1"]
        },
        {
          text:"先观察周边（更稳）",
          kind:"good",
          log:"你决定先摸清周边，再做决定。",
          delta:{ morale:+1, threat:+0 },
          next:["safehouse_2"]
        },
        {
          text:"不去（坚守自己的避难所）",
          kind:"muted",
          log:"你不相信任何‘安全点’，决定把命押在自己的屋檐下。",
          delta:{ morale:+0, threat:+0 },
          setFlags:{ stayShelter:true },
          next:["finale_1"]
        }
      ]
    },

    {
      id:"safehouse_2",
      dayMin: 9,
      title:"铁门后的声音",
      intro:"夜里，你在北边一处铁门前听见低声交谈。有人真的在这里活着。门后的人问：‘暗号？’",
      requires:()=> (!!state.flags.seekingSafehouse) && !storyHas("safehouse_2"),
      options:(ctx)=>[
        {
          text:"说出暗号（需要你听过广播）",
          kind:"good",
          req:()=> state.flags.radioClue,
          log:"门后的沉默持续了几秒，然后铁门缓缓打开了一条缝。",
          delta:{ morale:+2, threat:+0 },
          setFlags:{ safehouseEntered:true },
          next:["finale_1"]
        },
        {
          text:"递上日记残页（证明你不是随便的人）",
          kind:"primary",
          req:()=> !!state.flags.diaryKept,
          log:"门后的人翻了翻纸页，语气软了些：‘进来。’",
          delta:{ morale:+2, threat:+0 },
          setFlags:{ safehouseEntered:true },
          next:["finale_1"]
        },
        {
          text:"强行闯入（高风险）",
          kind:"bad",
          resolve:(ctx)=>{
            const bad = r() < (0.35 + state.threat*0.02 - (state.flags.lucky?0.06:0));
            if (!bad){
              setFlag('safehouseEntered', true);
              endTurn({log:"你趁门缝打开的瞬间挤了进去，里面的人被迫让你留下。", delta:{morale:-1, threat:+2}});
              storyEnqueueMany(["finale_1"]);
            } else {
              const dmg = Math.ceil((4+state.zone)*(0.9+r()*0.9)*ctx.ambushDmgMult);
              endTurn({log:`你被推倒在门外，混乱中挨了一下（-${dmg} 生命）。`, delta:{hp:-dmg, morale:-2, threat:+2}});
              storyEnqueueMany(["finale_1"]);
            }
          }
        }
      ]
    },

    {
      id:"finale_1",
      dayMin: 12,
      title:"你要活成什么样",
      intro:"你突然意识到：你不是在‘等灾难结束’，你是在选择自己未来的形状。",
      requires:()=> !storyHas("finale_1") && state.day >= 12,
      options:(ctx)=>[
        {
          text:"迁移：追随线索去更远的地方（结局分支：远行）",
          kind:"primary",
          log:"你决定不再只守着这间屋子。你把必需品打包，准备离开。",
          delta:{ morale:+2, threat:+1 },
          setFlags:{ ending:"wander" },
          next:[]
        },
        {
          text:"结盟：加入铁门后的群体（结局分支：据点）",
          kind:"good",
          req:()=> !!state.flags.safehouseEntered,
          log:"你选择相信‘人群’，也许这就是文明剩下的部分。",
          delta:{ morale:+3, threat:+0 },
          setFlags:{ ending:"settle" },
          next:[]
        },
        {
          text:"坚守：加固避难所，做自己的城（结局分支：坚守）",
          kind:"muted",
          log:"你决定继续守住这里，把它变成真正的堡垒。",
          delta:{ morale:+1, threat:+0 },
          setFlags:{ ending:"hold" },
          next:[]
        }
      ]
    }
  ];

  function storyPickNode(){
    // Chance to serve a story node today.
    // Make it frequent early, and still common later.
    const baseChance = 0.55;
    const bump = state.story.queue.length ? 0.20 : 0;
    const chance = clamp(baseChance + bump - Math.max(0, (state.threat-6))*0.02, 0.25, 0.85);
    if (r() > chance) return null;

    const ctx = ctxBase();

    // Candidate set: queued nodes first, otherwise any eligible unseen nodes.
    const queued = state.story.queue
      .map(id => STORY_NODES.find(n=>n.id===id))
      .filter(n=>n && !storyHas(n.id) && (n.dayMin||1) <= state.day && (!n.requires || n.requires(ctx)));

    let candidates = queued;
    if (!candidates.length){
      candidates = STORY_NODES.filter(n=>!storyHas(n.id) && (n.dayMin||1) <= state.day && (!n.requires || n.requires(ctx)));
    }
    if (!candidates.length) return null;

    // Weight: prefer queued nodes, and prefer nodes that reference recent flags
    const weights = candidates.map(n=>{
      let w = 1;
      if (state.story.queue.includes(n.id)) w += 2.2;
      if (n.id.startsWith('finale')) w += 0.8;
      if (n.id.includes('safehouse') && state.flags.seekingSafehouse) w += 1.2;
      if (n.id.includes('radio') && state.flags.radioClue) w += 0.8;
      return w;
    });

    const node = weightedPick(candidates, weights);

    // If it came from queue, remove it from queue now (so it doesn't repeat)
    state.story.queue = state.story.queue.filter(id=>id!==node.id);

    return node;
  }

  // -----------------------------
  // Content Pools
  // -----------------------------
  const TRAITS = [
    {
      id:"scavenger",
      name:"拾荒者",
      desc:"搜刮更容易出货（+10% 资源收益）",
      mod:(ctx)=>{ ctx.lootMult *= 1.10; }
    },
    {
      id:"medic",
      name:"急救员",
      desc:"医疗效率更高（医疗/休整回血 +1）",
      mod:(ctx)=>{ ctx.restHeal += 1; ctx.medHeal += 1; }
    },
    {
      id:"sharpshooter",
      name:"神枪手",
      desc:"战斗更省弹（战斗弹药消耗 -1 最低0）",
      mod:(ctx)=>{ ctx.combatAmmoDiscount += 1; }
    },
    {
      id:"paranoid",
      name:"多疑",
      desc:"更难被偷袭（陷阱/伏击伤害 -20%）",
      mod:(ctx)=>{ ctx.ambushDmgMult *= 0.8; }
    },
    {
      id:"tinkerer",
      name:"修理匠",
      desc:"制造更划算（制造消耗废料 -1 最低0）",
      mod:(ctx)=>{ ctx.craftScrapDiscount += 1; }
    },
    {
      id:"runner",
      name:"跑得快",
      desc:"逃跑更容易（逃跑成功率 +20%）",
      mod:(ctx)=>{ ctx.escapeBonus += 0.20; }
    },
  ];

  function randomSeedText(){
    const a = ["WASTELAND","SHELTER","DUST","NIGHT","HUNGER","STATIC","ECHO","RUST"];
    const b = Math.floor(Math.random()*9999).toString().padStart(4,"0");
    return a[Math.floor(Math.random()*a.length)] + "-" + b;
  }



  // -----------------------------
  // Extra story content (chaptered, choice-linked)
  // -----------------------------
  // Design notes:
  // - Still random day-to-day, but constrained by your past choices.
  // - Uses story.vars.chapter to gently structure a full arc.
  STORY_NODES.push(
    {
      id:"chapter_1_hook",
      dayMin: 4,
      title:"墙上的涂鸦",
      intro:"你在一处楼梯间看到新鲜的涂鸦：‘安全点不免费。’ 旁边画着一只像海鸥的符号。",
      requires:()=> (state.story.vars.chapter||1)===1 && !storyHas("chapter_1_hook"),
      options:()=>[
        {
          text:"记下符号（推进线索）",
          kind:"good",
          log:"你把符号记在本子上。‘海鸥’这个词又出现了。",
          delta:{morale:+1, threat:+0},
          setVars:{ clueTrail: (state.story.vars.clueTrail||0)+1 },
          next:["safehouse_1","radio_2","chapter_1_end"]
        },
        {
          text:"擦掉涂鸦（不留痕迹）",
          kind:"primary",
          log:"你用灰尘和水把涂鸦抹平。你不想让任何人知道你来过。",
          delta:{morale:+0, threat:+0},
          next:["chapter_1_end"]
        }
      ]
    },

    {
      id:"chapter_1_end",
      dayMin: 6,
      title:"门缝里的纸条",
      intro:"你回到避难所时，门缝里多了一张纸条：‘如果你听到了坐标，别一个人去。’",
      requires:()=> (state.story.vars.chapter||1)===1 && !storyHas("chapter_1_end"),
      options:()=>[
        {
          text:"把纸条收好（进入第二章）",
          kind:"good",
          log:"你把纸条折成很小的一块。你意识到：有人在观察你。",
          delta:{morale:+1, threat:+0},
          setVars:{ chapter: 2 },
          next:["ally_offer_1","blackflag_1","safehouse_1"]
        },
        {
          text:"设个小陷阱验证是否有人来过（+威胁）",
          kind:"primary",
          log:"你在门口摆了易碎物。只要有人再来，你会知道。",
          delta:{morale:+0, threat:+1},
          setVars:{ chapter: 2 },
          next:["ally_offer_1","redknives_hint_1"]
        }
      ]
    },

    {
      id:"ally_offer_1",
      dayMin: 7,
      title:"自称‘洛’的幸存者",
      intro:"一个瘦高的人在街角等你，低声说他叫‘洛’：‘我知道你在找什么。’",
      requires:()=> (state.story.vars.chapter||1)===2 && !storyHas("ally_offer_1"),
      options:()=>[
        {
          text:"相信他（+信任，可能获得帮助）",
          kind:"good",
          log:"洛递来半瓶水与一段路线：‘别走桥，走地下。’",
          delta:{water:+1, morale:+2, threat:+0},
          setVars:{ trust: (state.story.vars.trust||0)+1 },
          setFlags:{ metLuo:true },
          next:["luo_follow_1","subway_1"]
        },
        {
          text:"保持距离（稳健，但推进变慢）",
          kind:"primary",
          log:"你没接他的东西，只记下了那句‘走地下’。",
          delta:{morale:+1, threat:+0},
          setFlags:{ metLuo:true },
          next:["subway_1","safehouse_2"]
        },
        {
          text:"赶走他（降低风险，但失去线索）",
          kind:"bad",
          log:"你拒绝交流。洛看了你一眼，像是失望，也像是松了口气。",
          delta:{morale:+0, threat:+0},
          setVars:{ trust: Math.max(0, (state.story.vars.trust||0)-1) },
          next:["safehouse_2"]
        }
      ]
    },

    {
      id:"luo_follow_1",
      dayMin: 8,
      title:"洛的条件",
      intro:"洛说：‘我可以带你去安全点，但你得先帮我拿回一样东西。’ 他指向一栋被封的药店。",
      requires:()=> (state.story.vars.chapter||1)===2 && state.flags.metLuo && !storyHas("luo_follow_1"),
      options:(ctx)=>[
        {
          text:"答应（去药店，获得剧情推进）",
          kind:"primary",
          log:"你决定赌一次。",
          delta:{morale:+0, threat:+1},
          next:["pharmacy_1"]
        },
        {
          text:"拒绝（但记录位置）",
          kind:"muted",
          log:"你没有答应，但你把药店位置记在地图上。",
          delta:{morale:+0, threat:+0},
          next:["safehouse_2","blackflag_2"]
        }
      ]
    },

    {
      id:"pharmacy_1",
      dayMin: 9,
      title:"封门药店",
      intro:"药店门上钉着木板。里面有药味，也有……腐败的甜味。你能听见里面有东西在挠。",
      requires:()=> (state.story.vars.chapter||1)===2 && !storyHas("pharmacy_1"),
      options:(ctx)=>[
        {
          text:"撬开进去（高风险高回报）",
          kind:"primary",
          req:()=> state.scrap>=1,
          resolve:()=>{
            // a controlled risk: if unlucky, take damage; otherwise gain med & clue
            const unlucky = r() < (0.35 + state.threat*0.02);
            if (unlucky){
              endTurn({log:"你被里面冲出来的东西擦伤，仓皇退出。", delta:{hp:-3, morale:-1, threat:+1}});
            } else {
              setFlag('pharmacyLoot', true);
              state.story.vars.trust = (state.story.vars.trust||0)+1;
              endTurn({log:"你带走了药品与一张折起的通行证。洛看见后，眼神变了。", delta:{med:+2, scrap:-1, morale:+2, threat:+0}});
              storyEnqueueMany(["safehouse_2","chapter_2_end"]);
            }
          }
        },
        {
          text:"不进去（保命，但剧情推进慢）",
          kind:"muted",
          resolve:()=>{
            endTurn({log:"你没有进去。你决定先把自己活下去。", delta:{morale:+0, threat:+0}});
            storyEnqueueMany(["safehouse_2"]);
          }
        }
      ]
    },

    {
      id:"safehouse_2",
      dayMin: 10,
      title:"安全点的守门人",
      intro:"你终于找到‘安全点’的入口：一扇看似普通的铁门。门后有人问：‘暗号？’",
      requires:()=> (state.story.vars.chapter||1)===2 && !storyHas("safehouse_2"),
      options:()=>[
        {
          text:"说出暗号：‘海鸥不在夜里飞’（进入）",
          kind:"good",
          req:()=> !!state.flags.radioClue,
          log:"门锁响了一声。你被允许进入狭窄的走廊。",
          delta:{morale:+2, threat:+0},
          setFlags:{ safehouseIn:true },
          next:["safehouse_3","chapter_2_end"]
        },
        {
          text:"试探性回答（可能被赶走）",
          kind:"primary",
          log:"门后沉默了几秒，随后传来一句：‘走。’",
          delta:{morale:-1, threat:+0},
          next:["blackflag_2","redknives_hint_1"]
        }
      ]
    },

    {
      id:"blackflag_2",
      dayMin: 11,
      title:"黑旗的邀约",
      intro:"你在墙角看到黑旗的标记。有人留了一张纸：‘我们不抢同类，我们只收债。’",
      requires:()=> (state.story.vars.chapter||1)===2 && !storyHas("blackflag_2"),
      options:()=>[
        {
          text:"去见他们（可能获得补给）",
          kind:"primary",
          log:"你决定见一面，至少了解规则。",
          delta:{morale:+0, threat:+1},
          setFlags:{ blackflagContact:true },
          next:["blackflag_3"]
        },
        {
          text:"无视（保持独行）",
          kind:"muted",
          log:"你不想被任何旗帜绑定。",
          delta:{morale:+1, threat:+0},
          next:["safehouse_3"]
        }
      ]
    },

    {
      id:"redknives_hint_1",
      dayMin: 12,
      title:"红刀的传闻",
      intro:"你听到路人低声说‘红刀’在找一个拿着坐标的人。你突然觉得背后发凉。",
      requires:()=> (state.story.vars.chapter||1)===2 && !storyHas("redknives_hint_1"),
      options:()=>[
        {
          text:"更换路线（降低威胁）",
          kind:"good",
          log:"你绕远路回避人群。",
          delta:{morale:+0, threat:-1},
          next:["chapter_2_end"]
        },
        {
          text:"加快行动（可能更快推进但更危险）",
          kind:"primary",
          log:"你决定不再拖延。",
          delta:{morale:+0, threat:+1},
          next:["chapter_2_end","finale_prep_1"]
        }
      ]
    },

    {
      id:"chapter_2_end",
      dayMin: 13,
      title:"你开始被‘世界’看见",
      intro:"你意识到你不再只是一个躲在避难所里的人。有人在等你，有人在找你。",
      requires:()=> (state.story.vars.chapter||1)===2 && !storyHas("chapter_2_end"),
      options:()=>[
        {
          text:"继续追线索（进入第三章）",
          kind:"primary",
          log:"你决定把坐标补全，找到‘那地方’。",
          delta:{morale:+1, threat:+0},
          setVars:{ chapter: 3 },
          next:["finale_prep_1","safehouse_3","blackflag_3"]
        },
        {
          text:"先稳住生存（进入第三章，但节奏更慢）",
          kind:"muted",
          log:"你决定先建立更稳定的补给。",
          delta:{morale:+1, threat:-1},
          setVars:{ chapter: 3 },
          next:["safehouse_3","finale_prep_1"]
        }
      ]
    },

    {
      id:"finale_prep_1",
      dayMin: 16,
      title:"最后一段坐标",
      intro:"你终于拼出完整坐标。它指向城外的旧水厂——传说那里还在运转。",
      requires:()=> (state.story.vars.chapter||1)===3 && !storyHas("finale_prep_1"),
      options:()=>[
        {
          text:"带上同伴一起（更安全，但要付出代价）",
          kind:"good",
          req:()=> (state.story.vars.trust||0) >= 1,
          log:"你决定不再单打独斗。",
          delta:{morale:+2, threat:+0},
          next:["finale_1"]
        },
        {
          text:"独自出发（更快，但更危险）",
          kind:"primary",
          log:"你把所有东西塞进背包，准备单独出发。",
          delta:{morale:+1, threat:+1},
          next:["finale_1"]
        }
      ]
    },

    {
      id:"finale_1",
      dayMin: 18,
      title:"旧水厂的灯",
      intro:"你在夜里看到远处有灯光——不是火焰，是电。旧水厂真的还在运转。",
      requires:()=> (state.story.vars.chapter||1)===3 && !storyHas("finale_1"),
      options:()=>[
        {
          text:"进入水厂（结局分支：重建）",
          kind:"good",
          resolve:()=>{
            endTurn({log:"你踏进水厂，听见机器低鸣。你不知道这是不是陷阱，但你知道：这是‘开始’。
【结局：重建的火种】", delta:{morale:+3, threat:-2}});
            // soft-ending: mark run as 'completed' but allow continuing
            state.flags.storyCompleted = true;
            logEntry("你可以继续生存下去，或者开新一局探索别的选择。", "系统");
            render();
          }
        },
        {
          text:"放弃进入，回到避难所（结局分支：苟活）",
          kind:"muted",
          resolve:()=>{
            endTurn({log:"你在门口停住了。你选择回头。你活着，但故事还没结束。
【结局：活下去就够了】", delta:{morale:+1, threat:+0}});
            state.flags.storyCompleted = true;
            render();
          }
        }
      ]
    }
  );

  const EVENT_TEMPLATES = [
    {
      type:"scavenge",
      title:"废墟超市",
      intro:"你发现一间被洗劫过的超市，货架下还有些东西。",
      options:(ctx)=>[
        {
          text:"谨慎搜刮（低风险）",
          resolve:()=> scavenge(ctx, {risk:"low"})
        },
        {
          text:"深入后仓（高收益/高风险）",
          resolve:()=> scavenge(ctx, {risk:"high"})
        },
        {
          text:"放弃，继续前进",
          resolve:()=> endTurn({log:"你决定不冒险。", delta:{morale:+0}})
        }
      ]
    },
    {
      type:"combat",
      title:"街角尸群",
      intro:"远处传来拖行声，一小群感染者挡住了路线。",
      options:(ctx)=>[
        {
          text:`开火清路（耗弹）`,
          resolve:()=> combat(ctx, {style:"shoot"})
        },
        {
          text:`绕路潜行（耗时间/概率失败）`,
          resolve:()=> combat(ctx, {style:"sneak"})
        },
        {
          text:`硬跑（高概率受伤）`,
          resolve:()=> combat(ctx, {style:"run"})
        }
      ]
    },
    {
      type:"trade",
      title:"流浪商人",
      intro:"一个戴防毒面具的人从阴影里出现：'换点东西？'",
      options:(ctx)=>[
        {
          text:"用废料换食物（2废料→3食物）",
          req:()=> state.scrap >= 2,
          resolve:()=> trade({scrap:-2, food:+3}, "你用废料换到了罐头。")
        },
        {
          text:"用废料换水（2废料→4水）",
          req:()=> state.scrap >= 2,
          resolve:()=> trade({scrap:-2, water:+diff().tradeWater}, `他递来${diff().tradeWater}单位干净水。`)
        },
        {
          text:"用弹药换医疗（3弹→1医疗）",
          req:()=> state.ammo >= 3,
          resolve:()=> trade({ammo:-3, med:+1}, "他递来一支止血针。")
        },
        {
          text:"打劫他（高风险高回报）",
          resolve:()=> mug(ctx)
        }
      ]
    },
    {
      type:"weather",
      title:"酸雨",
      intro:"天空发绿，酸雨落下。暴露在外会灼伤皮肤。",
      options:(ctx)=>[
        {
          text:"就地找掩体（消耗水/士气）",
          resolve:()=> weather(ctx, {choice:"shelter"})
        },
        {
          text:"硬顶着赶路（受伤/加威胁）",
          resolve:()=> weather(ctx, {choice:"push"})
        }
      ]
    },
    {
      type:"trap",
      title:"地雷区",
      intro:"你看到地面有不自然的凸起——有人布了雷。",
      options:(ctx)=>[
        {
          text:"慢慢排雷（耗时但安全）",
          resolve:()=> trap(ctx, {choice:"disarm"})
        },
        {
          text:"赌一把冲过去（概率受伤）",
          resolve:()=> trap(ctx, {choice:"dash"})
        }
      ]
    },
    {
      type:"story",
      title:"广播电台残响",
      intro:"你在一间办公室里发现一台半坏的短波电台，喇叭里断断续续传来有人在喊坐标。",
      options:(ctx)=>[
        {
          text:"调频收听（+士气，解锁线索）",
          resolve:()=>{
            state.flags.radioClue = true;
            endTurn({log:"你记下了断续的坐标与一句暗号。也许以后用得上。", delta:{morale:+2, threat:+0}});
          }
        },
        {
          text:"拆下零件（+废料，略吵）",
          resolve:()=> endTurn({log:"你把电台拆成可用的零件。", delta:{scrap:+3, morale:+0, threat:+1}})
        },
        {
          text:"离开",
          resolve:()=> endTurn({log:"你决定不浪费时间。", delta:{morale:+0, threat:+0}})
        }
      ]
    },
    {
      type:"story",
      title:"日记残页",
      intro:"一沓发黄的纸夹在抽屉里，像是某人的日记。字迹潦草，但能读出恐惧与坚持。",
      options:(ctx)=>[
        {
          text:"认真读完（+士气，获得线索）",
          resolve:()=>{
            state.flags.diaryRead = (state.flags.diaryRead||0) + 1;
            const bonus = state.flags.diaryRead>=3 ? 3 : 2;
            endTurn({log:"你把关键内容记在心里：‘不要在夜里走那条桥。’", delta:{morale:+bonus, threat:+0}});
          }
        },
        {
          text:"撕下空白页当引火物（+食物/补给小收益）",
          resolve:()=> endTurn({log:"你留了几张纸做引火物，至少能热一顿。", delta:{food:+1, morale:+0, threat:+0}})
        },
        {
          text:"收好带走（以后或许有用）",
          resolve:()=>{ state.flags.diaryKept = true; endTurn({log:"你把日记塞进包里。", delta:{morale:+1, threat:+0}}); }
        }
      ]
    },
    {
      type:"water",
      title:"临时净水点",
      intro:"你看到一处被塑料布遮住的水桶，旁边有粗糙的过滤装置。看起来有人在这里取水。",
      options:(ctx)=>[
        {
          text:"补满水袋（+水，但可能引人注意）",
          resolve:()=> endTurn({log:"你装了些水离开。", delta:{water:+diff().waterEvent.fill, morale:+0, threat:+0}})
        },
        {
          text:"先过滤再装（耗废料，降低风险）",
          req:()=> state.scrap>=1,
          resolve:()=> endTurn({log:"你用一点零件加固过滤装置，取水更安心。", delta:{scrap:-1, water:+diff().waterEvent.fortify, morale:+1, threat:+0}})
        },
        {
          text:"不碰它",
          resolve:()=> endTurn({log:"你不确定这里是否安全，选择离开。", delta:{morale:+0, threat:+0}})
        }
      ]
    },
    {
      type:"story",
      title:"求救信号",
      intro:"远处楼里闪了两下灯。有人用镜面反光引你注意。",
      options:(ctx)=>[
        {
          text:"回应并靠近（可能结识同伴）",
          resolve:()=>{
            const bad = r() < (0.25 + state.threat*0.02 - (state.flags.lucky?0.06:0));
            if(!bad){
              state.flags.survivorMet = true;
              endTurn({log:"你遇到一位幸存者，对方给了你一点物资作为谢意，并说‘北边有个安全点’。", delta:{food:+2, water:+1, morale:+2, threat:+0}});
            }else{
              endTurn({log:"你靠近后发现是诱饵。你仓促撤离，心情糟透了。", delta:{morale:-2, threat:+2}});
            }
          }
        },
        {
          text:"保持距离观察（小收益）",
          resolve:()=> endTurn({log:"你确认附近没人跟踪，顺手搜到点零件。", delta:{scrap:+1, morale:+1, threat:+0}})
        },
        {
          text:"无视",
          resolve:()=> endTurn({log:"你不想冒险。", delta:{morale:+0, threat:+0}})
        }
      ]
    },
    {
      type:"story",
      title:"黑旗帮哨",
      intro:"一名持械的哨兵挡住去路，臂章上画着黑色旗帜。‘过路费。’",
      options:(ctx)=>[
        {
          text:"交废料（2废料换平安）",
          req:()=> state.scrap>=2,
          resolve:()=> endTurn({log:"你把废料递过去，对方放你离开。", delta:{scrap:-2, morale:+0, threat:+0}})
        },
        {
          text:"用弹药吓退（消耗弹药，威胁上升）",
          req:()=> state.ammo>=2,
          resolve:()=> endTurn({log:"你朝天鸣枪，对方退后让路，但动静引来关注。", delta:{ammo:-2, morale:+0, threat:+2}})
        },
        {
          text:"尝试谈判（看士气）",
          req:()=> state.morale>=8,
          resolve:()=> endTurn({log:"你稳住语气讲明处境，对方嘟囔两句，还是放你过去。", delta:{morale:+1, threat:+0}})
        },
        {
          text:"撤退绕路（耗神）",
          resolve:()=> endTurn({log:"你绕了一大圈，安全但很累。", delta:{morale:-1, threat:+0}})
        }
      ]
    },
    {
      type:"story",
      title:"小孩的涂鸦箭头",
      intro:"墙上有新鲜的涂鸦箭头，像是在指向某处：‘这里有吃的’。",
      options:(ctx)=>[
        {
          text:"跟着箭头走（可能有补给，也可能是陷阱）",
          resolve:()=>{
            const bad = r() < (0.22 + state.threat*0.02 - (state.flags.lucky?0.06:0));
            if(!bad){
              endTurn({log:"你找到一处隐藏的储物箱。", delta:{food:+4, water:+2, morale:+2, threat:+0}});
            }else{
              const dmg = Math.ceil((3+state.zone)*(0.7+r()*0.8)*ctx.ambushDmgMult);
              endTurn({log:`你踩到碎玻璃引来动静，被迫冲出去（-${dmg} 生命）。`, delta:{hp:-dmg, morale:-1, threat:+2}});
            }
          }
        },
        {
          text:"只在附近搜一下（稳）",
          resolve:()=> endTurn({log:"你在附近捡到些可用的小东西。", delta:{scrap:+2, morale:+1, threat:+0}})
        },
        {
          text:"不信这种话",
          resolve:()=> endTurn({log:"你不想被牵着鼻子走。", delta:{morale:+0, threat:+0}})
        }
      ]
    },
    {
      type:"story",
      title:"封闭的地铁闸门",
      intro:"地铁口被铁闸封死，里面黑得像墨。你听见里面有水滴声，也许有物资，也许有麻烦。",
      options:(ctx)=>[
        {
          text:"用工具撬开（耗废料，收益更高）",
          req:()=> state.scrap>=2,
          resolve:()=>{
            const bad = r() < (0.18 + state.threat*0.02 - (state.flags.lucky?0.05:0));
            if(!bad){
              endTurn({log:"你撬开闸门，从站台角落带走了补给。", delta:{scrap:-2, food:+3, water:+3, ammo:+2, morale:+1, threat:+1}});
            }else{
              endTurn({log:"闸门一响就惊动了东西，你只能撤退。", delta:{scrap:-2, morale:-1, threat:+2}});
            }
          }
        },
        {
          text:"丢石子探路（低成本）",
          resolve:()=> endTurn({log:"回声很空。你捡了点散落的零件就走。", delta:{scrap:+1, morale:+0, threat:+0}})
        },
        {
          text:"离开",
          resolve:()=> endTurn({log:"你不想进这种地方。", delta:{morale:+0, threat:+0}})
        }
      ]
    }
  ];

  const UPGRADE_POOL = [
    {
      id:"maxhp",
      name:"+3 最大生命",
      desc:"更抗揍。",
      apply:()=> { state.maxHp += 3; state.hp += 3; }
    },
    {
      id:"maxmorale",
      name:"+4 最大士气",
      desc:"更稳。",
      apply:()=> { state.maxMorale += 4; state.morale += 2; }
    },
    {
      id:"findWater",
      name:"净水技巧",
      desc:"每天消耗水 -1（最低1）。",
      apply:()=> { state.flags.waterSaver = true; }
    },
    {
      id:"ammoSmith",
      name:"简易压弹",
      desc:"制造：1废料→+2弹药。",
      apply:()=> { state.flags.ammoCraft = true; }
    },
    {
      id:"quietSteps",
      name:"无声脚步",
      desc:"潜行成功率 +15%。",
      apply:()=> { state.flags.sneakBonus = (state.flags.sneakBonus||0) + 0.15; }
    },
    {
      id:"lucky",
      name:"好运",
      desc:"所有随机奖励小幅偏向正面。",
      apply:()=> { state.flags.lucky = true; }
    }


    // ===== Chapter 2: the coordinates lead somewhere =====
    {
      id:"safehouse_1",
      dayMin: 6,
      title:"北边的安全点？",
      intro:"你沿着线索摸到一片被封锁的街区，墙上刷着同一行字：‘海鸥不在夜里飞。’——暗号对上了。",
      requires:()=> (state.flags.radioClue || state.story.vars.clue==="map") && !storyHas("safehouse_1"),
      options:(ctx)=>[
        {
          text:"敲门并报暗号（推进主线）",
          kind:"primary",
          log:"你压低声音报出暗号，里面沉默了几秒，门栓才松开。",
          delta:{ morale:+1, threat:+0 },
          setFlags:{ metLuo:true },
          setVars:{ trust:(state.story.vars.trust||0)+1, chapter:2 },
          next:["luo_1","faction_1"]
        },
        {
          text:"先观察一圈（更安全）",
          kind:"good",
          log:"你绕到侧门，发现脚印新鲜——这里确实有人。",
          delta:{ morale:+1, threat:+0 },
          setVars:{ chapter:2 },
          next:["faction_1","luo_1"]
        },
        {
          text:"放弃（你不信任何据点）",
          kind:"bad",
          log:"你把暗号咽回肚子里，转身离开。",
          delta:{ morale:+0, threat:+0 },
          setFlags:{ loneWolf:true },
          next:["blackflag_2","diary_2"]
        }
      ]
    },

    {
      id:"luo_1",
      dayMin: 7,
      title:"一个叫‘洛’的人",
      intro:"开门的是个眼神很冷的青年，自称‘洛’。他不问你从哪来，只问：‘你带来的，是麻烦还是答案？’",
      requires:()=> state.flags.metLuo && !storyHas("luo_1"),
      options:(ctx)=>[
        {
          text:"把你知道的都说出来（建立信任）",
          kind:"good",
          log:"你把地图、电台、坐标的来龙去脉都摊开。洛听完只说：‘那就别走错。’",
          delta:{ morale:+2, threat:+0 },
          setVars:{ trust:(state.story.vars.trust||0)+1 },
          next:["luo_2","faction_1"]
        },
        {
          text:"只说一半（保留底牌）",
          kind:"primary",
          log:"你只说了‘暗号对上’。洛没追问，但眼神更冷了。",
          delta:{ morale:+1, threat:+0 },
          setVars:{ trust:(state.story.vars.trust||0)+0 },
          next:["faction_1","blackflag_2"]
        },
        {
          text:"反问他是谁（强硬）",
          kind:"danger",
          log:"你顶回去：‘先说你是谁。’洛嗤笑：‘你会知道的。’",
          delta:{ morale:+0, threat:+1 },
          setVars:{ trust:(state.story.vars.trust||0)-1 },
          next:["blackflag_2"]
        }
      ]
    },

    {
      id:"faction_1",
      dayMin: 8,
      title:"黑旗与红刀",
      intro:"据点里有人提到两股势力：‘黑旗’在收容幸存者，‘红刀’在收税——用血。你会站在哪边？",
      requires:()=> !storyHas("faction_1") && (state.story.vars.chapter||1) >= 2,
      options:(ctx)=>[
        {
          text:"偏向黑旗（更稳的补给）",
          kind:"good",
          log:"你决定先靠近黑旗。至少他们还讲‘规则’。",
          delta:{ morale:+1, threat:+0 },
          setFlags:{ sideBlackflag:true },
          next:["blackflag_2","luo_2"]
        },
        {
          text:"探探红刀（高风险线）",
          kind:"danger",
          log:"你想知道红刀到底想要什么。危险，但线索也许在那边。",
          delta:{ morale:+0, threat:+1 },
          setFlags:{ sideRedknives:true },
          next:["redknives_1"]
        },
        {
          text:"两边都不站（保持自由）",
          kind:"primary",
          log:"你不想把命交给任何旗帜。",
          delta:{ morale:+1, threat:+0 },
          setFlags:{ neutral:true },
          next:["diary_2","blackflag_2"]
        }
      ]
    },

    {
      id:"blackflag_2",
      dayMin: 9,
      title:"黑旗的交易",
      intro:"黑旗的人愿意用补给换你手里的线索：‘坐标给我们，我们给你安全。’",
      requires:()=> (state.flags.sideBlackflag || state.flags.neutral || state.flags.loneWolf) && !storyHas("blackflag_2"),
      options:(ctx)=>[
        {
          text:"交出坐标（安全↑，自由↓）",
          kind:"primary",
          log:"你把坐标写在纸上递过去。对方点头：‘你现在是我们的人。’",
          delta:{ food:+2, water:+1, morale:+1, threat:+0 },
          setFlags:{ gaveCoords:true },
          setVars:{ chapter:3 },
          next:["ending_path_1","luo_3"]
        },
        {
          text:"拒绝（你要亲自去）",
          kind:"good",
          log:"你把纸撕掉：‘我自己去。’对方沉默了一会：‘那就别死在路上。’",
          delta:{ morale:+2, threat:+1 },
          setFlags:{ keepCoords:true },
          setVars:{ chapter:3 },
          next:["ending_path_2","luo_3"]
        },
        {
          text:"撒谎（给假坐标）",
          kind:"danger",
          log:"你报了一个改过的坐标。你不知道这会害死谁，也可能害死你。",
          delta:{ morale:+0, threat:+2 },
          setFlags:{ fakeCoords:true },
          setVars:{ chapter:3 },
          next:["ending_path_3"]
        }
      ]
    },

    {
      id:"luo_2",
      dayMin: 10,
      title:"洛的提醒",
      intro:"洛把你叫到走廊尽头：‘别被任何人许诺的“安全”骗了。这个城市里，安全是要付账的。’",
      requires:()=> state.flags.metLuo && !storyHas("luo_2"),
      options:(ctx)=>[
        {
          text:"问他想要什么（更深的关系）",
          kind:"good",
          log:"洛沉默很久：‘我想要一个能回去的地方。’",
          delta:{ morale:+2, threat:+0 },
          setVars:{ trust:(state.story.vars.trust||0)+1 },
          next:["luo_3","diary_2"]
        },
        {
          text:"说你只想活下去（现实）",
          kind:"primary",
          log:"你直说：‘我只想活下去。’洛点头：‘那就别做蠢选择。’",
          delta:{ morale:+1, threat:+0 },
          next:["luo_3"]
        }
      ]
    },

    {
      id:"luo_3",
      dayMin: 12,
      title:"一把钥匙",
      intro:"洛塞给你一把旧钥匙：‘如果你真要去坐标点，路上会用到。’钥匙上刻着一个编号。",
      requires:()=> state.flags.metLuo && !storyHas("luo_3") && (state.story.vars.chapter||1) >= 3,
      options:(ctx)=>[
        {
          text:"收下（你欠他一个人情）",
          kind:"good",
          log:"你把钥匙攥紧。你知道这意味着牵连。",
          delta:{ morale:+1, threat:+0 },
          setFlags:{ gotKey:true },
          next:["ending_path_1","ending_path_2"]
        },
        {
          text:"拒绝（不想欠）",
          kind:"primary",
          log:"你把钥匙推回去。洛没再说什么。",
          delta:{ morale:+0, threat:+0 },
          setFlags:{ refusedKey:true },
          next:["ending_path_2"]
        }
      ]
    },

    // ===== Endgame hooks (v1 endings) =====
    {
      id:"ending_path_1",
      dayMin: 15,
      title:"封锁线",
      intro:"你抵达坐标附近，发现那里被临时封锁：铁丝网、路障、巡逻的人影。你必须决定：硬闯？潜入？还是谈判？",
      requires:()=> (state.flags.gaveCoords || state.flags.gotKey) && !storyHas("ending_path_1"),
      options:(ctx)=>[
        {
          text:"用钥匙找旁门（如果你有）",
          kind:"good",
          req:()=> !!state.flags.gotKey,
          log:"钥匙对上了。门后是一段向下的阶梯，空气里有消毒水味。",
          delta:{ threat:+0, morale:+2 },
          next:["ending_1"]
        },
        {
          text:"绕路潜入（更看运气）",
          kind:"primary",
          log:"你贴着阴影前进，屏住呼吸穿过空地。",
          delta:{ threat:+1, morale:+1 },
          next:["ending_2"]
        },
        {
          text:"硬闯（最危险）",
          kind:"danger",
          log:"你决定不再躲。你冲向封锁线。",
          delta:{ threat:+2, morale:+0 },
          next:["ending_3"]
        }
      ]
    },

    {
      id:"ending_path_2",
      dayMin: 15,
      title:"回不去的路",
      intro:"你开始怀疑：坐标点也许不是‘救赎’，而是‘陷阱’。但你已经走到这一步。",
      requires:()=> (state.flags.keepCoords || state.flags.refusedKey) && !storyHas("ending_path_2"),
      options:(ctx)=>[
        {
          text:"继续前进（你要答案）",
          kind:"primary",
          log:"你把疑虑压下去。答案只有一个方向。",
          delta:{ morale:+1, threat:+1 },
          next:["ending_2"]
        },
        {
          text:"回到据点（选择活着）",
          kind:"good",
          log:"你选择不赌‘英雄叙事’，选择活着。",
          delta:{ food:+1, water:+1, morale:+2, threat:+0 },
          next:["ending_4"]
        }
      ]
    },

    {
      id:"ending_path_3",
      dayMin: 15,
      title:"谎言的回声",
      intro:"你给出的假坐标开始发酵。有人失踪，有人怀疑。你能感觉到目光在跟着你。",
      requires:()=> state.flags.fakeCoords && !storyHas("ending_path_3"),
      options:(ctx)=>[
        {
          text:"坦白（也许还能挽回）",
          kind:"primary",
          log:"你承认了撒谎。空气里只剩呼吸声。",
          delta:{ morale:-1, threat:+1 },
          next:["ending_2"]
        },
        {
          text:"继续装下去（代价更大）",
          kind:"danger",
          log:"你决定把谎言走到底。",
          delta:{ morale:+0, threat:+3 },
          next:["ending_3"]
        }
      ]
    },

    {
      id:"ending_1",
      dayMin: 16,
      title:"地下灯光",
      intro:"楼下有稳定电力与整齐的床铺。有人在白板上写：‘欢迎回家’。你意识到：这不是终点，而是新规则的开始。",
      requires:()=> !storyHas("ending_1"),
      options:(ctx)=>[
        {
          text:"留下（进入重建线）",
          kind:"good",
          log:"你把背包放下，第一次允许自己睡得更沉一点。——【结局：灯下】",
          delta:{ morale:+3, threat:+0 },
          next:["post_end_free"]
        }
      ]
    },

    {
      id:"ending_2",
      dayMin: 16,
      title:"答案在风里",
      intro:"你没有找到‘终极安全’，只找到更多线索：更多坐标、更多暗号、更多失踪的名字。你仍然活着。",
      requires:()=> !storyHas("ending_2"),
      options:(ctx)=>[
        {
          text:"继续走（开放式结局）",
          kind:"primary",
          log:"你把名字记在本子上，继续走进灰尘里。——【结局：回声】",
          delta:{ morale:+2, threat:+0 },
          next:["post_end_free"]
        }
      ]
    },

    {
      id:"ending_3",
      dayMin: 16,
      title:"封锁线的代价",
      intro:"你闯过封锁线，但代价很重。你知道自己或许做了对的事，也或许只是幸运还没用完。",
      requires:()=> !storyHas("ending_3"),
      options:(ctx)=>[
        {
          text:"接受代价（硬核结局）",
          kind:"danger",
          log:"你坐在路边，把血和雨擦掉。——【结局：代价】",
          delta:{ morale:+1, threat:+0 },
          next:["post_end_free"]
        }
      ]
    },

    {
      id:"ending_4",
      dayMin: 16,
      title:"活着的人",
      intro:"你回到据点。没有掌声，也没有‘终极答案’。只有活着的人、可用的水、以及明天要做的事。",
      requires:()=> !storyHas("ending_4"),
      options:(ctx)=>[
        {
          text:"把日子过下去（温和结局）",
          kind:"good",
          log:"你把火生起来。——【结局：余温】",
          delta:{ morale:+3, threat:+0 },
          next:["post_end_free"]
        }
      ]
    },

    {
      id:"post_end_free",
      dayMin: 17,
      title:"余波",
      intro:"故事没有真正结束。你做过的选择会继续在城里发酵。你可以继续探索——或者重开一局，看看别的分支。",
      requires:()=> !storyHas("post_end_free"),
      options:(ctx)=>[
        {
          text:"继续下一天（自由模式）",
          kind:"primary",
          log:"你深呼吸，继续走。",
          delta:{ morale:+0, threat:+0 },
          next:[]
        }
      ]
    },
  ];

  // -----------------------------
  // Utility
  // -----------------------------
  function r(){
    return rng();
  }
  function ri(n){
    return Math.floor(r()*n);
  }
  function pick(arr){
    return arr[ri(arr.length)];
  }
  function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }

  function ctxBase(){
    const ctx = {
      lootMult: 1,
      restHeal: 2,
      medHeal: 5,
      ambushDmgMult: 1,
      combatAmmoDiscount: 0,
      craftScrapDiscount: 0,
      escapeBonus: 0,
      sneakBonus: (state.flags.sneakBonus||0),
      lucky: !!state.flags.lucky
    };
    ctx.lootMult *= diff().lootMult;
    // apply traits
    for (const t of state.traits){
      const trait = TRAITS.find(x=>x.id===t.id);
      if (trait?.mod) trait.mod(ctx);
    }
    return ctx;
  }


  // -----------------------------
  // Difficulty presets (tuned for story-first experience)
  // -----------------------------
  const DIFFICULTY = {
    easy:   { name:"简单", foodCost:2, waterCost:1, hungerDmg:1, thirstDmg:1, lootMult:1.12,
              lootBuckets:["water","water","food","food","ammo","scrap","med"],
              craft:{ ammo:6, med:2, food:5, water:4 }, waterEvent:{fill:4, fortify:5}, tradeWater:5 },
    normal: { name:"普通", foodCost:2, waterCost:2, hungerDmg:1, thirstDmg:2, lootMult:1.00,
              lootBuckets:["water","food","food","ammo","scrap","med"],
              craft:{ ammo:5, med:2, food:4, water:3 }, waterEvent:{fill:3, fortify:4}, tradeWater:4 },
    hard:   { name:"困难", foodCost:2, waterCost:2, hungerDmg:2, thirstDmg:3, lootMult:0.92,
              lootBuckets:["water","food","ammo","ammo","scrap","scrap","med"],
              craft:{ ammo:4, med:1, food:3, water:2 }, waterEvent:{fill:2, fortify:3}, tradeWater:3 },
  };

  function diff(){
    return DIFFICULTY[state.settings?.difficulty || 'normal'] || DIFFICULTY.normal;
  }

  function dailyCosts(){
    const d = diff();
    const waterBase = d.waterCost;
    const waterCost = state.flags.waterSaver ? Math.max(1, waterBase - 1) : waterBase;
    return { foodCost: d.foodCost, waterCost };
  }

  function logEntry(text, meta=""){
    const log = $("log");
    const el = document.createElement("div");
    el.className = "entry";
    const m = document.createElement("div");
    m.className = "meta";
    m.innerHTML = `<span>${meta || ("Day " + state.day)}</span><span>${new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"})}</span>`;
    const t = document.createElement("div");
    t.className = "text";
    t.textContent = text;
    el.appendChild(m);
    el.appendChild(t);
    log.appendChild(el);
    log.scrollTop = log.scrollHeight;
    return el;
  }

  function logEventCard(title, intro, options){
    const el = logEntry(`${title}：${intro}`, `Day ${state.day} / 事件`);
    const opts = document.createElement("div");
    opts.className = "opts";
    options.forEach((o, idx)=>{
      const b = document.createElement("button");
      b.textContent = o.text;
      const ok = o.req ? !!o.req() : true;
      b.disabled = !ok;
      if (o.kind==="primary") b.classList.add("primary");
      if (o.kind==="danger") b.classList.add("danger");
      if (o.kind==="good") b.classList.add("good");
      b.onclick = () => {
        if (state.pendingChoice && state.pendingChoice !== el) return;
        state.pendingChoice = null;
        b.blur();
        // disable all buttons in this card after choice
        [...opts.querySelectorAll("button")].forEach(x=>x.disabled=true);
        o.resolve();
      };
      opts.appendChild(b);
    });
    el.appendChild(opts);
    state.pendingChoice = el;
  }

  function applyDelta(delta){
    // Record last delta for UI
    state.lastDelta = delta || {};
    const d = delta || {};
    for (const [k,v] of Object.entries(d)){
      if (typeof state[k] !== "number") continue;
      state[k] += v;
    }
    // clamps
    state.hp = clamp(state.hp, 0, state.maxHp);
    state.morale = clamp(state.morale, 0, state.maxMorale);
    state.food = Math.max(0, state.food);
    state.water = Math.max(0, state.water);
    state.ammo = Math.max(0, state.ammo);
    state.med = Math.max(0, state.med);
    state.scrap = Math.max(0, state.scrap);
    state.threat = Math.max(0, state.threat);

    if (state.hp <= 0 || state.morale <= 0){
      gameOver();
    }
  }

  function endTurn({log, delta, meta}){
    if (log) logEntry(log, meta || `Day ${state.day} / 结果`);
    if (delta) applyDelta(delta);    // daily consumption (balanced by difficulty; penalties are visible)
    const { waterCost, foodCost } = dailyCosts();

    // apply consumption manually so we can detect shortages BEFORE clamping
    state.lastDelta = state.lastDelta || {};
    state.water -= waterCost;
    state.food  -= foodCost;
    state.lastDelta.water = (state.lastDelta.water || 0) - waterCost;
    state.lastDelta.food  = (state.lastDelta.food  || 0) - foodCost;

    let hpPenalty = 0;
    if (state.food < 0){
      const miss = -state.food;
      state.food = 0;
      const dmg = miss * diff().hungerDmg;
      hpPenalty += dmg;
      logEntry(`食物不足，你挨饿受损（-${dmg} 生命）。`, `Day ${state.day} / 饥饿`);
    }
    if (state.water < 0){
      const miss = -state.water;
      state.water = 0;
      const dmg = miss * diff().thirstDmg; // 脱水惩罚按难度
      hpPenalty += dmg;
      logEntry(`水不足，你严重脱水（-${dmg} 生命）。`, `Day ${state.day} / 脱水`);
    }
    if (hpPenalty > 0){
      state.hp -= hpPenalty;
      state.lastDelta.hp = (state.lastDelta.hp || 0) - hpPenalty;
      state.hp = clamp(state.hp, 0, state.maxHp);
      if (state.hp <= 0){ gameOver(); return; }
    }

    // threat drifts upward over time
    applyDelta({ threat: + (state.day % 2 === 0 ? 1 : 0) });

    // day advance
    state.day += 1;
    if (state.day % 5 === 0) state.zone += 1;

    render();
  }

  function luckBias(){
    // if lucky, reduce chance of worst outcomes a bit
    return state.flags.lucky ? 0.08 : 0;
  }

  // -----------------------------
  // Event Resolvers
  // -----------------------------
  function scavenge(ctx, {risk}){
    const base = risk==="high" ? 6 : 4;
    const variance = risk==="high" ? 8 : 5;

    // risk check
    const danger = (risk==="high" ? 0.35 : 0.18) + state.threat*0.02;
    const dangerRoll = r();
    const hit = dangerRoll < (danger - luckBias());

    const loot = Math.max(1, Math.floor((base + ri(variance)) * ctx.lootMult));
    const gain = splitLoot(loot);

    if (!hit){
      endTurn({
        log:`你搜到了可用物资：${formatGain(gain)}。`,
        delta: { ...gain, morale:+1, threat:+ (risk==="high" ? 1 : 0) }
      });
    } else {
      const dmg = Math.ceil((risk==="high"?6:4) * (0.6 + r()*0.8) * ctx.ambushDmgMult);
      endTurn({
        log:`你翻柜子时触发了响动！一只感染者扑来，你受伤（-${dmg} 生命），但仍带走了物资：${formatGain(gain)}。`,
        delta: { ...gain, hp:-dmg, morale:-1, threat:+2 }
      });
    }
  }

  function splitLoot(points){
    // distribute points into resources
    const buckets = diff().lootBuckets; // 按难度调整基础掉落权重
    const gain = {food:0, water:0, ammo:0, scrap:0, med:0};
    for (let i=0;i<points;i++){
      const k = pick(buckets);
      gain[k] += 1;
    }
    // med rarer
    if (gain.med > 2) { gain.scrap += (gain.med-2); gain.med = 2; }
    return gain;
  }

  function formatGain(g){
    const parts = [];
    for (const k of ["food","water","ammo","med","scrap"]){
      if ((g[k]||0) > 0) parts.push(`${nameOf(k)}+${g[k]}`);
    }
    return parts.join("，") || "无";
  }

  function nameOf(k){
    return ({
      hp:"生命",
      morale:"士气",
      food:"食物",
      water:"水",
      ammo:"弹药",
      med:"医疗",
      scrap:"废料",
      threat:"威胁",
      zone:"区域"
    })[k] || k;
  }

  function combat(ctx, {style}){
    const enemy = 6 + state.zone*2 + Math.floor(state.threat*0.6);
    const sneakRate = clamp(0.45 + ctx.sneakBonus - state.threat*0.03, 0.08, 0.85);
    const escapeRate = clamp(0.35 + ctx.escapeBonus - state.threat*0.02, 0.05, 0.8);

    if (style==="shoot"){
      const needAmmo = Math.max(0, Math.ceil(enemy/3) - ctx.combatAmmoDiscount);
      if (state.ammo < needAmmo){
        endTurn({
          log:`你想开火，但弹药不够（需要${needAmmo}）。你被迫撤退，士气下降。`,
          delta:{ morale:-2, threat:+1 }
        });
        return;
      }
      const hurt = Math.max(0, Math.floor((enemy/6) * (r()<0.5?1:2)));
      const loot = splitLoot(3 + ri(4));
      endTurn({
        log:`你消耗${needAmmo}弹清理了尸群。你${hurt>0?`受了点伤（-${hurt}）`:"几乎毫发无损"}，并搜到：${formatGain(loot)}。`,
        delta:{ ammo:-needAmmo, hp:-hurt, ...loot, morale:+1, threat:+1 }
      });
      return;
    }

    if (style==="sneak"){
      const ok = r() < (sneakRate + luckBias());
      if (ok){
        endTurn({
          log:`你压低呼吸，从阴影里绕开了尸群。虽然慢，但安全。`,
          delta:{ morale:+1, threat:+0 }
        });
      } else {
        const dmg = Math.ceil((4 + state.zone) * (0.8 + r()*0.6));
        endTurn({
          log:`你潜行失败！被突然袭击，慌乱撤退（-${dmg} 生命）。`,
          delta:{ hp:-dmg, morale:-1, threat:+2 }
        });
      }
      return;
    }

    if (style==="run"){
      const ok = r() < (escapeRate + luckBias());
      if (ok){
        endTurn({
          log:`你拔腿就跑，鞋底拍打积水声在巷子里回响，但你甩开了它们。`,
          delta:{ morale:+0, threat:+1 }
        });
      } else {
        const dmg = Math.ceil((6 + state.zone*2) * (0.9 + r()*0.6));
        endTurn({
          log:`你没跑掉，被抓伤（-${dmg} 生命）。你狼狈逃离，威胁上升。`,
          delta:{ hp:-dmg, morale:-2, threat:+3 }
        });
      }
      return;
    }
  }

  function trade(delta, text){
    endTurn({
      log: text,
      delta: { ...delta, morale:+1, threat:+0 }
    });
  }

  function mug(ctx){
    // high variance outcome
    const risk = 0.45 + state.threat*0.02;
    const bad = r() < (risk - luckBias());
    if (!bad){
      const loot = { food: 2+ri(3), water: 1+ri(3), ammo: 1+ri(3), scrap: 1+ri(3) };
      endTurn({
        log:`你成功压制了商人，夺走了补给：${formatGain(loot)}。但这事会传出去。`,
        delta:{ ...loot, morale:+1, threat:+4 }
      });
    } else {
      const dmg = Math.ceil((7 + state.zone) * (0.9 + r()*0.7) * ctx.ambushDmgMult);
      endTurn({
        log:`商人早有准备！你被反击（-${dmg} 生命），还丢了点物资。`,
        delta:{ hp:-dmg, food:-2, water:-1, morale:-2, threat:+5 }
      });
    }
  }

  function weather(ctx, {choice}){
    if (choice==="shelter"){
      endTurn({
        log:`你躲进一辆翻倒的公交车里等雨停。闷热、口渴、心烦。`,
        delta:{ water:-1, morale:-1, threat:+0 }
      });
    } else {
      const dmg = Math.ceil((3 + state.zone) * (0.7 + r()*0.8));
      endTurn({
        log:`你顶着酸雨赶路，皮肤刺痛（-${dmg} 生命）。但你推进了路线。`,
        delta:{ hp:-dmg, threat:+2, morale:+0 }
      });
    }
  }

  function trap(ctx, {choice}){
    if (choice==="disarm"){
      const ok = r() < (0.72 - state.threat*0.02 + luckBias());
      if (ok){
        const scrap = 2 + ri(3);
        endTurn({
          log:`你成功排雷，还拆到一些零件（废料+${scrap}）。`,
          delta:{ scrap:+scrap, morale:+1, threat:+1 }
        });
      } else {
        const dmg = Math.ceil((5 + state.zone) * (0.8 + r()*0.8) * ctx.ambushDmgMult);
        endTurn({
          log:`排雷失误！爆炸把你掀翻（-${dmg} 生命）。`,
          delta:{ hp:-dmg, morale:-2, threat:+3 }
        });
      }
    } else {
      const dmg = (r() < (0.45 + state.threat*0.02 - luckBias()))
        ? Math.ceil((6 + state.zone) * (0.9 + r()*0.8) * ctx.ambushDmgMult)
        : 0;
      endTurn({
        log:`你冲了过去。${dmg>0?`还是踩到了一枚（-${dmg} 生命）`:"侥幸没事"}。`,
        delta:{ hp:-dmg, morale: (dmg>0?-1:+1), threat:+2 }
      });
    }
  }

  // -----------------------------
  // Actions: Rest / Craft / Upgrade
  // -----------------------------
  function doRest(){
    if (state.pendingChoice) return;
    const ctx = ctxBase();
    const heal = ctx.restHeal;
    const morale = 2;
    endTurn({
      log:`你在废楼里睡了个浅觉，稍微恢复了状态（生命+${heal}，士气+${morale}）。`,
      delta:{ hp:+heal, morale:+morale, threat:+0 }
    });
  }

  function doCraft(){
    if (state.pendingChoice) return;
    const ctx = ctxBase();

    const recipes = [
      {
        name: "制造弹药",
        cost: { scrap: Math.max(0, 2 - ctx.craftScrapDiscount) },
        gain: { ammo: state.flags.ammoCraft ? (diff().craft.ammo+1) : diff().craft.ammo },
        kind: "good",
        desc: "把零件压成可用子弹"
      },
      {
        name: "简易医疗包",
        cost: { scrap: Math.max(0, 3 - ctx.craftScrapDiscount) },
        gain: { med: diff().craft.med },
        kind: "good",
        desc: "止血、消毒、固定"
      },
      {
        name: "净水包（简易过滤）",
        cost: { scrap: Math.max(0, 2 - ctx.craftScrapDiscount) },
        gain: { water: diff().craft.water },
        kind: "good",
        desc: "把脏水过滤成可用饮水（剧情模式更友好）"
      },
      {
        name: "应急口粮",
        cost: { scrap: Math.max(0, 1 - ctx.craftScrapDiscount) },
        gain: { food: diff().craft.food },
        kind: "good",
        desc: "热量补给"
      }
    ];

    logEventCard(
      "制造",
      `你整理了一下零件。当前废料：${state.scrap}`,
      [
        ...recipes.map(r => ({
          text: `${r.name}（消耗：${Object.entries(r.cost).map(([k,v])=>`${nameOf(k)}-${v}`).join("，")} → 获得：${formatGain(r.gain)}）`,
          kind: r.kind,
          req: () => Object.entries(r.cost).every(([k,v]) => state[k] >= v),
          resolve: () => {
            // 不消耗天数：不调用 endTurn，只更新资源并立刻刷新
            applyDelta({ ...Object.fromEntries(Object.entries(r.cost).map(([k,v]) => [k, -v])), ...r.gain, morale:+1 });
            logEntry(`你制造了【${r.name}】。`, `Day ${state.day} / 制造`);
            render();
          }
        })),
        {
          text: "取消（不制造）",
          kind: "primary",
          resolve: () => { logEntry("你决定先不制造。", `Day ${state.day} / 制造`); render(); }
        }
      ]
    );
  }

  function doUpgrade(){
    if (state.pendingChoice) return;
    // upgrade costs morale + scrap, but gives random upgrade
    const costScrap = 3;
    const costMorale = 2;
    if (state.scrap < costScrap || state.morale < costMorale){
      logEntry(`升级需要废料${costScrap}和士气${costMorale}。你现在不够。`, `Day ${state.day} / 升级`);
      render();
      return;
    }

    // pick 3 random upgrades to choose
    const pool = shuffle([...UPGRADE_POOL]).slice(0,3);
    const ctx = ctxBase();

    logEventCard("升级选择", "你把废料摊开，开始改造装备。选一个。", pool.map(up => ({
      text:`${up.name} — ${up.desc}`,
      kind:"primary",
      resolve:()=>{
        applyDelta({ scrap:-costScrap, morale:-costMorale });
        up.apply();
        logEntry(`你获得升级：${up.name}。`, `Day ${state.day} / 升级`);
        // upgrades raise threat slightly (noise / attention)
        endTurn({ log:"改造完成，你继续行动。", delta:{ threat:+1 }, meta:`Day ${state.day} / 结果` });
      }
    })));
  }

  // -----------------------------
  // Turn: Next Event
  // -----------------------------
  function nextDayEvent(){
    if (state.pendingChoice) return;

    const ctx = ctxBase();

    // Story: linked narrative that reacts to previous choices
    const sn = storyPickNode();
    if (sn){
      logEventCard(sn.title, sn.intro, storyOptions(sn, ctx));
      render();
      return;
    }

    // Pick event with weights depending on threat/zone
    const weights = EVENT_TEMPLATES.map(e=>{
      let w = 1;
      if (e.type==="story") return 0;
      if (e.type==="combat") w += state.threat*0.25 + state.zone*0.2;
      if (e.type==="scavenge") w += 0.6;
      if (e.type==="trade") w += Math.max(0, 0.8 - state.threat*0.08);
      if (e.type==="trap") w += state.threat*0.2;
      if (e.type==="weather") w += 0.3 + state.zone*0.1;
      if (e.type==="water") w += 1.2; // 调整：更常触发取水事件
      return w;
    });

    const ev = weightedPick(EVENT_TEMPLATES, weights);
    const options = ev.options(ctx);

    logEventCard(ev.title, ev.intro, options);
    render();
  }

  function weightedPick(items, weights){
    const total = weights.reduce((a,b)=>a+b,0);
    let x = r()*total;
    for (let i=0;i<items.length;i++){
      x -= weights[i];
      if (x <= 0) return items[i];
    }
    return items[items.length-1];
  }

  function shuffle(arr){
    for (let i=arr.length-1;i>0;i--){
      const j = Math.floor(r()*(i+1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  // -----------------------------
  // Zombie progress UI (flavor)
  // -----------------------------
  function zombieStatus(){
    // purely UI flavor: based on day+threat
    const p = clamp((state.day*1.8 + state.threat*3) / 100, 0, 1);
    const pct = Math.floor(p*100);
    let stage = "低";
    let impact = "零星感染者活动。";
    if (pct >= 25){ stage="中"; impact="街区危险显著上升。"; }
    if (pct >= 50){ stage="高"; impact="成群游荡，补给点变少。"; }
    if (pct >= 75){ stage="极高"; impact="大范围失守，战斗频繁。"; }
    return { pct, stage, impact };
  }

  // -----------------------------
  // UI Rendering
  // -----------------------------
  function render(){
    $("seedBadge").textContent = `seed: ${state.seedText} · 难度: ${diff().name}`;
    $("runBadge").textContent = `Day ${state.day} · Zone ${state.zone}`;
    $("threatPill").textContent = `威胁：${state.threat}`;

    const z = zombieStatus();
    $("zombiePill").textContent = `僵尸进度：${z.pct}%（${z.stage}）`;
    const dc = dailyCosts();
    const warn = (state.food < dc.foodCost || state.water < dc.waterCost) ? '（警告：明天可能短缺）' : '';
    $("hintLine").textContent = `${z.impact} 明天消耗：食物 ${dc.foodCost} / 水 ${dc.waterCost} ${warn}`;

    const waterCost = 1; // 调整：基础每日水消耗降低，方便体验剧情
    const foodCost = 2;
    const warnFood = state.food < foodCost;
    const warnWater = state.water < waterCost;
    const consumeMsg = `每日消耗：食物 ${foodCost} / 水 ${waterCost}` + (warnFood || warnWater ? `  ⚠ 明天可能缺${warnFood?"食物":""}${warnFood&&warnWater?"和":""}${warnWater?"水":""}` : "");
    const consumeEl = $("consumeLine");
    if (consumeEl) consumeEl.textContent = consumeMsg;

    const stats = [
      {k:"生命", v:`${state.hp}/${state.maxHp}`, key:"hp"},
      {k:"士气", v:`${state.morale}/${state.maxMorale}`, key:"morale"},
      {k:`食物（-${dailyCosts().foodCost}/天）`, v:state.food, key:"food"},
      {k:`水（-${dailyCosts().waterCost}/天）`, v:state.water, key:"water"},
      {k:"弹药", v:state.ammo, key:"ammo"},
      {k:"医疗", v:state.med, key:"med"},
      {k:"废料", v:state.scrap, key:"scrap"},
      {k:"威胁", v:state.threat, key:"threat"},
    ];

    const grid = $("statsGrid");
    grid.innerHTML = "";
    const last = state.lastDelta || {};
    for (const s of stats){
      const el = document.createElement("div");
      el.className = 'stat' + (s.key==='food' ? (state.food===0?' bad':(state.food<=2?' warn':'')) : (s.key==='water' ? (state.water===0?' bad':(state.water<=2?' warn':'')) : ''));
      const d = last[s.key];
      const deltaBadge = (typeof d === "number" && d !== 0)
        ? `<span class="delta ${d>0?"good":"bad"}">${d>0?"+":""}${d}</span>`
        : `<span class="delta">${" "}</span>`;
      el.innerHTML = `
        <div class="k">${s.k}</div>
        <div class="v"><span>${s.v}</span>${deltaBadge}</div>
      `;
      // low resource highlighting
      if (s.key === "food" || s.key === "water"){
        const val = Number(state[s.key]);
        if (val === 0) el.classList.add("zero");
        else if (val <= 2) el.classList.add("low");
      }
      grid.appendChild(el);
    }

    const traits = $("traitsList");
    traits.innerHTML = "";
    if (!state.traits.length){
      const p = document.createElement("span");
      p.className = "pill muted";
      p.textContent = "（无）";
      traits.appendChild(p);
    } else {
      for (const t of state.traits){
        const def = TRAITS.find(x=>x.id===t.id);
        const p = document.createElement("span");
        p.className = "pill accent";
        p.title = def?.desc || "";
        p.textContent = def ? `${def.name}` : t.id;
        traits.appendChild(p);
      }
    }

    // buttons availability
    $("btnNext").disabled = !!state.pendingChoice;
    $("btnRest").disabled = !!state.pendingChoice;
    $("btnCraft").disabled = !!state.pendingChoice;
    $("btnUpgrade").disabled = !!state.pendingChoice;

    // auto game over check
    if (state.hp <= 0 || state.morale <= 0){
      $("btnNext").disabled = true;
      $("btnRest").disabled = true;
      $("btnCraft").disabled = true;
      $("btnUpgrade").disabled = true;
    }
  }


  function chooseDifficulty(){
    if (state.pendingChoice) return;
    logEventCard("选择难度", "你想用什么节奏体验这段故事？（难度会影响每日消耗、掉落与惩罚）", [
      {
        text:"简单：偏剧情体验（更容易补给）",
        kind:"good",
        resolve:()=>{ state.settings.difficulty='easy'; state.food += 1; state.water += 1; logEntry("已选择难度：简单。", "系统"); render(); }
      },
      {
        text:"普通：生存与剧情平衡",
        kind:"primary",
        resolve:()=>{ state.settings.difficulty='normal'; logEntry("已选择难度：普通。", "系统"); render(); }
      },
      {
        text:"困难：资源紧张，后果更重",
        kind:"danger",
        resolve:()=>{ state.settings.difficulty='hard'; state.food -= 1; state.water -= 1; logEntry("已选择难度：困难。", "系统"); render(); }
      },
    ]);
  }
  // -----------------------------
  // Game flow
  // -----------------------------
  function startNewRun(seedText){
    state = DEFAULTS();
    if (seedText) state.seedText = seedText;
    rng = mulberry32(hashSeed(state.seedText));

    // roll traits (2 random)
    const pool = shuffle([...TRAITS]).slice(0,2);
    state.traits = pool.map(t=>({id:t.id}));
    state.lastDelta = {};
    state.pendingChoice = null;

    $("log").innerHTML = "";
    logEntry("你从避难所醒来。外面风里夹着灰，远处的城市像一具巨大的尸体。", "开局");
    logEntry(`你的特性：${pool.map(x=>x.name).join("、")}。活下去。`, "开局");
    chooseDifficulty();
    render();
  }

  function gameOver(){
    state.pendingChoice = null;
    logEntry("你撑不下去了。世界没有为你停下。", "GAME OVER");
    render();
  }

  // -----------------------------
  // Save/Load
  // -----------------------------
  function exportSave(){
    const data = JSON.stringify(state);
    const blob = new Blob([data], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `save_${state.seedText}_day${state.day}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }
  function importSave(){
    const inp = document.createElement("input");
    inp.type="file";
    inp.accept="application/json";
    inp.onchange = async () => {
      const file = inp.files?.[0];
      if (!file) return;
      const text = await file.text();
      try{
        const obj = JSON.parse(text);
        // minimal validation
        if (!obj || typeof obj !== "object" || !("day" in obj)) throw new Error("bad save");
        state = obj;
        rng = mulberry32(hashSeed(state.seedText || randomSeedText()));
        state.pendingChoice = null;
        state.lastDelta = {};
        $("log").innerHTML = "";
        logEntry("已载入存档。你回到那一天。", "系统");
        render();
      }catch(e){
        alert("存档格式不对。");
      }
    };
    inp.click();
  }

  // -----------------------------
  // Wire UI
  // -----------------------------
  $("btnNext").onclick = nextDayEvent;
  $("btnRest").onclick = doRest;
  $("btnCraft").onclick = doCraft;
  $("btnUpgrade").onclick = doUpgrade;
  $("btnNewRun").onclick = () => startNewRun();
  $("btnSave").onclick = exportSave;
  $("btnLoad").onclick = importSave;

  window.addEventListener("keydown", (e)=>{
    if (e.target && ["INPUT","TEXTAREA"].includes(e.target.tagName)) return;
    if (e.key==="n" || e.key==="N") nextDayEvent();
    if (e.key==="r" || e.key==="R") doRest();
    if (e.key==="c" || e.key==="C") doCraft();
    if (e.key==="u" || e.key==="U") doUpgrade();
  });

  // Start
  startNewRun();

})();
</script>
</body>
</html>
